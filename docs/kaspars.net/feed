<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title></title>
	<atom:link href="https://kaspars.net/feed" rel="self" type="application/rss+xml" />
	<link>https://kaspars.net</link>
	<description>WordPress, Electronics &#38; Home Automation</description>
	<lastBuildDate>Sat, 14 Sep 2024 11:21:10 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=6.6.2</generator>

<image>
	<url>https://kaspars.net/wp-content/uploads/2022/01/cropped-kaspars-dambis-square-small-32x32.jpeg</url>
	<title>Kaspars Dambis</title>
	<link>https://kaspars.net</link>
	<width>32</width>
	<height>32</height>
</image> 
<atom:link rel="hub" href="https://pubsubhubbub.appspot.com"/><atom:link rel="hub" href="https://pubsubhubbub.superfeedr.com"/>	<item>
		<title>How to Rate Limit Requests to Specific PHP Files with Nginx</title>
		<link>https://kaspars.net/blog/nginx-rate-limit-php</link>
					<comments>https://kaspars.net/blog/nginx-rate-limit-php#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 14 Sep 2024 11:01:20 +0000</pubDate>
				<category><![CDATA[Linux]]></category>
		<category><![CDATA[WordPress]]></category>
		<category><![CDATA[How to]]></category>
		<category><![CDATA[PHP]]></category>
		<category><![CDATA[Snippet]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=9472</guid>

					<description><![CDATA[WordPress login and XML-RPC endpoints at wp-login.php and xmlrpc.php respectively are the mostly widely abused targets for bots scanning the web for sites with weak passwords. Here is a simple Nginx configuration snippet that allows you to set the limit_req depending on the request path and method. First, define the limit_req_zone at the http {} [&#8230;] <a href="https://kaspars.net/blog/nginx-rate-limit-php" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>WordPress login and XML-RPC endpoints at <code>wp-login.php</code> and <code>xmlrpc.php</code> respectively are the mostly widely abused targets for bots scanning the web for sites with weak passwords. Here is a simple Nginx configuration snippet that allows you to set the <code>limit_req</code> depending on the request path and method.</p>



<span id="more-9472"></span>



<p>First, define the <code><a href="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_zone">limit_req_zone</a></code> at the <code>http {}</code> level and conditionally enable it <strong>only for <code>POST</code> requests to the desired request URIs</strong> by setting the limit request zone input to <code><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#var_binary_remote_addr">$binary_remote_addr</a></code> while keeping it undefined for all the un-mapped requests:</p>



<pre class="wp-block-code"><code>map "$request_method:$uri" $wp_post_limit_key {
	POST:/wp-login.php $binary_remote_addr;
	POST:/xmlrpc.php $binary_remote_addr;
}

limit_req_zone $wp_post_limit_key zone=wp_post_limit_zone:10m rate=5r/m;</code></pre>



<p>where:</p>



<ul class="wp-block-list">
<li><code>$wp_post_limit_key</code> is our custom variable name that is either unset by default or equal to <code>$binary_remote_addr</code> when the current request should be rate-limited.</li>



<li><code>wp_post_limit_zone</code> is our custom zone name that must be referenced in <code>limit_req</code> of each <code>server {}</code> block.</li>



<li><code>rate=5r/m</code> sets the allowed request rate from the same IP to 5 requests per minute. You can change it to <code>2r/s</code> if you wanted to permit 2 request per second.</li>
</ul>



<p>And then add it to the PHP location in each of your <code>server {}</code>  blocks:</p>



<pre class="wp-block-code"><code>location ~ \.php$ {
	try_files $uri =404;
        limit_req zone=wp_post_limit_zone;
	// ...
}</code></pre>



<p>You can define multiple <code>limit_req_zone</code> configurations for different request mapping logic and apply them all to the same PHP location block. </p>



<h2 class="wp-block-heading">Adjust the HTTP Response Code</h2>



<p>By default Nginx responds with HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503">503 Service Unavailable</a> status code to all throttled requests. Use the <code>limit_req_status</code> directive to change it to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429">429 Too Many Requests</a> in either <code>http {}</code> or <code>server {}</code> block:</p>



<pre class="wp-block-code"><code>limit_req_status 429; </code></pre>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/nginx-rate-limit-php/feed</wfw:commentRss>
			<slash:comments>3</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2024/09/nginx-rate-limit-php-300x300.png" length="12566" type="image/png" />	</item>
		<item>
		<title>Use AppleScript to Resize All Windows for Screen Recording</title>
		<link>https://kaspars.net/blog/applescript-resize-all-windows</link>
					<comments>https://kaspars.net/blog/applescript-resize-all-windows#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Wed, 04 Sep 2024 09:47:40 +0000</pubDate>
				<category><![CDATA[Meta]]></category>
		<category><![CDATA[Video Blog]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=9360</guid>

					<description><![CDATA[I wasn&#8217;t able to find a tool to resize and center all open windows to a specific size for screen recording, so I came up with this AppleScript: set windowWidth to 1024set windowHeight to 768tell application "Finder" set {0, 0, screenWidth, screenHeight} to bounds of window of desktopend telltell application "System Events" set position of [&#8230;] <a href="https://kaspars.net/blog/applescript-resize-all-windows" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<figure class="wp-block-video alignwide"><video controls src="https://kaspars.net/wp-content/uploads/2024/09/with-chapters.mp4"></video></figure>



<p>I wasn&#8217;t able to find a tool to <strong>resize and center all open windows</strong> to a specific size for screen recording, so I came up with this AppleScript:</p>



<pre class="wp-block-preformatted">set windowWidth to 1024<br />set windowHeight to 768<br /><br />tell application "Finder"<br />	set {0, 0, screenWidth, screenHeight} to bounds of window of desktop<br />end tell<br /><br />tell application "System Events"<br />	set position of windows of (application processes whose visible is true) to {(screenWidth - windowWidth) / 2, (screenHeight - windowHeight) / 2}<br />	set size of windows of (application processes whose visible is true) to {windowWidth, windowHeight}<br />end tell</pre>



<p>which you can save as an &#8220;Application&#8221; via Automator (built-in macOS app):</p>



<figure class="wp-block-image size-full"><img fetchpriority="high" decoding="async" width="2048" height="1536" src="https://kaspars.net/wp-content/uploads/2024/09/create-as-application.png" alt="Automator create an application with AppleScript" class="wp-image-9373" srcset="https://kaspars.net/wp-content/uploads/2024/09/create-as-application.png 2048w, https://kaspars.net/wp-content/uploads/2024/09/create-as-application-1280x960.png 1280w, https://kaspars.net/wp-content/uploads/2024/09/create-as-application-1920x1440.png 1920w, https://kaspars.net/wp-content/uploads/2024/09/create-as-application-1536x1152.png 1536w" sizes="(max-width: 2048px) 100vw, 2048px" /><figcaption class="wp-element-caption">Select &#8220;Application&#8221; document type in Automator.</figcaption></figure>



<figure class="wp-block-image size-full"><img decoding="async" width="2048" height="1536" src="https://kaspars.net/wp-content/uploads/2024/09/run-applescript.png" alt="Run AppleScript to resize the application windows" class="wp-image-9372" srcset="https://kaspars.net/wp-content/uploads/2024/09/run-applescript.png 2048w, https://kaspars.net/wp-content/uploads/2024/09/run-applescript-1280x960.png 1280w, https://kaspars.net/wp-content/uploads/2024/09/run-applescript-1920x1440.png 1920w, https://kaspars.net/wp-content/uploads/2024/09/run-applescript-1536x1152.png 1536w" sizes="(max-width: 2048px) 100vw, 2048px" /><figcaption class="wp-element-caption">Add &#8220;Run AppleScript&#8221; action from the Utilities section and paste in the code from above.</figcaption></figure>



<p>Save it to your desktop or any other convenient location. Double-click the app to run it. </p>



<p>Approve the permissions requests for Finder and System Events. In addition, open the &#8220;Settings&#8221; app and enable the newly created app under the &#8220;Accessibility&#8221; section:</p>



<figure class="wp-block-image size-full"><img decoding="async" width="1430" height="1536" src="https://kaspars.net/wp-content/uploads/2024/09/settings-accessibility-enable.png?_t=1725450804" alt="Enable Automator app permissions under Settings &gt; Accessibility" class="wp-image-9375" srcset="https://kaspars.net/wp-content/uploads/2024/09/settings-accessibility-enable.png 1430w, https://kaspars.net/wp-content/uploads/2024/09/settings-accessibility-enable-1280x1375.png 1280w" sizes="(max-width: 1430px) 100vw, 1430px" /></figure>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/applescript-resize-all-windows/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2024/09/with-chapters.mp4" length="24127566" type="video/mp4" />

		<enclosure url="https://kaspars.net/wp-content/uploads/2024/09/run-applescript-300x300.png" length="24565" type="image/png" />	</item>
		<item>
		<title>Airbank D13 Puffer Pro Pump Teardown</title>
		<link>https://kaspars.net/blog/airbank-d13-pro-teardown</link>
					<comments>https://kaspars.net/blog/airbank-d13-pro-teardown#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 07 Jul 2024 11:53:18 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=9169</guid>

					<description><![CDATA[Available for around $130 on AliExpress (including shipping) or from the manufacturer store, Airbank D13 Puffer Pro is a battery powered two-stage pump that delivers up to 20 psi (1.4 bar) of pressure. Note that there is also a cheaper version without the battery that requires a 12V power supply. Contrary to the manufacturer specification [&#8230;] <a href="https://kaspars.net/blog/airbank-d13-pro-teardown" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>Available for around <a href="https://kaspars.net/go/buy-airbank-d13-puffer-pro" data-type="surl" data-id="9181">$130 on AliExpress</a> (including shipping) or from the <a href="https://kaspars.net/go/airbank-puffer-pro-manufacturer-store" data-type="surl" data-id="9238">manufacturer store</a>, Airbank D13 Puffer Pro is a battery powered two-stage pump that delivers up to 20 psi (1.4 bar) of pressure. Note that there is also a cheaper version without the battery that requires a 12V power supply.</p>



<p>Contrary to the manufacturer specification on the web, this pump actually <strong>does support USB-C PD3.0 and </strong><strong>QC3.0</strong> power output and charging up to 30W. The included paper manual correctly states the supported USB-C voltage and power levels.</p>



<figure class="wp-block-image alignwide size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-teardown-review-scaled.jpeg"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-teardown-review-scaled.jpeg" alt="" class="wp-image-9189" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-teardown-review-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-teardown-review-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-teardown-review-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-teardown-review-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-teardown-review-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a><figcaption class="wp-element-caption">Two compressor motors, battery pack and the control board.</figcaption></figure>



<span id="more-9169"></span>



<p>Opening the pump is really easy with just six phillips screws at the back. Inside, everything is neatly laid out and with wires of the appropriate gauge and latching connectors for the pump and battery connections, along with some adhesive to keep them secure during transportation.</p>



<figure class="wp-block-image alignwide size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-controller-top-scaled.jpeg"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-controller-top-scaled.jpeg" alt="Airbank D13 Pro controller board PCB with INJOINIC IP2366 power management chip and PY32F003 microcontoller" class="wp-image-9175" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-controller-top-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-controller-top-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-controller-top-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-controller-top-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-controller-top-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a><figcaption class="wp-element-caption">Control board with <a href="http://www.injoinic.com/product_detail/id/25.html?lang=en-us">INJOINIC IP2366</a> power management chip (below the USB-C port), <a href="https://py32.org/en/mcu/PY32F003xx.html">PY32F003</a> ARM Cortex M0 microcontoller (bottom right), and Maplesemi mosfets (SLM60P03T and SLM100N03T).</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pcb-controller-scaled.jpeg"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pcb-controller-scaled.jpeg" alt="Airbank D13Pro V1.3 2023 1120 PCB" class="wp-image-9178" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pcb-controller-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pcb-controller-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pcb-controller-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pcb-controller-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pcb-controller-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a><figcaption class="wp-element-caption">Other side of the PCB (marked <code>D13Pro__V1.3_2023_1120</code>) with the display and control buttons, and programming or debug pin connections.</figcaption></figure>



<h2 class="wp-block-heading">Pump and Compressor</h2>



<p>There are two motors inside &#8212; one for a simple fan and another one for driving a piston pump for the high-pressure stage (above 0.8 psi). Interestingly, the fan mode uses 8A at 11V compared to just 4A in the high-pressure mode as shown in this video (be aware of the loud audio):</p>



<figure class="wp-block-video"><video controls muted src="https://kaspars.net/wp-content/uploads/2024/07/airbank-puffer-pro-power-draw.mp4"></video><figcaption class="wp-element-caption">Current draw at 11V battery when running the compressor and the fan mode. </figcaption></figure>



<h2 class="wp-block-heading">Battery</h2>



<p>It features a pack of six 18650 Li-ion batteries in 3S2P configuration (3 in series, 2 in parallel) with the combined capacity of 57.72Wh (5200mAh at nominal voltage of 11.1V).</p>



<figure class="wp-block-image size-full is-resized"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-18650-li-ion-battery-5200mah-scaled.jpeg"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-18650-li-ion-battery-5200mah-scaled.jpeg" alt="18650 Li-ion batteries in 3S2P configuration with capacity of 57.72Wh (5200mAh at nominal voltage of 11.1V)" class="wp-image-9183" style="width:840px;height:auto" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-18650-li-ion-battery-5200mah-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-18650-li-ion-battery-5200mah-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-18650-li-ion-battery-5200mah-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-18650-li-ion-battery-5200mah-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-18650-li-ion-battery-5200mah-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a><figcaption class="wp-element-caption">Battery capacity 57.72Wh (5200mAh at 11.1V).</figcaption></figure>



<h2 class="wp-block-heading">USB-C Output</h2>



<p>Turns out it actually does support USB-C PD 3.0 charging and output up to 30W at 20V in addition to Quick Charge 3.0 (QC3) with up to 12V and 3A (36W) output thanks to the <a href="https://www.lcsc.com/product-detail/Power-Management-Specialized-PMIC_INJOINIC-IP2366-I2C-version_C20415848.html">INJOINIC IP2366 power management chip</a>.</p>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-scaled.jpeg"><img loading="lazy" decoding="async" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-scaled.jpeg" alt="USB-C PD3.0 output up to 20V and 1.5A" class="wp-image-9219" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-1280x1280.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-1920x1920.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-300x300.jpeg 300w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-2048x2048.jpeg 2048w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-output-120x120.jpeg 120w" sizes="(max-width: 2560px) 100vw, 2560px" /></a><figcaption class="wp-element-caption">AVHzY CT-3 showing the supported USB-C PD3.0 modes up to 30W (20V at 1.5A).</figcaption></figure>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-scaled.jpeg"><img loading="lazy" decoding="async" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-scaled.jpeg" alt="USB-C PD3.0 mode 20V at 1.5A activated" class="wp-image-9220" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-1280x1280.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-1920x1920.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-300x300.jpeg 300w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-2048x2048.jpeg 2048w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-usb-c-pd-30w-120x120.jpeg 120w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>



<h2 class="wp-block-heading">Charging</h2>



<p>Charging over USB-C supports PD3.0 30W input while the included charger GQ20PD02-ZG can only deliver QC3.0 20W at 12V/1.67A. It would take either 2 or 3 hours respectively to fully charge the battery.</p>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-charging-scaled.jpeg" alt="Charging Airbank D13 Puffer Pro via USB-C QC3 at 30W (20V)" class="wp-image-9173" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-charging-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-charging-1280x1280.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-charging-1920x1920.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-charging-300x300.jpeg 300w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-charging-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-charging-2048x2048.jpeg 2048w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-charging-120x120.jpeg 120w" sizes="(max-width: 2560px) 100vw, 2560px" /></figure>



<h3 class="wp-block-heading">Charging Error EE3</h3>



<p>Having played with the supported USB mode enumeration, I tested the pump performance with an actual 10&#8217;4&#8243; (317cm) SUP and was able to bring it to 18 psi twice, including the deflation.</p>



<p>When attempting to charge it with the supplied USB-C charger and cable, I was now suddenly getting a message EE3 on the screen and it wouldn&#8217;t charge when left over night. I was able to fix the issue by removing and re-attaching the battery which presumably reset the controller state. Since this is not an easy operation for an average user, I&#8217;ve reached out to the manufacturer to confirm alternative solutions for resetting the device.   </p>



<h2 class="wp-block-heading">Photos</h2>



<figure class="wp-block-gallery has-nested-images columns-2 wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-scaled.jpeg"><img loading="lazy" decoding="async" data-id="9188" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-scaled.jpeg" alt="Top of Airbank D13 Pro pump" class="wp-image-9188" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-1280x1280.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-1920x1920.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-300x300.jpeg 300w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-2048x2048.jpeg 2048w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-sup-pump-120x120.jpeg 120w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-scaled.jpeg"><img loading="lazy" decoding="async" data-id="9185" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-scaled.jpeg" alt="Handle of the Airbank D13 Pro pump" class="wp-image-9185" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-1280x1280.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-1920x1920.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-300x300.jpeg 300w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-2048x2048.jpeg 2048w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-120x120.jpeg 120w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-scaled.jpeg"><img loading="lazy" decoding="async" data-id="9186" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-scaled.jpeg" alt="Airbank D13 Pro USB-C and 12V power ports" class="wp-image-9186" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-1280x1280.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-1920x1920.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-300x300.jpeg 300w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-2048x2048.jpeg 2048w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-charge-pump-ports-120x120.jpeg 120w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-scaled.jpeg"><img loading="lazy" decoding="async" data-id="9184" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-scaled.jpeg" alt="Back of the Airbank D13 Pro pump" class="wp-image-9184" srcset="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-1280x1280.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-1920x1920.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-300x300.jpeg 300w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-2048x2048.jpeg 2048w, https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-back-label-120x120.jpeg 120w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>
</figure>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/airbank-d13-pro-teardown/feed</wfw:commentRss>
			<slash:comments>9</slash:comments>
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2024/07/airbank-puffer-pro-power-draw.mp4" length="7542765" type="video/mp4" />

		<enclosure url="https://kaspars.net/wp-content/uploads/2024/07/airbank-d13-pro-components-teardown-300x300.jpeg" length="20140" type="image/jpeg" />	</item>
		<item>
		<title>Notes on Bafang CAN Bus</title>
		<link>https://kaspars.net/blog/bafang-canbus</link>
					<comments>https://kaspars.net/blog/bafang-canbus#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 21 Apr 2024 20:54:56 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=9135</guid>

					<description><![CDATA[I got my wife this Accolmile Antelope 1S electric bicycle with Bafang components from their latest M-series lineup of mid-drive motors and displays which communicate over a CAN bus. It&#8217;s a great city bike and the price includes fast shipping from the warehouse in Poland. Their support was also quick to send a replacement wheel [&#8230;] <a href="https://kaspars.net/blog/bafang-canbus" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/04/bafang-m200-motor-connectors-scaled.jpg" alt="Bafang M200 (M-series) mid-drive motor with CAN bus" class="wp-image-9137" srcset="https://kaspars.net/wp-content/uploads/2024/04/bafang-m200-motor-connectors-scaled.jpg 2560w, https://kaspars.net/wp-content/uploads/2024/04/bafang-m200-motor-connectors-1280x960.jpg 1280w, https://kaspars.net/wp-content/uploads/2024/04/bafang-m200-motor-connectors-1920x1440.jpg 1920w, https://kaspars.net/wp-content/uploads/2024/04/bafang-m200-motor-connectors-1536x1152.jpg 1536w, https://kaspars.net/wp-content/uploads/2024/04/bafang-m200-motor-connectors-2048x1536.jpg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Bafang M200 mid-drive motor (model <code>MM G210.250.C</code>) with 36V battery connector (yellow, from left), empty 6-pin electric break connector (purple), 8-pin rear light and wheel speed connector, and 8-pin front light and display connector.</figcaption></figure>



<p>I got my wife this <a href="https://accolmile.com/products/aantelope-1s">Accolmile Antelope 1S</a> electric bicycle with Bafang components from their latest <a href="https://www.bafang-e.com/en/products/motors/m-series/">M-series lineup of mid-drive motors</a> and <a href="https://www.bafang-e.com/en/oem-area/components/hmi/">displays</a> which communicate over a CAN bus. It&#8217;s a great city bike and the price includes fast shipping from the warehouse in Poland. Their support was also quick to send a replacement wheel for the original that got dented during transport (despite the thoughtful packaging).</p>



<h2 class="wp-block-heading">CAN over NodeJS</h2>



<p>The M500/M600 motors are particularly popular with MTB riders so the communication protocol has been discussed in <a href="https://endless-sphere.com/sphere/threads/bafang-m500-m600-thread.100777/">this forum thread</a> and documented in <a href="https://github.com/OpenSourceEBike/Bafang_M500_M600">this GitHub repository</a>. Importantly, the <a href="https://bafang-e.com/en/oem-area/service/besst/"><abbr title="Bafang E-mobility Sales &amp; Service Tool">BESST</abbr> software</a> for managing the configuration and firmware updates is <a href="https://www.electronjs.org">an Electron app</a> with all logic as plain HTML and JS files (and bundled <a href="https://developer.chrome.com/blog/sourcemaps">source maps</a> for all minified code), including the CAN frame specification. I&#8217;ve started documenting my research in <a href="https://github.com/kasparsd/besst-reference">this GitHub repository</a>.</p>



<span id="more-9135"></span>



<h2 class="wp-block-heading">Connecting to CAN Bus</h2>



<p>The display connector at the wheel is the most convenient place to tap into the CAN bus. I purchased two HIGO 5-pin connectors B5-F and S5-F from <a href="https://shop.e-bike-technologies.de/de/">ETShop in Germany</a> for around €7 each and soldered the CAN high (green), CAN low (white) and ground (black) wires from each for a connection to (a copy of) the <a href="https://canable.io">CANable Pro 1.0 CAN-to-USB adapter</a>. <strong>Be sure to test the wiring with a multimeter because one of the wires carries the full battery voltage!</strong></p>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/04/bafang-higo-s5-male-connector-scaled.jpeg" alt="HIGO S5-F connector wires for Bafang CAN bus" class="wp-image-9141" srcset="https://kaspars.net/wp-content/uploads/2024/04/bafang-higo-s5-male-connector-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/04/bafang-higo-s5-male-connector-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/04/bafang-higo-s5-male-connector-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/04/bafang-higo-s5-male-connector-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/04/bafang-higo-s5-male-connector-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></figure>



<p>Technically <em>any CAN-to-USB adapter will work</em> (as long as it supports 250kbit transfer rate) and the choice depends more on the software you want to use for interacting with the bus. The CANable adapter runs the <a href="https://github.com/normaldotcom/canable-fw">slcan firmware</a> which implements the <a href="https://www.canusb.com/products/canusb/">Lawicel SLCAN protocol</a> (a basic ASCII serial) which is supported by various libraries, including SocketCAN.</p>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2024/04/bafang-can-bus-higo-s5-b5-canable-pro-scaled.jpeg" alt="Bafang HIGO S5 and B5 connectors attached to CANable Pro" class="wp-image-9142" srcset="https://kaspars.net/wp-content/uploads/2024/04/bafang-can-bus-higo-s5-b5-canable-pro-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/04/bafang-can-bus-higo-s5-b5-canable-pro-1280x1280.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/04/bafang-can-bus-higo-s5-b5-canable-pro-1920x1920.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/04/bafang-can-bus-higo-s5-b5-canable-pro-300x300.jpeg 300w, https://kaspars.net/wp-content/uploads/2024/04/bafang-can-bus-higo-s5-b5-canable-pro-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/04/bafang-can-bus-higo-s5-b5-canable-pro-2048x2048.jpeg 2048w, https://kaspars.net/wp-content/uploads/2024/04/bafang-can-bus-higo-s5-b5-canable-pro-120x120.jpeg 120w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">HIGO 5-pin B5-F and S5-F connectors attached to CANable Pro 1.0 CAN-to-USB adaptor.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/04/cangaroo-can-bus-bafang-m200-motor-dp-c245-scaled.jpeg" alt="CANbus traffic between Bafang M200 and DP C245 display." class="wp-image-9143" srcset="https://kaspars.net/wp-content/uploads/2024/04/cangaroo-can-bus-bafang-m200-motor-dp-c245-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/04/cangaroo-can-bus-bafang-m200-motor-dp-c245-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/04/cangaroo-can-bus-bafang-m200-motor-dp-c245-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/04/cangaroo-can-bus-bafang-m200-motor-dp-c245-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/04/cangaroo-can-bus-bafang-m200-motor-dp-c245-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Logging CANbus traffic between Bafang M200 (G210.250.C) motor and DP C245 display.</figcaption></figure>



<h2 class="wp-block-heading">Update Controller Configuration</h2>



<p>I was able to test the setup by increasing the assisted maximum speed to 60km/h from the original 25km/h by sending <a href="https://github.com/kasparsd/besst-reference/blob/47b3139c6dc672b90358e546abc30992b20d48c9/app/static/js/webpack/device/controller.js#L652-L663">a CAN message</a> composed of the following components:</p>



<ul class="wp-block-list">
<li><code>0x05</code> for the <a href="https://github.com/kasparsd/besst-reference/blob/47b3139c6dc672b90358e546abc30992b20d48c9/app/static/js/webpack/node_modules/besst-usb-sdk/src/usbClient/common.js#L41-L53">message source</a> (<code>0x01</code> &#8212; torque sensor, <code>0x02</code> &#8212; controller, <code>0x03</code> &#8212; display or HMI, <code>0x04</code> &#8212; battery, <code>0x05</code> &#8212; BESST),</li>



<li><code>0x02</code> for the message target (controller),</li>



<li><code>0x00</code> for a WRITE <a href="https://github.com/kasparsd/besst-reference/blob/47b3139c6dc672b90358e546abc30992b20d48c9/app/static/js/webpack/node_modules/besst-usb-sdk/src/usbClient/common.js#L55-L68">operation</a> (<code>0x01</code> for READ),</li>
</ul>



<p>which are transformed into a frame ID prefix for the <code>0x3203</code> code and subcode for &#8220;speed limit, wheel diameter and circumference&#8221; registry through <a href="https://github.com/kasparsd/besst-reference/blob/47b3139c6dc672b90358e546abc30992b20d48c9/app/static/js/webpack/node_modules/besst-usb-sdk/src/usbClient/common.js#L229-L237">this transformer function</a>:</p>



<pre class="wp-block-code"><code>buildHexStringCommand = (source, target, opt, anfn, nfn) =&gt; {
    const cmdPrefix = hexAllocToBinaryStr(source.toString(16), 5) + hexAllocToBinaryStr(target.toString(16), 5) + hexAllocToBinaryStr(opt.toString(16), 3);
    let cmdPrefixHex = parseInt(cmdPrefix, 2).toString(16);
    if (cmdPrefixHex.length % 2 !== 0) {
        cmdPrefixHex = '0' + cmdPrefixHex;
    }
    let cmdHexString = cmdPrefixHex + anfn + nfn;
    return hexReverse(cmdHexString);
};</code></pre>



<p>which returns:</p>



<pre class="wp-block-code"><code>05 10 32 03</code></pre>



<p>as the frame ID along with the payload:</p>



<pre class="wp-block-code"><code>70 17 C0 2B B6 08 </code></pre>



<p>where (with little-endian byte order):</p>



<ul class="wp-block-list">
<li><code>0x1770</code> is 6000 or 60km/h × 100,</li>



<li><code>0x2BC0</code> is 700 or 700c wheel diameter (29-inch), and</li>



<li><code>0x08B6</code> is 2230 or 2230mm wheel circumference.</li>
</ul>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/bafang-canbus/feed</wfw:commentRss>
			<slash:comments>1</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2024/04/bafang-m200-motor-connectors-300x300.jpg" length="23513" type="image/jpeg" />	</item>
		<item>
		<title>USB-C PD65W Adapter and Charger for 18V and 20V Power Tool Batteries</title>
		<link>https://kaspars.net/blog/usb-c-pd65w-adapter-charger-18v-20v-batteries</link>
					<comments>https://kaspars.net/blog/usb-c-pd65w-adapter-charger-18v-20v-batteries#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Mon, 15 Apr 2024 10:29:26 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=9111</guid>

					<description><![CDATA[Makita doesn&#8217;t make an official USB-C PD (power delivery) adaptor (they only have ADP05 with two 5V/2A ports) so I found this UDCB094 on AliExpress (affiliate link) with PD65W output and with variants for 18V Makita, DeWalt, Milwaukee and Bosch power tool batteries. It appears to very well built &#8212; using 16AWG wires for the [&#8230;] <a href="https://kaspars.net/blog/usb-c-pd65w-adapter-charger-18v-20v-batteries" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2000" height="1500" src="https://kaspars.net/wp-content/uploads/2024/04/udcb094-charger-makita.jpeg" alt="Adaptor supports PD 65W output via USB-C port. There is also a USB-A port." class="wp-image-9113" srcset="https://kaspars.net/wp-content/uploads/2024/04/udcb094-charger-makita.jpeg 2000w, https://kaspars.net/wp-content/uploads/2024/04/udcb094-charger-makita-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/04/udcb094-charger-makita-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/04/udcb094-charger-makita-1536x1152.jpeg 1536w" sizes="(max-width: 2000px) 100vw, 2000px" /><figcaption class="wp-element-caption">UDCB094 adaptor with true PD 65W output via USB-C. A second USB-A port is also available.</figcaption></figure>



<p>Makita doesn&#8217;t make an official USB-C PD (power delivery) adaptor (they only have <a href="https://www.makitatools.com/products/details/ADP05">ADP05 with two 5V/2A ports</a>) so I found this <a href="https://kaspars.net/go/udcb094-usb-c-pd60w-adapter-18v-20v-makita-dewalt-milwaukee-bosch-batteries" data-type="surl" data-id="9110">UDCB094 on AliExpress</a> (affiliate link) with PD65W output and with variants for 18V Makita, DeWalt, Milwaukee and Bosch power tool batteries. It appears to very well built &#8212; using 16AWG wires for the DC connection and implements true PD65W standard via the <a href="https://en.chipsea.com/product/details/?id=980&amp;pid=96">CSU3AF10 charge controller</a>.</p>



<span id="more-9111"></span>



<h2 class="wp-block-heading">Teardown and Internal Photos</h2>



<figure class="wp-block-gallery alignwide has-nested-images columns-3 wp-block-gallery-2 is-layout-flex wp-block-gallery-is-layout-flex">
<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-4-scaled.jpeg"><img loading="lazy" decoding="async" data-id="9117" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-4-scaled.jpeg" alt="16AWG wires for the DC connection of UDCB094 for 18V power tool batteries." class="wp-image-9117" srcset="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-4-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-4-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-4-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-4-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-4-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-2-scaled.jpeg"><img loading="lazy" decoding="async" data-id="9116" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-2-scaled.jpeg" alt="YR-PD65W PCB with CSU3AF10 charge controller for 18V power tool batteries" class="wp-image-9116" srcset="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-2-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-2-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-2-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-2-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-2-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-3-scaled.jpeg"><img loading="lazy" decoding="async" data-id="9115" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-3-scaled.jpeg" alt="" class="wp-image-9115" srcset="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-3-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-3-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-3-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-3-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-3-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-1-scaled.jpeg"><img loading="lazy" decoding="async" data-id="9114" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-1-scaled.jpeg" alt="" class="wp-image-9114" srcset="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-1-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-1-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-1-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-1-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-1-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a></figure>
</figure>



<p>The PCB is labeled &#8220;YR-PD65W&#8221;.</p>



<div class="wp-block-buttons is-layout-flex wp-block-buttons-is-layout-flex">
<div class="wp-block-button"><a class="wp-block-button__link wp-element-button" href="https://kaspars.net/go/udcb094-usb-c-pd60w-adapter-18v-20v-makita-dewalt-milwaukee-bosch-batteries">Get it now on AliExpress</a></div>
</div>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/usb-c-pd65w-adapter-charger-18v-20v-batteries/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2024/04/UDCB094-YR-PD65W-usb-c-charger-makita-dewalt-bosch-18v-20v-2-300x300.jpeg" length="25036" type="image/jpeg" />	</item>
		<item>
		<title>Building a Solar Powered Lora Meshtastic Community Network</title>
		<link>https://kaspars.net/blog/solar-lora-meshtastic</link>
					<comments>https://kaspars.net/blog/solar-lora-meshtastic#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 16 Dec 2023 07:00:08 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Meshtastic]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8648</guid>

					<description><![CDATA[Meshtastic is a wonderful project for creating decentralised text-based communication networks for local communities using low power (and low cost) Lora radios. Fun fact &#8212; the Meshtastic logo appears to reference the chirp modulation used by Lora. The best way to learn about the project is to explore the forum, join the Discord server and [&#8230;] <a href="https://kaspars.net/blog/solar-lora-meshtastic" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p><a href="https://meshtastic.org/">Meshtastic</a> is a wonderful project for creating decentralised text-based communication networks for local communities using <a href="https://meshtastic.org/docs/hardware/devices/">low power (and low cost) Lora radios</a>. Fun fact &#8212; the Meshtastic logo appears to reference the <a href="https://www.sghoslya.com/p/lora-is-chirp-spread-spectrum.html">chirp modulation</a> used by Lora.</p>



<span id="more-8648"></span>



<p>The best way to learn about the project is to <a href="https://meshtastic.discourse.group/">explore the forum</a>, join <a href="https://discord.gg/ktMAKGBnBs">the Discord server</a> and <a href="https://www.reddit.com/r/meshtastic">the Reddit community</a>, follow <code>#meshtastic</code> <a href="https://twitter.com/hashtag/Meshtastic">on Twitter</a>, <a href="https://www.instagram.com/explore/tags/meshtastic/">Instagram</a> and on <a href="https://mastodon.social/tags/meshtastic">your ActivityPub network of choice</a>, and <a href="https://www.youtube.com/results?search_query=meshtastic">find recent videos on YouTube</a>.</p>



<p>There are various community efforts to build local networks already:</p>



<ul class="wp-block-list">
<li><a href="https://wikimesh.pp.ua/uk/home">Meshtastic Ukraine</a> with <a href="https://mesh.in.ua/grafana/">around 400 active nodes</a> in the 433 MHz range.</li>



<li><a href="https://austinmesh.org">Austin Mesh</a> in Texas, USA with weekly Friday check-ins (also available globally through the MQTT gateway).</li>



<li><a href="https://iffybooks.net/event/meshtastic-101-sept-10/">Iffy Books events</a> and <a href="https://iffybooks.net/solar-lora-circuit-diagram/">resources</a> (including <a href="https://github.com/iffybooks/meshtastic-zine">this incredible zine about Meshtastic</a>).</li>
</ul>



<h2 class="wp-block-heading">Network Map</h2>



<p>Here is a <a href="https://map.technicallyrural.com">map of all active nodes</a> connected to networks that relay messages <a href="https://meshtastic.org/docs/configuration/module/mqtt">to the official MQTT endpoint</a>. This map is created by a forum user and shared in <a href="https://meshtastic.discourse.group/t/where-is-the-world-map/6882/6">this thread</a>.</p>



<h2 class="wp-block-heading">How to Build a Network</h2>



<p>Following the learnings from the <a href="https://kaspars.net/blog/solar-raspberry-pi-camera" data-type="post" data-id="7205">solar-powered Raspberry Pi security camera project</a>, I want to build solar-powered repeat nodes (with <a href="https://meshtastic.org/docs/configuration/radio/device"><code>REPEATER</code> role</a>) to place in high enough places to enable coverage for everyone in the area. Since repeat nodes are invisible to the network and can&#8217;t send health or sensor data, another node with <code>SENSOR</code> role would be connected to the same battery and would broadcast the health of the repeater node along with temperature and humidity at very long intervals for maximum power savings.</p>



<p>I’ve decided to use <a href="https://heltec.org/project/wifi-lora-32-v3/">Heltec WiFi Lora 32 (v3)</a> ($20, <a href="https://kaspars.net/wp-content/uploads/2023/12/HTIT-WB32LAF_V3.1_Schematic_Diagram.pdf">schematic diagram</a>) for the repeater nodes as they use ESP32-S3FN8 for the main controller and SX1262 LoRa chip with an IPEX1.0 antenna connector. This type of connector is really practical for bringing the antenna outside of the enclosure as the larger SMA connector cables are usually harder to bend and require more space in the case.</p>



<p>It also features a TP4054 charge controller and a voltage divider connected to an ADC pin for monitoring the battery voltage which is useful for telemetry. I’ve yet to figure out if it has any over discharge protection.</p>



<p>It is reported that <a href="https://store.rakwireless.com/products/wisblock-meshtastic-starter-kit">RAK4631 WisBlock Core</a> (similarly priced) with the nRF52840 microcontroller and the same SX1262 LoRa radio uses significantly less power compared to ESP32 devices so it is probably a better choice for pure repeater nodes. However, I wanted something that is more universal with a screen and a case for this prototyping phase.</p>



<h3 class="wp-block-heading">Power Requirements</h3>



<p>There is <a href="https://meshtastic.discourse.group/t/solar-charging-of-meshtastic-devices/870">a great thread on the forum</a> with several posts linking to the following resources that outline the effective power requirements:</p>



<ul class="wp-block-list">
<li><a href="https://docs.google.com/spreadsheets/d/1ft1bS3iXqFKU8SApU8ZLTq9r7QQEGESYnVgdtvdT67k/edit">Meshtastic ESP32 airtime and current draws (Google Sheets)</a></li>



<li><a href="https://docs.google.com/spreadsheets/d/1UMZRrFwL2QfyxEf_jnd2sIuZqrikItOxJ1EPNF5UBdU/edit">NRF52840DK+SX1262 Meshtastic airtime/current draws (Google Sheets)</a></li>



<li><a href="https://docs.google.com/spreadsheets/d/1wr6aqqmAICttwSqVga-WYILJpueYfDKX1ejSYZEfKY0/edit">Meshtastic Power Consumption Tests (Google Sheets)</a></li>



<li><a href="https://docs.google.com/document/d/12GIY24vLKLABg2RUTPP6yMzokr44GMzJOE4p7ngaCbI/edit">How To Calculate Solar Panel and Battery Size (Google Sheets)</a></li>
</ul>



<p>The general consensus appears to be that ESP32 powered devices without any bluetooth, screen or GPS attachments need 0.1W on average.</p>



<h3 class="wp-block-heading">Solar Power</h3>



<p>For the initial prototype I found <a href="https://kaspars.net/go/4w-solar-panel-18650-battery" data-type="surl" data-id="8663">this 4W (D4W) solar panel</a> (affiliate link) with an integrated case for six 18650 battery cells. Using only three cells provides plenty of room for additional electronics like the LoRa board.</p>



<p>In general it is best to oversize the photovoltaic panels significantly to ensure that required charging voltage is reached even when there is low solar radiation (such as during winter). </p>



<figure class="wp-block-image alignwide size-large"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-1920x1440.jpeg?_t=1705742961" alt="4W solar panel with 18650 batteries for Meshtastic Lora nodes" class="wp-image-8710" srcset="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">In winter the charging power didn&#8217;t exceed 1W, though.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-battery-scaled.jpeg" alt="Charging circuit of 4W solar panel with six 18650 batteries and CL4056 for charge control and FP6276B boost controller for 5V output" class="wp-image-8708" srcset="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-battery-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-battery-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-battery-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-battery-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-battery-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">4W solar panel with space for six 18650 batteries and a charging circuit.</figcaption></figure>



<p>And here is a close-up of the circuitry:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-circuit-scaled.jpeg" alt="Charging circuit of 4W solar panel with 18650 batteries using CL4056 for charge control, FP6276B boost controller for 5V output and XB5352A for battery protection" class="wp-image-8709" srcset="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-circuit-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-circuit-1280x960.jpeg 1280w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-circuit-1920x1440.jpeg 1920w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-circuit-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-4w-solar-panel-circuit-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Charging circuit of 4W solar panel with 18650 batteries using CL4056 (<code>U3</code>) for charge control, FP6276B (<code>U4</code>) boost controller for 5V output and XB5352A (<code>U5</code>) batter protection chip <em>only</em> for the solar input.</figcaption></figure>



<h3 class="wp-block-heading">Battery Undervoltage Protection</h3>



<p>The board appears to use XySemi XB5352A (<a href="https://kaspars.net/wp-content/uploads/2024/01/xb5352a-battery-protection.pdf">datasheet PDF</a>) battery management chip <code>U5</code> (the SOT-23-5 component to the right of the &#8220;on&#8221; switch) which handles over-voltage (4.30V for VCU with 4.10V recovery VCL), over-discharge (2.40V VDL with 3.0V recovery VDL), over-current (3.2A IOV1), and over-temperature protection. However, this chip is placed <strong>on the solar input</strong> so there is no under-voltage or over-discharge protection <em>on the battery side</em>. </p>



<h2 class="wp-block-heading">Configuring the Solar Powered Repeater </h2>



<p>And here is the case fitted with Heltec Lora 32 v3 with INA219 connected to pins 41 and 42 (confirmed this <a href="https://github.com/Heltec-Aaron-Lee/WiFi_Kit_series/blob/b9a9180f8ec5ff69b69bdaa31684583c4a5a5813/variants/wifi_lora_32_v3/pins_arduino.h#L34-L35">with the Arduino Core library</a> and the <a href="https://github.com/meshtastic/firmware/blob/486bf796906d6237e4d29f0bd7d90144979e2f9e/variants/heltec_v3/variant.h#L7-L9">usage in the Meshtastic firmware</a>) for measuring the battery voltage and current over time and reported over <a href="https://github.com/meshtastic/firmware/blob/486bf796906d6237e4d29f0bd7d90144979e2f9e/src/modules/Telemetry/PowerTelemetry.cpp">Power Telemetry</a>. Note that simply attaching the device to the board will make the firmware <a href="https://github.com/meshtastic/firmware/blob/486bf796906d6237e4d29f0bd7d90144979e2f9e/src/Power.cpp#L287-L318">use the INA219 bus voltage reading also for Device Telemetry</a> (which is not documented).</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1589" src="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-ina219-wemos-heltec-esp32-lora-scaled.jpeg" alt="Heltec Lora 32 v3 with an INA219 power sensor inside a 4W solar panel case" class="wp-image-8703" srcset="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-ina219-wemos-heltec-esp32-lora-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-ina219-wemos-heltec-esp32-lora-1280x795.jpeg 1280w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-ina219-wemos-heltec-esp32-lora-1920x1192.jpeg 1920w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-ina219-wemos-heltec-esp32-lora-1536x954.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/12/meshtastic-ina219-wemos-heltec-esp32-lora-2048x1271.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></figure>



<h2 class="wp-block-heading">Next Steps</h2>



<ul class="wp-block-list">
<li>Document the measured power consumption of Heltec Lora 32 v3 when used as Meshtastic <code>REPEATER</code>.</li>



<li>Document the device configuration for optimal performance.</li>



<li>Document the INA219 usage and setup.</li>
</ul>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/solar-lora-meshtastic/feed</wfw:commentRss>
			<slash:comments>8</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2023/12/meshtastic-ina219-wemos-heltec-esp32-lora-300x300.jpeg" length="28334" type="image/jpeg" />	</item>
		<item>
		<title>Notes on PowerWalker VI 500 R1U UPS</title>
		<link>https://kaspars.net/blog/powerwalker-vi-500-r1u</link>
					<comments>https://kaspars.net/blog/powerwalker-vi-500-r1u#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 30 Sep 2023 07:33:34 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8573</guid>

					<description><![CDATA[I&#8217;ve always wanted a rack mount UPS for all of our homelab gear, and PowerWalker VI 500 was pretty much the cheapest option at EUR 192 at the time. Here are my notes and observations after having used it for more than a year to power a QNAP TS-435XeU server. Power Consumption The unit draws [&#8230;] <a href="https://kaspars.net/blog/powerwalker-vi-500-r1u" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>I&#8217;ve always wanted a rack mount <abbr title="Uninterruptible Power Supply">UPS</abbr> for all of our homelab gear, and <a href="https://powerwalker.com/product/10121047/">PowerWalker VI 500</a> was pretty much the cheapest option at EUR 192 at the time. Here are my notes and observations after having used it for more than a year to power a <a href="https://www.qnap.com/en/product/ts-435xeu">QNAP TS-435XeU</a> server.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1440" src="https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-r1u-ups-scaled.jpeg" alt="PowerWalker VI 500 R1U UPS" class="wp-image-8576" srcset="https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-r1u-ups-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-r1u-ups-800x450.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-r1u-ups-1024x576.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-r1u-ups-1536x864.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-r1u-ups-2048x1152.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></figure>



<span id="more-8573"></span>



<ul class="wp-block-list">
<li>Has only USB type B connection for management.</li>



<li>Is recognized by macOS and QNAP operating systems as UPS when connected over USB.</li>



<li>Relies on <a href="https://www.powermonitor.software/">PowerMaster+ management software</a> for configuration.</li>



<li>Has four IEC C13 output sockets.</li>



<li>Uses two 6V/7Ah batteries which gives it a theoretical maximum capacity of 84Wh.</li>



<li>Has audible transformer hissing when not loaded but is completely fan-less.</li>
</ul>



<h2 class="wp-block-heading">Power Consumption</h2>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2356" height="1050" src="https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-power-consumption.png" alt="" class="wp-image-8579" srcset="https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-power-consumption.png 2356w, https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-power-consumption-800x357.png 800w, https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-power-consumption-1024x456.png 1024w, https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-power-consumption-1536x685.png 1536w, https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-power-consumption-2048x913.png 2048w" sizes="(max-width: 2356px) 100vw, 2356px" /><figcaption class="wp-element-caption">PowerWalker VI 500 R1U drawing 15W unloaded (during 6-8PM) and practically the same when powering a 30W server (during 10-11PM) when fully charged.</figcaption></figure>



<p>The unit draws an additional 15W when powering a 30W NAS (and connected to the mains) which explains why it gets pretty warm (still comfortable to touch). This is a pretty significant overhead for DC-based systems like routers and mini PC servers.</p>



<p>The specification mentions 95% efficiency under full load when connected to the mains and 78% efficiency when powered from the battery (also under full load) with a 0.60 power factor. The official full-load (300W) backup time is 0.8 minutes or 10.3 minutes for the half-load (150W).</p>



<p>After almost exactly a year of this kind of usage, the batteries were completely depleted and wouldn&#8217;t last even a few seconds during a blackout &#8212; dropping to 10V as soon as the mains power supply was removed.</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/powerwalker-vi-500-r1u/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2023/09/powerwalker-vi-500-r1u-ups-150x150.jpeg" length="8174" type="image/jpeg" />	</item>
		<item>
		<title>Notes on Beelink U59 Pro (Intel N5105) as a Home Server</title>
		<link>https://kaspars.net/blog/beelink-u59-pro-n5105</link>
					<comments>https://kaspars.net/blog/beelink-u59-pro-n5105#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 07 May 2023 07:55:19 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8490</guid>

					<description><![CDATA[For a home server hosting mostly Docker containers I&#8217;ve always wanted a computer with proper and multiple disk drives for data redundancy instead of SD cards used by most single-board computers. With the shortage of Raspberry Pi supply over the past years there has been an increased availability of mini PCs with all kinds of [&#8230;] <a href="https://kaspars.net/blog/beelink-u59-pro-n5105" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>For a home server hosting mostly Docker containers I&#8217;ve always wanted a computer with proper and multiple disk drives for data redundancy instead of SD cards used by most single-board computers. With the shortage of Raspberry Pi supply over the past years there has been an increased availability of mini PCs with all kinds of power-efficient Intel processors and extensive IO and storage options. Blogs such as <a href="https://www.cnx-software.com/">CNX Software</a>, <a href="https://linuxgizmos.com/">Linux Gizmos</a> and <a href="https://liliputing.com/">Liliputing</a> are amazing for research and deals which is how I discovered <a href="https://www.bee-link.com/">Beelink</a> and their mini PCs.</p>



<span id="more-8490"></span>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2500" height="1875" src="https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption.jpeg" alt="Beelink U59 Pro power consumption" class="wp-image-8502" srcset="https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption.jpeg 2500w, https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption-2048x1536.jpeg 2048w" sizes="(max-width: 2500px) 100vw, 2500px" /><figcaption class="wp-element-caption">Beelink U59 Pro drawing 10W from Bluetti EB3A during idle with Ubuntu 22.04.2 and a few Docker containers. Note that the actual power consumption is around 5W while the other 5W are lost in conversion from DC to AC to DC.</figcaption></figure>



<p>In late 2022 I purchased <a href="https://www.bee-link.com/u59-pro-n5105">Beelink U59 Pro</a> with an <a href="https://www.intel.com/content/www/us/en/products/sku/212328/intel-celeron-processor-n5105-4m-cache-up-to-2-90-ghz/specifications.html">Intel N5105 processor</a>, 16GB RAM, 500GB M.2 drive and two network ports for around EUR 230 (including shipping). Here is <a href="https://www.cnx-software.com/2022/08/13/beelink-u59-pro-review-a-jasper-lake-mini-pc-with-improved-gpu-performance/">a great review of the device</a>.</p>



<h2 class="wp-block-heading">Hardware and Upgrades</h2>



<p>Overall, the build quality is great with nice and quiet cooling design and convenient placement for the extra SSD drive. It uses a 12V power supply so it can be easily attached to a battery-powered UPS.</p>



<p>For data redundancy I added <a href="https://www.westerndigital.com/en-ap/products/internal-drives/wd-blue-sa510-sata-2-5-ssd">a WD Blue SA510 2.5” SATA III drive</a> (1000GB) and used LVM to distribute the filesystem logical volume across the two physical volumes as RAID1.</p>



<p>Below are my notes on getting the device up and running.</p>



<h2 class="wp-block-heading">Power Supply and Consumption</h2>



<p>It is powered by a 12V 3A power supply with a 5.5&#215;2.5mm DC jack. Note the diameter of the inner pin which is larger than the typical 2.1mm and won&#8217;t fit most of the low-power 12V power supplies or the POE adapters/splitters. </p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2000" height="1296" src="https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption.jpg" alt="Beelink U59 power consumption before and after applying powertop optimizations" class="wp-image-8521" srcset="https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption.jpg 2000w, https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption-800x518.jpg 800w, https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption-1024x664.jpg 1024w, https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption-1536x995.jpg 1536w" sizes="(max-width: 2000px) 100vw, 2000px" /><figcaption class="wp-element-caption">Beelink U59 power consumption before and after applying powertop optimizations.</figcaption></figure>



<p>The power consumption ranges from 17W during the boot process to 5W when idling with ethernet connected and WiFi enabled but disconnected, using the default Ubuntu Server 22 LTS. It gets down to 3W after running <code>powertop --auto-tune</code> which applies the following optimizations:</p>



<figure class="wp-block-gallery alignwide has-nested-images columns-default is-cropped wp-block-gallery-3 is-layout-flex wp-block-gallery-is-layout-flex">
<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-report-after-auto-tune.jpeg"><img loading="lazy" decoding="async" data-id="8523" width="1415" height="1415" src="https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-report-after-auto-tune.jpeg" alt="Beelink U59 Pro powertop idle stats and C-states" class="wp-image-8523" srcset="https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-report-after-auto-tune.jpeg 1415w, https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-report-after-auto-tune-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-report-after-auto-tune-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-report-after-auto-tune-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-report-after-auto-tune-120x120.jpeg 120w" sizes="(max-width: 1415px) 100vw, 1415px" /></a><figcaption class="wp-element-caption">Beelink U59 Pro powertop idle stats and C-states.</figcaption></figure>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-optimizations-after-auto-tune.jpeg"><img loading="lazy" decoding="async" data-id="8522" width="1493" height="1493" src="https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-optimizations-after-auto-tune.jpeg" alt="Beelink U59 Pro powertop optimizations" class="wp-image-8522" srcset="https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-optimizations-after-auto-tune.jpeg 1493w, https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-optimizations-after-auto-tune-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-optimizations-after-auto-tune-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-optimizations-after-auto-tune-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2023/05/beelink-powertop-optimizations-after-auto-tune-120x120.jpeg 120w" sizes="(max-width: 1493px) 100vw, 1493px" /></a><figcaption class="wp-element-caption">Beelink U59 Pro powertop optimizations.</figcaption></figure>
</figure>



<h2 class="wp-block-heading">BIOS Version and Errors</h2>



<p>The device comes with Windows 11 installed and activated. However, I wanted to install the Ubuntu server and that would never get pass one of the installation stages due to some memory errors. The device came with BIOS version JTKT001 X64 (build 05/05/2022 15:03:35) and produced the following errors during the boot (shown here with Debian install for testing):</p>



<figure class="wp-block-embed alignwide is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><div class="wp-block-embed__wrapper">
<iframe loading="lazy" title="Beelink U59 Pro BIOS error (version 2.21.1278, build 05/05/2022 15:03:35)" width="650" height="366" src="https://www.youtube.com/embed/CYF94pJaoc4?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div></figure>



<p>I reached out to Beelink support and after providing the serial number for the hardware revision identification they sent a new version of the firmware <code>JTKT001_20230217_U59_sata.bin</code> along with the tooling to update it from a flash boot. This new version seems to have resolved the issue and I&#8217;ve been able to install Ubuntu Server 22.04.2 LTS without any problems.</p>



<p>It is unfortunate that this is not provided on their website and everyone needs to contact their support directly (apparently due to the potential of bricking the device with the wrong firmware).</p>



<h2 class="wp-block-heading">Enable Wake-Up after Power Loss</h2>



<p>This device can automatically restart after a power loss but that isn&#8217;t enabled by default. The option for &#8220;State After G3&#8221; is hidden under the &#8220;Chipset&#8221; tab and the &#8220;PCH-IO Configuration&#8221; section in the BIOS settings and needs to be set to &#8220;S0 State&#8221; (one of the <a href="https://uefi.org/htmlspecs/ACPI_Spec_6_4_html/16_Waking_and_Sleeping/sleeping-states.html">ACPI Sleep States</a>).</p>



<p>This is an important feature for a homelab server!</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1813" src="https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-scaled.jpeg" alt="Beelink U59 Pro BIOS settings for power failure restart" class="wp-image-8496" srcset="https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-800x566.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-1024x725.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-1536x1088.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-2048x1450.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1496" src="https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-enable-scaled.jpeg" alt="Set to S0 state in BIOS to boot Beelink U59 Pro after power loss" class="wp-image-8497" srcset="https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-enable-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-enable-800x467.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-enable-1024x598.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-enable-1536x898.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/05/beelink-bios-power-resume-g3-restart-enable-2048x1197.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Set to S0 state (Working) in BIOS to boot the Beelink U59 Pro after a power loss.</figcaption></figure>



<h2 class="wp-block-heading">Usage</h2>



<p>This server is running in parallel to a dedicated <a href="https://www.qnap.com/en/product/ts-435xeu">QNAP TS-435XeU NAS</a> and hosts critical Docker containers for home automation to reduce the impact of NAS firmware upgrades and restarts while still backing up volume data to the NAS.</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/beelink-u59-pro-n5105/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2023/05/beelink-u59-pro-power-consumption-150x150.jpeg" length="5586" type="image/jpeg" />	</item>
		<item>
		<title>Notes on NEO Tuya Zigbee HomeKit Hub</title>
		<link>https://kaspars.net/blog/neo-nas-zw05b0-tuya-zigbee-homekit-hub</link>
					<comments>https://kaspars.net/blog/neo-nas-zw05b0-tuya-zigbee-homekit-hub#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Mon, 17 Apr 2023 09:09:35 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8458</guid>

					<description><![CDATA[Until recently Zemismart ZMHK-01 was the only Zigbee hub with Apple HomeKit integration. Now there is also NEO NAS-ZW05B0 Zigbee hub (affiliate link) with a HomeKit integration produced by Shenzhen NEO Electronic for around $25 with pretty much the same components. Note that only the wired version (with RJ45 ethernet connections instead of wi-fi) appears [&#8230;] <a href="https://kaspars.net/blog/neo-nas-zw05b0-tuya-zigbee-homekit-hub" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>Until recently <a href="https://kaspars.net/blog/zemismart-zigbee-homekit-hub" data-type="post" data-id="8147">Zemismart ZMHK-01</a> was the only Zigbee hub with Apple HomeKit integration. Now there is also <a href="https://kaspars.net/go/neo-tuya-zigbee-homekit-hub" data-type="surl" data-id="8461">NEO NAS-ZW05B0 Zigbee hub</a> (affiliate link) with a HomeKit integration produced by <a href="https://www.szneo.com/en/products/index.php?id=77">Shenzhen NEO Electronic</a> for around $25 with pretty much the same components. Note that only the wired version (with RJ45 ethernet connections instead of wi-fi) appears to have the HomeKit support!</p>



<span id="more-8458"></span>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1707" src="https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-tuya-zigbee-homekit-hub-scaled.jpeg" alt="How to open NEO NAS-ZW05B0 Tuya Zigbee HomeKit hub" class="wp-image-8462" srcset="https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-tuya-zigbee-homekit-hub-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-tuya-zigbee-homekit-hub-800x533.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-tuya-zigbee-homekit-hub-1024x683.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-tuya-zigbee-homekit-hub-1536x1024.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-tuya-zigbee-homekit-hub-2048x1365.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Use a pry tool to push open the four corners around the hub.</figcaption></figure>



<p>It is based on the <a href="https://developer.tuya.com/en/docs/iot/tyzs4ipex-zigbee-module-datasheet?id=K9m7tuum62gwb">Tuya TYZS4-IPEX module</a> for the Zigbee connectivity and <a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8196e">Realtek RTL8196E</a> controller for the USB and ethernet functionality similar to the <a href="https://kaspars.net/blog/zemismart-zigbee-homekit-hub" data-type="post" data-id="8147">Zemismart ZMHK-01 hub I reviewed earlier</a> and the <a href="https://paulbanks.org/projects/lidl-zigbee/">Lidl Silvercrest Zigbee hub</a>.</p>



<figure class="wp-block-image alignwide size-full is-style-default"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-with-tuya-TYZS4-IPEX-radio-scaled.jpeg" alt="NEO NAS-ZW05B0 Zigbee HomeKit Hub with Tuya TYZS4-IPEX radio controller" class="wp-image-8464" srcset="https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-with-tuya-TYZS4-IPEX-radio-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-with-tuya-TYZS4-IPEX-radio-scaled-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-with-tuya-TYZS4-IPEX-radio-scaled-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-with-tuya-TYZS4-IPEX-radio-scaled-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-with-tuya-TYZS4-IPEX-radio-scaled-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">NEO NAS-ZW05B0 Zigbee HomeKit Hub with Tuya TYZS4-IPEX radio and GD25Q127CSIG flash.</figcaption></figure>



<p>Considering the shared components, it should be possible to <a href="https://paulbanks.org/projects/lidl-zigbee/#gaining-initial-access">get root access to the device</a> by connecting directly to that UART pins on the PCB (see below) but the bootloader on this device <code>RealTek(RTL8196E) at 2022.01.10-18:12+0800 v3.4T-pre2</code> doesn&#8217;t support the <code>ESC</code> key sequence for entering the boot options as <a href="https://github.com/banksy-git/lidl-gateway-freedom/issues/31">described by this open issue</a>.</p>



<p>The pins at the bottom-left of the PCB (J1) are:</p>



<ul class="wp-block-list">
<li>Pin 1 (square): 3.3V</li>



<li>Pin 2: GND</li>



<li>Pin 3: RTL8196E U0_TX (B0)</li>



<li>Pin 4: RTL8196E U0_RX (A7)</li>



<li>Pin 5: Tuya TYZS4-IPEX SWDIO</li>



<li>Pin 6: Tuya TYZS4-IPEX SWCLK</li>
</ul>



<p>Connecting just the <code>GND</code>, <code>TX</code> and <code>RX</code> pins I was able to read the boot logs:</p>



<pre class="wp-block-code"><code>Booting...

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@
@ chip__no chip__id mfr___id dev___id cap___id size_sft dev_size chipSize
@ 0000000h 0c84018h 00000c8h 0000040h 0000018h 0000000h 0000018h 1000000h
@ blk_size blk__cnt sec_size sec__cnt pageSize page_cnt chip_clk chipName
@ 0010000h 0000100h 0001000h 0001000h 0000100h 0000010h 000004eh GD25Q128
@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
DDR1:32MB
 
---RealTek(RTL8196E)at 2022.01.10-18:12+0800 v3.4T-pre2 &#91;16bit](400MHz)
P0phymode=01, embedded phy
check_image_header  return_addr:05010000 bank_offset:00000000
no sys signature at 00010000!
P0phymode=01, embedded phy
---Ethernet init Okay!
tuya:start receive production test frame ...
Jump to image start=0x80c00000...
decompressing kernel:
Uncompressing Linux... done, booting the kernel.
done decompressing kernel.
start address: 0x80003780
Linux version 3.10.90 (root@WorkPC) (gcc version 4.6.4 (Realtek RSDK-4.6.4 Build 2080) ) #1 Mon Jan 10 18:14:44 CST 2022
CPU revision is: 0000cd01
Determined physical RAM map:
 memory: 02000000 @ 00000000 (usable)
Zone ranges:
  Normal   &#91;mem 0x00000000-0x01ffffff]
Movable zone start for each node
Early memory node ranges
  node   0: &#91;mem 0x00000000-0x01ffffff]
icache: 16kB/16B, dcache: 8kB/16B, scache: 0kB/0B
Built 1 zonelists in Zone order, mobility grouping on.  Total pages: 8128
Kernel command line:  console=ttyS0,38400 root=/dev/mtdblock2 
PID hash table entries: 128 (order: -3, 512 bytes)
Dentry cache hash table entries: 4096 (order: 2, 16384 bytes)
Inode-cache hash table entries: 2048 (order: 1, 8192 bytes)
Memory: 27344k/32768k available (2763k kernel code, 5424k reserved, 562k data, 192k init, 0k highmem)
SLUB: HWalign=32, Order=0-3, MinObjects=0, CPUs=1, Nodes=1
NR_IRQS:128
console &#91;ttyS0] enabled
Calibrating delay loop... 398.13 BogoMIPS (lpj=1990656)
pid_max: default: 4096 minimum: 301
Mount-cache hash table entries: 512
reg e0=0
reg e1=0
reg e2=0
reg e3=0
reg e4=0
reg e5=0
reg e6=0
reg e7=0
reg f0=0
reg f1=0
reg f2=0
reg f3=0
reg f4=0
reg f5=0
reg f6=0
NET: Registered protocol family 16
bio: create slab &lt;bio-0> at 0
NET: Registered protocol family 2
TCP established hash table entries: 512 (order: 0, 4096 bytes)
TCP bind hash table entries: 512 (order: -1, 2048 bytes)
TCP: Hash tables configured (established 512 bind 512)
TCP: reno registered
UDP hash table entries: 256 (order: 0, 4096 bytes)
UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)
NET: Registered protocol family 1
squashfs: version 4.0 (2009/01/31) Phillip Lougher
jffs2: version 2.2. (NAND) © 2001-2006 Red Hat, Inc.
msgmni has been set to 53
Block layer SCSI generic (bsg) driver version 0.4 loaded (major 254)
io scheduler noop registered
io scheduler deadline registered
io scheduler cfq registered (default)
Serial: 8250/16550 driver, 2 ports, IRQ sharing disabled
serial8250: ttyS0 at MMIO 0x18002000 (irq = 9) is a 16550A
serial8250: ttyS1 at MMIO 0x18002100 (irq = 13) is a 16550A
Realtek GPIO Driver for Flash Reload Default
tuya_gpio_init ok, scan expire time:50
SPI INIT
 ------------------------- Force into Single IO Mode ------------------------ 
|No chipID  Sft chipSize blkSize secSize pageSize sdCk opCk      chipName    |
| 0 c84018h  0h 1000000h  10000h  10000h     100h   84    0          GD25Q128|
 ---------------------------------------------------------------------------- 
SPI flash(GD25Q128) was found at CS0, size 0x1000000
boot+cfg offset=0x0 size=0x20000 erasesize=0x10000
linux offset=0x20000 size=0x1e0000 erasesize=0x10000
rootfs offset=0x200000 size=0x200000 erasesize=0x10000
tuya-label offset=0x400000 size=0x20000 erasesize=0x10000
jffs2-fs offset=0x420000 size=0xbe0000 erasesize=0x10000
5 rtkxxpart partitions found on MTD device flash_bank_1
Creating 5 MTD partitions on "flash_bank_1":
0x000000000000-0x000000020000 : "boot+cfg"
0x000000020000-0x000000200000 : "linux"
0x000000200000-0x000000400000 : "rootfs"
0x000000400000-0x000000420000 : "tuya-label"
0x000000420000-0x000001000000 : "jffs2-fs"
PPP generic driver version 2.4.2
nf_conntrack version 0.5.0 (427 buckets, 1708 max)
ip_tables: (C) 2000-2006 Netfilter Core Team
TCP: cubic registered
NET: Registered protocol family 10
sit: IPv6 over IPv4 tunneling driver
NET: Registered protocol family 17
l2tp_core: L2TP core driver, V2.0
8021q: 802.1Q VLAN Support v1.8
Realtek FastPath:v1.03
Probing RTL819X NIC-kenel stack size order&#91;1]...
eth0 added. vid=9 Member port 0x10f...
eth1 added. vid=8 Member port 0x10...
&#91;peth0] added, mapping to &#91;eth1]...
VFS: Mounted root (squashfs filesystem) readonly on device 31:2.
Freeing unused kernel memory: 192K (80340000 - 80370000)
init started: BusyBox v1.13.4 (2022-01-10 18:11:37 CST)
Set power startcmd read
b8000038: 2794A104  0000000F    00000042  00000018    '��        B    
cmd write
Write memory 0xb8000038 dat 0x1794a104: 0x1794a104
Set power end
udhcpc (v1.13.4) started
Sending discover...
Please press Enter to activate this console. Tuya Gateway Application Normal Srart /tuya/tuya_start.sh UserAppRunDir:
set defult run_dir:/tuya
TY_ENV_APP_RUN_DIR=/tuya
get user cfg file error, load defult cfg file
load platform configure file:/tuya/def.cfg
start.conf is exist
udhcpc (v1.13.4) started
Normal mode.
current run dir:/tuya/tuya_user1
grep: /var/resolv.conf: No such file or directory
tuya_start_children.sh:UserAppRunDir:/tuya JsonFile Path:/tuya/def.cfg &#91;engineer_mode: ]
Sending discover...
killall: app_detect.sh: no process killed
killall: tyZ3Gw: no process killed
killall: log_detect.sh: no process killed
killall: process_monitor.sh: no process killed
killall: tyZ3Gw: no process killed
Sending discover...
cat: can't open '/tuya/eng_mode_upg': No such file or directory
cat: can't open '/tmp/eng_mode': No such file or directory
no eng file
Sending discover...
nameserver 114.114.114.114
nlRecvFromAppSock sg_netlinkKeyPid:239
nlRecvFromAppSock port link sg_netlinkPid:239
umw send to error.: Socket operation on non-socket
Jan  1 00:00:38 mDNSResponder: mDNSResponder (Engineering Build) (Jul 27 2021 20:15:30) starting
Jan  1 00:00:38 mDNSResponder: mDNS_AddDNSServer: Lock not held! mDNS_busy (0) mDNS_reentrancy (0)
Jan  1 00:00:38 mDNSResponder: mDNS_AddDNSServer: Lock not held! mDNS_busy (0) mDNS_reentrancy (0)
Jan  1 00:00:38 mDNSResponder: WARNING: mdnsd continuing as root because user "nobody" does not exist
Sending discover...</code></pre>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/neo-nas-zw05b0-tuya-zigbee-homekit-hub/feed</wfw:commentRss>
			<slash:comments>1</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2023/04/neo-NAS-ZW05B2-with-tuya-TYZS4-IPEX-radio-scaled-150x150.jpeg" length="8523" type="image/jpeg" />	</item>
		<item>
		<title>Notes on Nilan Compact P2 GEO3 Polar</title>
		<link>https://kaspars.net/blog/nilan-compact-p2-geo3-polar</link>
					<comments>https://kaspars.net/blog/nilan-compact-p2-geo3-polar#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 04 Mar 2023 08:37:03 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Passive House]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8405</guid>

					<description><![CDATA[It is a single unit for ventilation with heat recovery and a heat pump against the exhaust air for heating or cooling the incoming air and producing domestic hot water, and another heat pump against ground loop for additional heating or cooling. Components Here are the components for this particular unit (inspected manually or extracted [&#8230;] <a href="https://kaspars.net/blog/nilan-compact-p2-geo3-polar" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>It is <a href="https://www.en.nilan.dk/products/ventilation-with-heating/ventilation-hot-water-production-and-heating/compact-p2-geo3">a single unit</a> for ventilation with heat recovery and a heat pump against the exhaust air for heating or cooling the incoming air and producing domestic hot water, and another heat pump against ground loop for additional heating or cooling.</p>



<figure class="wp-block-image alignwide size-full"><a href="https://kaspars.net/wp-content/uploads/2023/03/nilan-compact-p2-ventilation-heat-recovery.jpeg"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2023/03/nilan-compact-p2-ventilation-heat-recovery-scaled.jpeg" alt="Nilan Compact P2 ventilation crossflow heat exchanger" class="wp-image-8407" srcset="https://kaspars.net/wp-content/uploads/2023/03/nilan-compact-p2-ventilation-heat-recovery-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2023/03/nilan-compact-p2-ventilation-heat-recovery-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2023/03/nilan-compact-p2-ventilation-heat-recovery-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2023/03/nilan-compact-p2-ventilation-heat-recovery-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2023/03/nilan-compact-p2-ventilation-heat-recovery-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /></a><figcaption class="wp-element-caption"><a href="https://www.en.nilan.dk/products/ventilation-with-heating/ventilation-hot-water-production-and-heating/compact-p2-geo3">Nilan Compact P2</a> ventilation crossflow heat exchanger with a heat pump against the outgoing air for heating and hot water production.</figcaption></figure>



<span id="more-8405"></span>



<h2 class="wp-block-heading">Components</h2>



<p>Here are the components for this particular unit (inspected manually or extracted from <a href="https://www.en.nilan.dk/downloads">the available documentation</a>). Note that different production runs might be using different components.</p>



<h3 class="wp-block-heading">Air Filters</h3>



<p><a href="https://www.nilan.dk/produkter/tilbehoer/filtre/standardfilter-greencycle-iso-coarse-75-g4">Nilan Greencycle filter</a> (G4, ISO Coarse &gt; 75%).</p>



<h3 class="wp-block-heading">Supply and Extract Air Motors</h3>



<p>D190mm Not confirmed, yet.</p>



<h3 class="wp-block-heading">Pre-Heating Element (Polar)</h3>



<p>RDT TW3 1500W 240V resistive heater coil in the back of the top-left incoming air chamber.</p>



<h3 class="wp-block-heading">Counter-flow Air Heat Exchanger</h3>



<figure class="wp-block-image size-full"><a href="https://kaspars.net/wp-content/uploads/2023/03/holtop-3d-cross-flow-heat-exchanger.jpg"><img loading="lazy" decoding="async" width="1516" height="1304" src="https://kaspars.net/wp-content/uploads/2023/03/holtop-3d-cross-flow-heat-exchanger.jpg" alt="Holtop 3D crossflow heat exchanger" class="wp-image-8429" srcset="https://kaspars.net/wp-content/uploads/2023/03/holtop-3d-cross-flow-heat-exchanger.jpg 1516w, https://kaspars.net/wp-content/uploads/2023/03/holtop-3d-cross-flow-heat-exchanger-800x688.jpg 800w, https://kaspars.net/wp-content/uploads/2023/03/holtop-3d-cross-flow-heat-exchanger-1024x881.jpg 1024w" sizes="(max-width: 1516px) 100vw, 1516px" /></a></figure>



<p>Polyethylene terephthalate (PET) counterflow heat exchanger. Potentially <a href="https://www.holtop.com/high-efficiency-3d-counter-flow-heat-exchanger.html">Holtop 3D</a> (<a href="https://kaspars.net/wp-content/uploads/2023/03/Holtop-3D-high-efficient-counterflow-heat-exchanger-202106.pdf">specification PDF</a>).</p>



<h3 class="wp-block-heading">Bypass Damper</h3>



<p><a href="https://www.belimo.com/pl/shop/en_GB/Actuators/Non-Fail-Safe-Actuators/CM230-F-L/p?code=CM230-F-L">Belimo CM230-F rotary actuator</a> (orange device in the middle of the photo) controls the bypass damper &#8212; the cover for the cross-flow heat exchanger (the aluminium plate covering the green cross-flow heat exchanger in the top-left) and the square opening (to the right of the actuator) in the middle of photo connecting the incoming and outgoing air chambers.</p>



<ul class="wp-block-list">
<li><a href="https://kaspars.net/wp-content/uploads/2023/03/belimo_CM230-F-L_datasheet_en-gb.pdf">Belimo CM230-F datasheet PDF</a></li>



<li><a href="https://kaspars.net/wp-content/uploads/2023/03/belimo_CM..-F_installation-instructions.pdf">Belimo CM230-F installation instructions PDF</a></li>
</ul>



<h3 class="wp-block-heading">Air-Source Heat Pump</h3>



<p><a href="https://store.danfoss.com/en/Climate-Solutions-for-cooling/Compressors/Compressors-for-refrigeration/Light-commercial-compressors/Light-commercial-compressors/Reciprocating-compressor%2C-SC15GHH/p/104G8571">Danfoss SC15GHH reciprocating compressor</a> pumps the heat from the exhaust air (bottom left) to either the hot water tank <em>or</em> the incoming air. It is a high back pressure (HBP) compressor with a high condenser temperature of 55C to ensure it can heat up the domestic water using the R134a refrigerant.</p>



<p>It&#8217;s heat output ranges from <strong>345W at -15C</strong> evaporator (is that the outgoing air <em>after</em> the counter-flow heat exchanger?) temperature (COP 1.26) to <strong>1731W at 15C</strong> evaporator temperature (COP 3.02) at EN12900/CECOMAF rating conditions:</p>



<figure class="wp-block-table"><table class="has-fixed-layout"><thead><tr><th>Evaporator Temperature, C</th><th>Capacity, W</th><th>Power Consumption, W</th><th>COP</th></tr></thead><tbody><tr><td>15</td><td>1731</td><td>573</td><td>3.02</td></tr><tr><td>10</td><td>1405</td><td>544</td><td>2.59</td></tr><tr><td>7.2</td><td>1248</td><td>523</td><td>2.39</td></tr><tr><td>5</td><td>1135</td><td>505</td><td>2.25</td></tr><tr><td>0</td><td>911</td><td>461</td><td>1.98</td></tr><tr><td>-5</td><td>726</td><td>417</td><td>1.74</td></tr><tr><td>-6.7</td><td>670</td><td>403</td><td>1.66</td></tr><tr><td>-10</td><td>570</td><td>377</td><td>1.51</td></tr><tr><td>-15</td><td>435</td><td>345</td><td>1.26</td></tr></tbody></table></figure>



<p>which looks like this on a chart:</p>



<figure class="wp-block-image alignwide size-full"><img decoding="async" src="https://kaspars.net/wp-content/uploads/2023/03/SC15GHH-capacity-power-consumption-cop.svg" alt="SC15GHH heat pump capacity, power consumption and COP" class="wp-image-8447"/><figcaption class="wp-element-caption">SC15GHH heat pump capacity, power consumption (left axis) and COP (right axis).</figcaption></figure>



<p>Prices online range from EUR 150 to 900.</p>



<ul class="wp-block-list">
<li><a href="https://kaspars.net/wp-content/uploads/2023/03/SC15GHH-specification.pdf">SC15GHH specification PDF</a></li>



<li><a href="https://kaspars.net/wp-content/uploads/2023/03/SC15GHH-connections.pdf">SC15GHH connections PDF</a></li>



<li><a href="https://kaspars.net/wp-content/uploads/2023/03/SC15GHH-service-guide.pdf">SC15GHH service guide PDF</a></li>
</ul>



<h3 class="wp-block-heading">CO2 Sensor (Optional)</h3>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="700" height="468" src="https://kaspars.net/wp-content/uploads/2023/03/sensecube-kcd_an300-co2-sensor.jpeg" alt="Korea Digital SenseCube KCD-AN300 CO2 sensor" class="wp-image-8418"/></figure></div>


<p><a href="http://www.koreadigital.com/sensecube_product1?l=en">Korea Digital SenseCube KCD-AN300</a> (RS-15-spec) (<a href="https://www.en.nilan.dk/products/accessories/co2-sensors/co2-sensor">sold by Nilan</a>) with dual-wavelength NDIR sensor with 4-20mA / 0-10V analog or RS485 / PWM output.</p>



<ul class="wp-block-list">
<li><a href="https://kaspars.net/wp-content/uploads/2023/03/KCD-AN-300_en.pdf">KCD-AN300 specification PDF</a></li>



<li><a href="https://www.mb-systemtechnik.de/en/CO2-measurement/co2-meter-6-8-14-15.html">Available for purchase in EU</a> for EUR 94.</li>
</ul>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/nilan-compact-p2-geo3-polar/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2023/03/nilan-compact-p2-ventilation-heat-recovery-150x150.jpeg" length="8125" type="image/jpeg" />	</item>
		<item>
		<title>How Much Insulation is Too Much?</title>
		<link>https://kaspars.net/blog/how-much-insulation-is-enough</link>
					<comments>https://kaspars.net/blog/how-much-insulation-is-enough#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 19 Feb 2023 10:54:13 +0000</pubDate>
				<category><![CDATA[Passive House]]></category>
		<category><![CDATA[Building Science]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8351</guid>

					<description><![CDATA[The diminishing returns of insulation thickness is a legend referenced by many builders and architects which is actually incorrect. It is often paired with financial payback calculations that don&#8217;t consider the full range of insulation benefits. The legend states that any amount of insulation added after R-10,20,30,40&#8230; (pick your number but be aware of the [&#8230;] <a href="https://kaspars.net/blog/how-much-insulation-is-enough" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>The diminishing returns of insulation thickness is a legend referenced by many builders and architects which is actually incorrect. It is often paired with financial payback calculations that don&#8217;t consider the full range of insulation benefits.</p>



<p>The legend states that any amount of insulation added after R-10,20,30,40&#8230; (pick your number but <a href="https://en.wikipedia.org/wiki/R-value_(insulation)#Usage,_units">be aware of the units</a>) is a waste of money or unnecessary, or simply doesn&#8217;t make sense. I&#8217;ll explain why that is not the case.</p>



<span id="more-8351"></span>



<p><em>Note: I originally wrote this <a href="https://www.northernbuilt.pro/the-diminishing-return-of-insulation/">as a comment to this blog post</a> and decide to share it here with additional details and context.</em></p>



<h2 class="wp-block-heading">Why R-values and U-values Get Confusing</h2>



<p>Materials transfer heat at a rate that is proportional to the thickness and the temperature difference between both sides of the material. It is expressed as W/(mK) and a typical (and conservative) value for a blown-in cellulose, wood fibre or mineral wool is 0.04W/(mK).</p>



<p>Dividing this number by the width of the material we derive the rate of heat transfer per area of the material which is the U-value or W/(m<sup>2</sup>K). The inverse of that is the resistance to the heat conductivity or the R-value or m<sup>2</sup>K/W. </p>



<p><strong>Important:</strong> we&#8217;re referring <a href="https://en.wikipedia.org/wiki/R-value_(insulation)#Usage,_units">R-value in SI units</a> (also known as RSI) which need to be multiplied by 5.68 to arrive at the values typically used in the U.S.</p>



<figure class="wp-block-image alignwide size-full"><img decoding="async" src="https://kaspars.net/wp-content/uploads/2023/02/heat-flow-vs-thickness.svg" alt="Heat flow vs. material thickness" class="wp-image-8357"/><figcaption class="wp-element-caption">U-value and R-value relative to the material thickness in meters (0.1m is around 4 inches).</figcaption></figure>



<p><strong>It appears as if each additional layer of insulation <em>does less</em> to reduce the rate of heat transfer (U-value) while the R-value increases linearly. This is the source of confusion.</strong></p>



<p>Turns out that the amount of insulation added relative to the total amount of insulation is actually the same as the change in the rate of heat transfer or the U-value:</p>



<figure class="wp-block-table"><table><thead><tr><th>Thickness, m</th><th>Thickness Change</th><th>U-value Change</th></tr></thead><tbody><tr><td>0.1</td><td></td><td></td></tr><tr><td>0.2</td><td>+50% (0.1/0.2)</td><td>-50% (0.2/0.4)</td></tr><tr><td>0.3</td><td>+33% (0.1/0.3)</td><td>-33% (0.066/0.20)</td></tr><tr><td>0.4</td><td>+25% (0.1/0.4)</td><td>-25% (0.033/0.133)</td></tr><tr><td>0.5</td><td>+20% (0.1/0.5)</td><td>-20% (0.02/0.10)</td></tr></tbody></table></figure>



<p>This is similar to how a 50% drop in stock market requires an 100% increase afterwards to get to the original value. The reference point is what matters and creates the perceived difference.</p>



<p>Doubling the width of insulation at every step also halves the U-value but normally the increments are constant so the rate of change appears to slow down.</p>



<h2 class="wp-block-heading">How Much Insulation is Enough?</h2>



<p>After adding enough insulation for basic things like thermal comfort and avoiding condensation risk, it boils down to the cost of energy and its sustainability over the lifetime of the building. </p>



<p>The passive house limit of 15kWh/m2 of energy per year or 10W/m2 of heating/cooling load are great guidelines based on the <a href="https://kaspars.net/blog/ventilation-air-heat-cool-passive-house" data-type="post" data-id="8170">maximum amount of heat that can be transported with the ventilation air</a>. It is also low enough to require paying attention to thermal bridges and air tightness. Importantly, that amount of energy is easily available from photovoltaics during the summer and can be cheaply extracted from the ground via heat pumps during the winter.</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/how-much-insulation-is-enough/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2023/02/heat-flow-vs-thickness-150x150.png" length="5238" type="image/png" />	</item>
		<item>
		<title>Insulation Efficiency of Electric Hot Water Heaters</title>
		<link>https://kaspars.net/blog/electric-hot-water-heater-insulation-efficiency</link>
					<comments>https://kaspars.net/blog/electric-hot-water-heater-insulation-efficiency#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 03 Dec 2022 20:11:07 +0000</pubDate>
				<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Home Assistant]]></category>
		<category><![CDATA[Tuya]]></category>
		<category><![CDATA[Zigbee]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8274</guid>

					<description><![CDATA[With electric hot water heaters it is possible to use smart sockets with energy meter capabilities to measure the electricity consumption when the water is not actually used and is heated only to maintain the set temperature. It can be assumed that all of the added heat is equal to the heat lost to the [&#8230;] <a href="https://kaspars.net/blog/electric-hot-water-heater-insulation-efficiency" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>With electric hot water heaters it is possible to use <a href="https://www.zigbee2mqtt.io/supported-devices/#e=energy">smart sockets with energy meter capabilities</a> to measure the electricity consumption when the water is not actually used and is heated only to maintain the set temperature.</p>



<span id="more-8274"></span>



<p>It can be assumed that all of the added heat is equal to the heat lost to the room. This value might vary based on the set temperature and the hysteresis limits used by the device but over a period of a few days it should be possible to determine a reliable average (taking into account the weekly anti-legionella functionality).</p>



<p>Using <a href="https://www.zigbee2mqtt.io/devices/TS011F_plug_1.html">TuYa TS011F socket</a> with Home Assistant I was able to determine that <strong>our <a href="http://www.gorenje.com/heating-systems/en/water-heaters/medium-volume-water-heaters/gb-or-sm">80 liter Gorenje GBU</a> hot water heater looses about 1.3 kWh per day to the room</strong>. At average total of 7kWh per day that makes it 18% of energy lost to the room.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2482" height="1272" src="https://kaspars.net/wp-content/uploads/2022/12/electric-hot-water-heater-energy-loss.png" alt="Gorenje electric hot water heater standby energy consumption" class="wp-image-8276" srcset="https://kaspars.net/wp-content/uploads/2022/12/electric-hot-water-heater-energy-loss.png 2482w, https://kaspars.net/wp-content/uploads/2022/12/electric-hot-water-heater-energy-loss-800x410.png 800w, https://kaspars.net/wp-content/uploads/2022/12/electric-hot-water-heater-energy-loss-1024x525.png 1024w, https://kaspars.net/wp-content/uploads/2022/12/electric-hot-water-heater-energy-loss-1536x787.png 1536w, https://kaspars.net/wp-content/uploads/2022/12/electric-hot-water-heater-energy-loss-2048x1050.png 2048w" sizes="(max-width: 2482px) 100vw, 2482px" /><figcaption class="wp-element-caption">Idle energy consumption of Gorenje 80 liter hot water heater over two days.</figcaption></figure>



<p>Some of the manufacturers actually supply this value in the specification sheet and it is usually around 1kWh per day depending on the volume.</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/electric-hot-water-heater-insulation-efficiency/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2022/12/electric-hot-water-heater-energy-loss-150x150.png" length="3611" type="image/png" />	</item>
		<item>
		<title>Notes on Tuya Air Quality Sensors</title>
		<link>https://kaspars.net/blog/tuya-smart-box-house-keeper-air-quality</link>
					<comments>https://kaspars.net/blog/tuya-smart-box-house-keeper-air-quality#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Fri, 29 Apr 2022 08:11:52 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Home Assistant]]></category>
		<category><![CDATA[Teardown]]></category>
		<category><![CDATA[Tuya]]></category>
		<category><![CDATA[Zigbee]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8204</guid>

					<description><![CDATA[These are two devices with identical PM2.5/PM10 sensors (boxes with the metal cover), temperature and humidity sensors (top center) which are connected to an STC 8G1K08 microcontroller which prepares the data for the Tuya controllers with either WiFi or Zigbee radio (bottom left). The 6in1 version has an additional VOC sensor (bottom right with the [&#8230;] <a href="https://kaspars.net/blog/tuya-smart-box-house-keeper-air-quality" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/04/tuya-air-housekeeper-pm-box-scaled.jpeg" alt="Tuya PM2.5, PM10, CO2, CH2O Air Quality sensors (Zigbee and WiFi))" class="wp-image-8205" srcset="https://kaspars.net/wp-content/uploads/2022/04/tuya-air-housekeeper-pm-box-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2022/04/tuya-air-housekeeper-pm-box-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/04/tuya-air-housekeeper-pm-box-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/04/tuya-air-housekeeper-pm-box-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/04/tuya-air-housekeeper-pm-box-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption>Tuya 4in1 PM Box (Smart Air box) with <a href="https://developer.tuya.com/en/docs/iot/cb3s?id=Kai94mec0s076">CB3S module</a> (Wi-Fi) on the left (blue case) and Tuya 6in1 Air House Keeper with <a href="https://developer.tuya.com/en/docs/iot/zt3l-module-datasheet?id=Ka438n1j8nuvu">ZT3L module</a> (Zigbee) on the right (white case).</figcaption></figure>



<p>These are two devices with identical PM2.5/PM10 sensors (boxes with the metal cover), temperature and humidity sensors (top center) which are connected to an <a href="http://www.stcmicro.com/stc/stc8g1k08.html">STC 8G1K08 microcontroller</a> which prepares the data for the Tuya controllers with either WiFi or Zigbee radio (bottom left). The 6in1 version has an additional VOC sensor (bottom right with the metal mesh) which provides VOC and <em>derived</em> or virtual formaldehyde and CO2 values.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/04/pa03v2-pm2.5-7420m-scaled.jpg" alt="Tuya PM2.5 dust sensor PA03v2.0" class="wp-image-8237" srcset="https://kaspars.net/wp-content/uploads/2022/04/pa03v2-pm2.5-7420m-scaled.jpg 2560w, https://kaspars.net/wp-content/uploads/2022/04/pa03v2-pm2.5-7420m-800x600.jpg 800w, https://kaspars.net/wp-content/uploads/2022/04/pa03v2-pm2.5-7420m-1024x768.jpg 1024w, https://kaspars.net/wp-content/uploads/2022/04/pa03v2-pm2.5-7420m-1536x1152.jpg 1536w, https://kaspars.net/wp-content/uploads/2022/04/pa03v2-pm2.5-7420m-2048x1536.jpg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption>PM2.5 sensor board under the metal cover.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/04/tuya-8G1K08-cb3s-scaled.jpg" alt="Tuya PM2.5 sensor connected to 8G1K08" class="wp-image-8236" srcset="https://kaspars.net/wp-content/uploads/2022/04/tuya-8G1K08-cb3s-scaled.jpg 2560w, https://kaspars.net/wp-content/uploads/2022/04/tuya-8G1K08-cb3s-800x600.jpg 800w, https://kaspars.net/wp-content/uploads/2022/04/tuya-8G1K08-cb3s-1024x768.jpg 1024w, https://kaspars.net/wp-content/uploads/2022/04/tuya-8G1K08-cb3s-1536x1152.jpg 1536w, https://kaspars.net/wp-content/uploads/2022/04/tuya-8G1K08-cb3s-2048x1536.jpg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption>Internals of the PM2.5 sensor.</figcaption></figure>



<p>The PM2.5 sensor is a primitive dust sensor with a pair of infrared (IR) source and receiver.</p>



<span id="more-8204"></span>



<p>They cost around $25 for the 4in1 version and $30 for the 6in1. I bought them <a href="https://kaspars.net/go/tuya-air-quality-sensor-box">here on AliExpress</a>.</p>



<h2 class="wp-block-heading">Home Assistant Compatability</h2>



<p>The Zigbee version is known as <a href="https://www.zigbee2mqtt.io/devices/TS0601_smart_air_house_keeper.html">TS0601 Smart Air House Keeper by Zigbee2MQTT</a> (<code>TZE200_dwcarsat</code>) and is supported by <a href="https://www.zigbee2mqtt.io/guide/configuration/homeassistant.html">their Home Assistant integration</a> as well as the <a href="https://github.com/zigpy/zha-device-handlers/issues/1313">ZHA integration</a> (except for <a href="https://github.com/zigpy/zha-device-handlers/issues/1406">this bug</a>). It is also supported by the <a href="https://kaspars.net/blog/zemismart-zigbee-homekit-hub" data-type="post" data-id="8147">Zemismart gateway</a> in the Smart Life app but it <em>does not</em> show up in the Apple Home app.</p>



<p>The WiFi version is supported only by the <a href="https://www.home-assistant.io/integrations/tuya/">Tuya cloud integration in Home Assistant</a> and the Smart Life app which detects the device via Bluetooth and then lets you configure the WiFi settings. </p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/tuya-smart-box-house-keeper-air-quality/feed</wfw:commentRss>
			<slash:comments>9</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2022/04/tuya-air-housekeeper-pm-box-150x150.jpeg" length="8647" type="image/jpeg" />	</item>
		<item>
		<title>Use Ventilation Exhaust Air for Space Heating and Hot Water</title>
		<link>https://kaspars.net/blog/ventilation-air-heat-cool-passive-house</link>
					<comments>https://kaspars.net/blog/ventilation-air-heat-cool-passive-house#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Wed, 27 Apr 2022 10:48:17 +0000</pubDate>
				<category><![CDATA[Passive House]]></category>
		<category><![CDATA[Building Science]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8170</guid>

					<description><![CDATA[The Passive House standard has two magic numbers related to the heating and cooling requirements for buildings &#8212; 15kWh is the maximum allowed heating and cooling demand per square meter per year and 10W maximum allowed instantaneous heating or cooling load per square meter. And the buildings need to match just one of these parameters. [&#8230;] <a href="https://kaspars.net/blog/ventilation-air-heat-cool-passive-house" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>The Passive House standard <a href="https://passiv.de/en/02_informations/02_passive-house-requirements/02_passive-house-requirements.htm">has two magic numbers</a> related to the heating and cooling requirements for buildings &#8212; <strong>15kWh</strong> is the maximum allowed <strong>heating and cooling demand</strong> per square meter per year and <strong>10W</strong> maximum allowed <strong>instantaneous heating or cooling load</strong> per square meter. And the buildings need to match just one of these parameters.</p>



<span id="more-8170"></span>



<h2 class="wp-block-heading">What is 10W per square meter?</h2>



<p>It signifies the incredibly low heating or cooling power that is needed to keep a passive house comfortable. It signifies how little heat is lost through the building envelope and that is happens really slowly. For example, a 100m<sup>2</sup> house requires just 1000W or 1kW during the coldest winter nights or the hottest summer days to keep the indoor temperature steady.</p>



<p>It is easy to see how boiling water for tea, cooking food and running other household appliances could generate enough heat that is eventually absorbed by the building to keep the additional heating need even lower. That&#8217;s why it&#8217;s called &#8220;passive&#8221; house because it requires so little addition energy to what is already generated by the people just living in it.</p>



<h2 class="wp-block-heading">Ventilation with Heating and Cooling</h2>



<p>Ventilation is the only active process in a passive house as it needs to happen in a way that doesn&#8217;t transport any heat out of the house. The magic numbers for this is 30m<sup>3</sup> of fresh air per person per hour at a 90% heat recovery efficiency. </p>



<p>What if we used this air to transport heat around the house &#8212; add heat during the winter and remove it during the summer? Would it be possible to transport those 10Wh of heat per square meter every hour?</p>



<h2 class="wp-block-heading">Energy in Air</h2>



<p>The heat capacity of air is around 1000 joules or 0.28Wh per kg per degree and its density is around 1.2kg per m<sup>3</sup> which means that <strong>1m<sup>3</sup> of air is able to transport 0.28Wh/kg × 1.2kg = 0.33Wh</strong> of energy per each degree of air temperature change. Compare that to the same volumetric amount of water which has 4 times the heat capacity, 830 times the density and is able to carry 1151Wh energy per degree difference.</p>



<p>A four person household needs 4 × 30m<sup>3</sup>= 120m<sup>3</sup> of fresh air per hour which can transport 120 × 0.33Wh = 40Wh of heat per hour per degree change. So in order <strong>to add or remove 1000Wh of heat by transporting 120m<sup>3</sup> of air every hour we need a 1000Wh </strong>÷<strong> 40Wh = 25C degree hotter or colder air</strong> compared to the room temperature. Doubling the amount of air to 240m<sup>3</sup> would decrease that to a 12.5C degree difference.</p>



<p>This proves that in theory it is possible the heat or cool the whole house just by using the air that is already used for ventilation. Not only that &#8212; we can use a heat pump to extract even more heat from the air leaving the home.</p>



<h2 class="wp-block-heading">Heating Air and Water</h2>



<p>The ideal way to do this is by placing <strong>a heat pump on the exhaust side of the ventilation after the cross-flow heat exchanger to extract even more energy from the outgoing air</strong> &#8212; like a traditional air-source heat pump but with the evaporator placed inside the exhaust line of the ventilation unit and the condenser in the supply line (in the heating mode). It would also recover all the energy left over by the cross-flow heat exchanger!</p>



<p>There are <a href="https://database.passivehouse.com/en/components/list/heat_pump">several products</a> (filter by &#8220;Compact heat pump unit&#8221;) on the market that do this:</p>



<ul class="wp-block-list">
<li><a href="https://www.en.nilan.dk/products/ventilation-with-heating/ventilation-and-hot-water-production/compact-p">Nilan Compact P</a> (in <a href="https://database.passivehouse.com/en/components/details/heat_pump/nilan-as-compact-p-arbeitspunkt-172-m3h-0391ch03">component database</a>)</li>



<li><a href="https://www.stiebel-eltron.com/en/home/products-solutions/renewables/ventilation/central/lwz-cs-premium/lwz-8-cs-premium.html">Stiebel Eltron LWZ 8 CS Premium</a> (in <a href="https://database.passivehouse.com/en/components/details/heat_pump/stiebel-eltron-gmbh-co-kg-lwz-8-cs-premium-0873ch03">component database</a>)</li>



<li><a href="https://shop.systemair.com/en/genius--complete--unit/p403832">Systemair Genius</a> (in <a href="https://database.passivehouse.com/en/components/details/heat_pump/systemair-gmbh-systemair-genius-1398ch02">component database</a>)</li>



<li><a href="https://www.genvex.com/en/products/air-ventilation---water-heat-pump/combi-185-bp">Genvex Combi 185 BP</a> (in <a href="https://database.passivehouse.com/en/components/details/heat_pump/genvex-as-combi-185l-arbeistpunkt-150-m3h-0388ch03">component database</a>)</li>
</ul>



<p>Some of them have additional routes for the incoming air so that it can be used only for heating water and doesn&#8217;t need to be moved through the house when the ventilation needs are low.</p>



<p>They all look pretty much like this:</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="1144" height="724" src="https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p.jpg" alt="Nilan Compact P" class="wp-image-8174" srcset="https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p.jpg 1144w, https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-800x506.jpg 800w, https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-1024x648.jpg 1024w" sizes="(max-width: 1144px) 100vw, 1144px" /><figcaption class="wp-element-caption">Nilan Compact P with ventilation and heat recovery at the top and hot water tank at the bottom.</figcaption></figure></div>


<p>and they all work like this:</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="600" height="904" src="https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-diagram.jpg" alt="Nilan Compact P working diagram" class="wp-image-8175"/><figcaption class="wp-element-caption">The outgoing air at 22C first heats up the incoming air through a cross-flow heat exchanger and then passes by an even colder heat pump evaporator which on the condenser side heats up the air going to the rooms to 38C.</figcaption></figure></div>


<p>As you can imaging, the same system can also be used in hot climates to both cool the incoming ventilation air and heat up the water just by reversing a few valves.</p>



<p>Some of these units have support for ground-source heat pump additions which can further increase and optimize the available heating and cooling loads at amazing efficiencies.</p>



<p>Interestingly, the <a href="https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-product-data.pdf">Nilan Compact P datasheet</a> has the follow graph:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1057" height="592" src="https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-heat-output.png" alt="Nilan Compact P heating power" class="wp-image-8181" srcset="https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-heat-output.png 1057w, https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-heat-output-800x448.png 800w, https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-heat-output-1024x574.png 1024w" sizes="(max-width: 1057px) 100vw, 1057px" /></figure>



<p>which confirms that a heat pump is able to extract 2200W of heat from 220m<sup>3</sup> of exhaust air every hour. The ventilation loss shown just below the heat output is confusing because my understanding is that the heat pump is placed <em>after</em> the cross-flow heat exchanger so it shouldn&#8217;t impact the heat recovery efficiency.</p>



<p>These units cost somewhere in the range of $12,000 to $25,000 and they reduce the utility room down to this one device which still needs to be hidden behind a well insulated walls due to noise, but the savings on piping and installation work should easily justify the cost.</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/ventilation-air-heat-cool-passive-house/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2022/04/nilan-compact-p-150x150.jpg" length="3828" type="image/jpeg" />	</item>
		<item>
		<title>Notes on Zemismart HomeKit Zigbee Hub</title>
		<link>https://kaspars.net/blog/zemismart-zigbee-homekit-hub</link>
					<comments>https://kaspars.net/blog/zemismart-zigbee-homekit-hub#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Mon, 25 Apr 2022 09:22:42 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[HomeKit]]></category>
		<category><![CDATA[Teardown]]></category>
		<category><![CDATA[Tuya]]></category>
		<category><![CDATA[Zigbee]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8147</guid>

					<description><![CDATA[Zemismart ZMHK-01 is one of the few hubs that is compatible with Apple HomeKit and can expose non-HomeKit Zigbee devices in the Home app similar to the Aqara G2H camera hub. Behind the scenes it uses the Tuya TYZS4 radio module and is very similar to the Tuya reference designs used by many generic Tuya-compatible [&#8230;] <a href="https://kaspars.net/blog/zemismart-zigbee-homekit-hub" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p><a href="https://www.zemismart.com/products/zmhk-01">Zemismart ZMHK-01</a> is one of the few hubs that is compatible with Apple HomeKit and can expose non-HomeKit Zigbee devices in the Home app similar to the <a href="https://kaspars.net/blog/aqara-g2h-homekit" data-type="post" data-id="8081">Aqara G2H camera hub</a>. Behind the scenes it uses the <a href="https://developer.tuya.com/en/docs/iot/zigbeetyzs4module?id=K989rhycrz23f">Tuya TYZS4 radio module</a> and is very similar to the Tuya reference designs used by many generic Tuya-compatible hubs.</p>



<span id="more-8147"></span>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-scaled.jpg" alt="Zemismart Zigbee HomeKit Hub using the Tuya TYZS4 module " class="wp-image-8149" srcset="https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-scaled.jpg 2560w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-800x600.jpg 800w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-1024x768.jpg 1024w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-1536x1152.jpg 1536w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-2048x1536.jpg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Zemismart Zigbee HomeKit Hub using the Tuya TYZS4 module for radio and RTL8196E as the main controller.</figcaption></figure>



<p>Note: this device is very similar to <a href="https://kaspars.net/blog/neo-nas-zw05b0-tuya-zigbee-homekit-hub" data-type="post" data-id="8458">NEO NAS-ZW05B0</a>!</p>



<h2 class="wp-block-heading">Getting Root Access</h2>



<p>Turns out it is very similar to the first generation of the Lidl Silvercrest Smart Gateway <a href="https://paulbanks.org/projects/lidl-zigbee/root/">which allows extracting the <code>root</code> user password over the UART connection</a> exposed on the back of the PCB. The screws are hidden behind the rubber ring on the bottom:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2000" height="1500" src="https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-teardown-screws.jpg" alt="Screws for opening Zemismart Zigbee HomeKit Hub" class="wp-image-8150" srcset="https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-teardown-screws.jpg 2000w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-teardown-screws-800x600.jpg 800w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-teardown-screws-1024x768.jpg 1024w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-teardown-screws-1536x1152.jpg 1536w" sizes="(max-width: 2000px) 100vw, 2000px" /><figcaption class="wp-element-caption">Screws for opening Zemismart Zigbee HomeKit Hub.</figcaption></figure>



<p>And the UART pins <code>TX</code> and <code>RX</code> are clearly marked on the back of the PCB. Note that you must use 3.3V for power and logic when connecting to the device.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-back-scaled.jpg" alt="UART serial pins for Zemismart Zigbee HomeKit Hub" class="wp-image-8148" srcset="https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-back-scaled.jpg 2560w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-back-800x600.jpg 800w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-back-1024x768.jpg 1024w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-back-1536x1152.jpg 1536w, https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-back-2048x1536.jpg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">UART serial pins for Zemismart Zigbee HomeKit Hub.</figcaption></figure>



<p>After extracting the password from the flash memory you&#8217;re able to connect to it over SSH running on port 2333:</p>



<pre class="wp-block-code"><code>$ ssh root@gateway.local -p 2333</code></pre>



<p>where <code>gateway.local</code> is the mDNS address of the device on your network. Alternatively, use the IP address of the device to connect.</p>



<p>The device runs Linux with <a href="https://busybox.net/">BusyBox</a> v1.13.4 (2021-08-26 11:01:27 CST) and it uses <a href="https://gist.github.com/kasparsd/1cb3919a238bc94b93ccc72324cab517">a bunch of bash scripts to configure and launch the software</a>. Most of the runtime logic is handled by the following process:</p>



<pre class="wp-block-code"><code>./tyZ3Gw /tuya/tuya_user2 /tuya/def.cfg</code></pre>



<p>where <code>tyZ3Gw</code> (sounds like short for &#8220;Tuya Zigbee3 Gateway&#8221;) is the binary in the <code>/tuya/tuya_user2</code> working directory using <code>/tuya/def.cfg</code> for config:</p>



<pre class="wp-block-code"><code>{
	"user_cfg_file":"/tuya/config/user.cfg",
	"platform":"RTL8196E",
	"product_key":"keyYOURUNIQUEKEY",
	"mode_id":"RTL8196E_TY01",
	"storage_dir":"./",
	"log_dir":"/tuya/log_dir/",
	"tmp_dir":"/tmp/",
	"bin_dir":"/tuya/",
	"backup_dir":"/tuya/",
	"net_led":"LED0",
	"status_led":"LED1",
	"reset_key":"KEY0",
	"wan_interface":"eth1",
	"wifi_interface":"wifi0",
	"serial_port":"/dev/ttyS1",
	"is_cts":true,
	"is_sync_systime":true,
	"is_hardward":true
}</code></pre>



<p>Note that there is no WiFi network interface on this device although it is mentioned in the config.</p>



<h2 class="wp-block-heading">Zigbee Communication</h2>



<p>The <code>zigbee_agent</code> binary talks to the <a href="https://www.nxp.com/products/wireless/thread/jn5189-88-t-high-performance-and-ultra-low-power-mcus-for-zigbee-and-thread-with-built-in-nfc-option:JN5189_88_T">NXP JN5189 Zigbee module</a> over UART at <code>/dev/ttyS2</code>. There is <a href="https://github.com/banksy-git/lidl-gateway-freedom/tree/master/gateway">a custom UART to TCP bridge software</a> <a href="https://paulbanks.org/projects/lidl-zigbee/ha/">developed by Paul Banks</a> that can be used to expose the Zigbee radio to the <a href="https://www.home-assistant.io/integrations/zha/">Home Assistant ZHA integration</a> over TCP. Note that this disables the Tuya and HomeKit integrations since they are no longer able to talk to the same UART device that is now used by the bridge.</p>



<h2 class="wp-block-heading">Compatible Devices</h2>



<p>I&#8217;ve successfully tested the following devices with the hub and they become available in the Home app:</p>



<ul class="wp-block-list">
<li><a href="https://www.aliexpress.com/item/1005003417122659.html">Tuya ZigBee 3.0 Switch Modules (both 1 and 2 channel)</a> with Tuya 2T3L radio.</li>



<li><a href="https://www.aliexpress.com/item/1005002164359835.html">GIRIER Tuya ZigBee 3.0 Smart Light Switch Module</a> with Tuya ZTU radio.</li>



<li><a href="https://sonoff.tech/product/smart-home-security/snzb-03/">Sonoff SNZB-03</a> PIR motion sensor.</li>
</ul>



<p>The following devices are recognized by the Smart Life app but they <em>don&#8217;t show</em> up in the Home app:</p>



<ul class="wp-block-list">
<li> <a href="https://kaspars.net/blog/tuya-smart-box-house-keeper-air-quality" data-type="post" data-id="8204">Tuya TS0601 Smart Air Box House Keeper 6in1 air quality monitor</a> with ZT3L module.</li>
</ul>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/zemismart-zigbee-homekit-hub/feed</wfw:commentRss>
			<slash:comments>11</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2022/04/zemismart-zigbee-homekit-hub-tuya-150x150.jpg" length="7143" type="image/jpeg" />	</item>
		<item>
		<title>Use Hiking DDS238-2 ZN/S Energy Meter with Home Assistant</title>
		<link>https://kaspars.net/blog/hiking-dds238-2-modbus</link>
					<comments>https://kaspars.net/blog/hiking-dds238-2-modbus#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Mon, 18 Apr 2022 14:06:52 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Home Assistant]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8124</guid>

					<description><![CDATA[Hiking DDS238-2 ZN/S is a cheap €25 single phase energy meter which can measure import and export energy in addition to all the standard parameters, and has a Modbus interface over RS485. I used this Modbus registry information to create this device template for Home Assistant where the meter is attached to the Protoss PE11 [&#8230;] <a href="https://kaspars.net/blog/hiking-dds238-2-modbus" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p><a href="https://kaspars.net/go/hiking-dds238-2-zn-s" data-type="surl" data-id="9260">Hiking DDS238-2 ZN/S</a> is a cheap €25 single phase energy meter which can measure import and export energy in addition to all the standard parameters, and has a Modbus interface over RS485.</p>



<span id="more-8124"></span>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2702" height="1528" src="https://kaspars.net/wp-content/uploads/2022/04/home-assistant-hiking-dds238-2-zn-s-modbus-sensor.png" alt="Home Assistant energy dashboard using Hiking DDS238-2 energy meter" class="wp-image-8134" srcset="https://kaspars.net/wp-content/uploads/2022/04/home-assistant-hiking-dds238-2-zn-s-modbus-sensor.png 2702w, https://kaspars.net/wp-content/uploads/2022/04/home-assistant-hiking-dds238-2-zn-s-modbus-sensor-800x452.png 800w, https://kaspars.net/wp-content/uploads/2022/04/home-assistant-hiking-dds238-2-zn-s-modbus-sensor-1024x579.png 1024w, https://kaspars.net/wp-content/uploads/2022/04/home-assistant-hiking-dds238-2-zn-s-modbus-sensor-1536x869.png 1536w, https://kaspars.net/wp-content/uploads/2022/04/home-assistant-hiking-dds238-2-zn-s-modbus-sensor-2048x1158.png 2048w" sizes="(max-width: 2702px) 100vw, 2702px" /><figcaption class="wp-element-caption">Home Assistant energy dashboard using Hiking DDS238-2 energy meter.</figcaption></figure>



<p>I used this <a href="https://github.com/fawno/Modbus/blob/4871fe24a342eee4f0db33d28968e37483ad3f1d/DDS238-2%20ZN-S%20Modbus.md">Modbus registry information</a> to create this device <a href="https://www.home-assistant.io/integrations/modbus/">template for Home Assistant</a> where the meter is attached to the <a href="http://www.hi-flying.com/pe11">Protoss PE11 RS485 to TCP</a> gateway (<a href="https://www.aliexpress.com/item/4001070650831.html">available for €25</a>) available on IP <code>123.123.123.123</code> which must be adjusted for your setup or switched to a serial config:</p>



<pre class="wp-block-code"><code>modbus:
  - name: Protoss PE11
    type: tcp
    host: 123.123.123.123
    port: 502
    timeout: 0.5
    sensors:

      - name: DDS238-2 ZN-S Total Energy
        device_class: energy
        state_class: total
        unit_of_measurement: kWh
        address: 0
        count: 2
        data_type: uint32
        scale: 0.01
        precision: 2

      - name: DDS238-2 ZN-S Export Energy
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: kWh
        address: 8
        count: 2
        data_type: uint32
        scale: 0.01
        precision: 2
    
      - name: DDS238-2 ZN-S Import Energy
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: kWh
        address: 10
        count: 2
        data_type: uint32
        scale: 0.01
        precision: 2

      - name: DDS238-2 ZN-S Voltage
        device_class: voltage
        unit_of_measurement: V
        address: 12
        data_type: uint16
        scale: 0.1
        precision: 1

      - name: DDS238-2 ZN-S Current
        device_class: current
        unit_of_measurement: A
        address: 13
        data_type: uint16
        scale: 0.01
        precision: 2

      - name: DDS238-2 ZN-S Power
        device_class: power
        data_type: int16
        unit_of_measurement: W
        address: 14
        
      - name: DDS238-2 ZN-S Reactive Power
        device_class: apparent_power
        data_type: uint16
        unit_of_measurement: VAr
        address: 15
        
      - name: DDS238-2 ZN-S Power Factor
        device_class: power_factor
        unit_of_measurement: '%'
        data_type: uint16
        address: 16
        scale: 0.1
        precision: 1

      - name: DDS238-2 ZN-S Frequency
        device_class: frequency
        unit_of_measurement: Hz
        data_type: uint16
        address: 17
        scale: 0.01
        precision: 2</code></pre>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/hiking-dds238-2-modbus/feed</wfw:commentRss>
			<slash:comments>3</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2022/04/home-assistant-hiking-dds238-2-zn-s-modbus-sensor-150x150.png" length="6725" type="image/png" />	</item>
		<item>
		<title>Use Aqara G2H Zigbee Camera Hub with Home Assistant</title>
		<link>https://kaspars.net/blog/aqara-g2h-homekit</link>
					<comments>https://kaspars.net/blog/aqara-g2h-homekit#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 17 Apr 2022 16:38:36 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Home Assistant]]></category>
		<category><![CDATA[HomeKit]]></category>
		<category><![CDATA[Zigbee]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=8081</guid>

					<description><![CDATA[Aqara G2H (ZNSXJ12LM) is a really nice Zigbee hub and indoor camera with official HomeKit support. Of course it runs Linux so people have discovered ways to connect it to Home Assistant which exposes most of your HomeKit devices to Home Assistant over MQTT without impacting the original Apple Home and Aqara app integrations. Getting [&#8230;] <a href="https://kaspars.net/blog/aqara-g2h-homekit" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p><a href="https://kaspars.net/go/aqara-g2h" data-type="surl" data-id="8083">Aqara G2H</a> (<code>ZNSXJ12LM</code>) is a really nice Zigbee hub and indoor camera with official HomeKit support. Of course it runs Linux so people <a href="https://github.com/niceboygithub/AqaraGateway">have discovered ways to connect it to Home Assistant</a> which exposes most of your HomeKit devices to Home Assistant over MQTT without impacting the original Apple Home and Aqara app integrations.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1857" height="1153" src="https://kaspars.net/wp-content/uploads/2022/04/aqara-hub-g2h-home-assistant.png" alt="AqaraGateway Integration in Home Assistant with Aqara Hub G2H" class="wp-image-8094" srcset="https://kaspars.net/wp-content/uploads/2022/04/aqara-hub-g2h-home-assistant.png 1857w, https://kaspars.net/wp-content/uploads/2022/04/aqara-hub-g2h-home-assistant-800x497.png 800w, https://kaspars.net/wp-content/uploads/2022/04/aqara-hub-g2h-home-assistant-1024x636.png 1024w, https://kaspars.net/wp-content/uploads/2022/04/aqara-hub-g2h-home-assistant-1536x954.png 1536w" sizes="(max-width: 1857px) 100vw, 1857px" /><figcaption>Aqara G2H Zigbee hub sensors exposed in Home Assistant via the AqaraGateway integration.</figcaption></figure>



<span id="more-8081"></span>



<h2 class="wp-block-heading">Getting Access</h2>



<p><a href="https://github.com/mcchas/g2h-camera-mods">Turns out</a> you can put a file named <code>hostname</code> (without any file extension) in the root of the SD card of the device and it will be executed as a bash script during the boot process. The following contents will set the password for the user <code>root</code> to <code>password</code> and set the <code>WITH_TELNET</code> environment variable to <code>y</code> which enables the <code>telnetd</code> service for remote access:</p>



<pre class="wp-block-code"><code>#!/bin/sh
echo "root:password" | chpasswd
export WITH_TELNET="y"</code></pre>



<p>After inserting the SD card and restarting the camera you should be able to connect to it using telnet:</p>



<pre class="wp-block-code"><code>telnet camera-hub-g2h.local</code></pre>



<p>which opens the telnet prompt:</p>



<pre class="wp-block-code"><code>Trying 123.123.123.123...
Connected to camera-hub-g2h.local.
Escape character is '^]'.

Camera-Hub-G2H login: root
Password:</code></pre>



<p>and you now have full root access to the filesystem!</p>



<div class="wp-block-image"><figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="730" height="548" src="https://kaspars.net/wp-content/uploads/2022/04/processes-aqara-hub-g2h-top-root-access.png" alt="Aqara G2H root access processes" class="wp-image-8118"/><figcaption>All processes running on the camera.</figcaption></figure></div>



<h2 class="wp-block-heading">Setup Aqara Gateway</h2>



<p>The <a href="https://github.com/niceboygithub/AqaraGateway">AqaraGateway project</a> is a set of custom binaries and python scripts that enable access to all the connected Zigbee devices over MQTT while keeping the Aqara app and the HomeKit integration working as before. </p>



<p>It does it in the following way:</p>



<ol class="wp-block-list"><li>You replace the <code>mosquitto</code> MQTT broker binary on the device <a href="https://github.com/niceboygithub/AqaraGateway/tree/72561429919dcb542e9d2e065a07c38b076ee4e8#not-flash-custom-firmware-method-for-g2h">with a custom one</a> (which appears to be closed source?) which exposes the MQTT service on a public port on your local network and removes the authentication for the MQTT service.</li><li>You install the Aqara Gateway Home Assistant integration via <a href="https://hacs.xyz/">HACS (Home Assistant Community Store)</a> which then talks to the device over <code>telnet</code> to <a href="https://github.com/niceboygithub/AqaraGateway/blob/b13c2cf0f3150fc5ec3230206119aeab68fdeff0/custom_components/aqara_gateway/config_flow.py#L61-L63">validate the <code>mosquitto</code> binary</a>, to <a href="https://github.com/niceboygithub/AqaraGateway/blob/72561429919dcb542e9d2e065a07c38b076ee4e8/custom_components/aqara_gateway/core/gateway.py#L175-L217">fetch the available Zigbee devices</a> and <a href="https://github.com/niceboygithub/AqaraGateway/blob/72561429919dcb542e9d2e065a07c38b076ee4e8/custom_components/aqara_gateway/core/gateway.py#L444-L480">to establish an MQTT subscription with the broker on the device</a>.</li><li>The Aqara Gateway in your Home Assistant <a href="https://github.com/niceboygithub/AqaraGateway/blob/b13c2cf0f3150fc5ec3230206119aeab68fdeff0/custom_components/aqara_gateway/core/gateway.py#L467-L478">maps the MQTT messages</a> to different devices supported by the gateway such as <a href="https://github.com/niceboygithub/AqaraGateway/blob/f6e06be8f1e96a541eb5bfcc7d91d4689f1fb760/custom_components/aqara_gateway/binary_sensor.py">binary sensors</a> and <a href="https://github.com/niceboygithub/AqaraGateway/blob/f6e06be8f1e96a541eb5bfcc7d91d4689f1fb760/custom_components/aqara_gateway/sensor.py">general sensors</a> similar to <a href="https://www.zigbee2mqtt.io/">Zigbee2MQTT</a>.</li></ol>



<p>Initially the gateway integration <a href="https://github.com/niceboygithub/AqaraGateway/issues/93">wasn&#8217;t recognizing my camera</a> but this was resolved in <a href="https://github.com/niceboygithub/AqaraGateway/commit/8c81decd56b654cb58359d4a84fab31513adef79">one of the recent updates</a>.</p>



<p>Support for new Aqara Zigbee devices requires updates to the AqaraGateway library and it appears that <a href="https://github.com/niceboygithub/AqaraGateway/issues">new issues are being opened on GitHub</a> and they are also addressed.</p>



<h2 class="wp-block-heading">Conclusions</h2>



<p>Aqara hubs that support Aqara Gateway software are the only option on the market with local, no-cloud and open source API which supports HomeKit and Home Assistant integration <em>at the same time</em>. Another alternative is the <a href="https://kaspars.net/blog/zemismart-zigbee-homekit-hub" data-type="post" data-id="8147">Zemismart Zigbee Gateway</a> which adds HomeKit support for many of the Tuya Zigbee devices, and <a href="https://zigbee.blakadder.com/Lidl_TYGWZ-01.html">can be rooted too</a>.</p>



<figure class="wp-block-embed is-type-rich is-provider-twitter wp-block-embed-twitter"><div class="wp-block-embed__wrapper">
<blockquote class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">Here is a teardown of the Zemismart Zigbee hub with HomeKit support. It uses TYZS4 Zigbee <br>module from Tuya and it doesn&#39;t actually support WiFi. The internals look very similar to SilverCrest Zigbee Gateway <a href="https://t.co/2w8l7lsQGZ">https://t.co/2w8l7lsQGZ</a> <a href="https://t.co/hCaw40BNKJ">pic.twitter.com/hCaw40BNKJ</a></p>&mdash; Kaspars (@konstruktors) <a href="https://twitter.com/konstruktors/status/1493199750442663946?ref_src=twsrc%5Etfw">February 14, 2022</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div></figure>



<p>However, the Zemismart gateway looses the HomeKit support if you replace the Tuya integration with the <a href="https://paulbanks.org/projects/lidl-zigbee/ha/">a ZHA serial gateway</a> supported by Home Assistant because it takes over the UART connection with <code>/dev/ttyS2</code> which is used by the Tuya <code>zigbee_agent</code> to talk to the <a href="https://www.nxp.com/products/wireless/thread/jn5189-88-t-high-performance-and-ultra-low-power-mcus-for-zigbee-and-thread-with-built-in-nfc-option:JN5189_88_T">NXP JN5189 Zigbee module</a>.</p>



<p></p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/aqara-g2h-homekit/feed</wfw:commentRss>
			<slash:comments>13</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2022/04/aqara-hub-g2h-home-assistant-150x150.png" length="8944" type="image/png" />	</item>
		<item>
		<title>Notes on Gree Amber Nordic / Prestige GWH09YD-S6DBA2A Heat Pump</title>
		<link>https://kaspars.net/blog/gree-amber-nordic-gwh09yd-s6dba1</link>
					<comments>https://kaspars.net/blog/gree-amber-nordic-gwh09yd-s6dba1#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 13 Feb 2022 11:58:16 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Home Assistant]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7959</guid>

					<description><![CDATA[As part of an experiment to add domestic water heating capabilities to conventional mini-split ACs, I purchased an air-source heat pump Gree GWH09YD-S6DBA2A which has an inverter controlled compressor and an electronic expansion valve that allows it to work efficiently even down to -30℃ (-22℉). Service Manual Most of the technical information in this post [&#8230;] <a href="https://kaspars.net/blog/gree-amber-nordic-gwh09yd-s6dba1" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2000" height="1500" src="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1.jpeg" alt="Gree GWH09YD-S6DBA1 indoor PCB with IR and WiFi modules" class="wp-image-8011" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1.jpeg 2000w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-1536x1152.jpeg 1536w" sizes="(max-width: 2000px) 100vw, 2000px" /><figcaption class="wp-element-caption">Gree GWH09YD-S6DBA1A indoor heat exchanger power connectors, PCB with IR and WiFi modules.</figcaption></figure>



<p>As part of <a href="https://kaspars.net/blog/mini-split-space-hot-water-heating" data-type="post" data-id="7897">an experiment to add domestic water heating capabilities to conventional mini-split ACs</a>, I purchased an air-source heat pump <strong>Gree GWH09YD-S6DBA2A</strong> which has an inverter controlled compressor and an electronic expansion valve that allows it to work efficiently even down to -30℃ (-22℉).</p>



<span id="more-7959"></span>



<ul class="wp-block-list">
<li>Model: GWH09YD-S6DBA2A (outdoor), S6DBA1A (indoor)</li>



<li>Product code: CB466000100/CB466000102</li>



<li>Cooling capacity: 2.7kW</li>



<li>Heating capacity: 3.5kW</li>



<li>Refrigerant: R32</li>



<li>Remote model: YAG1FB3</li>
</ul>



<h2 class="wp-block-heading" id="service-manual">Service Manual</h2>



<p>Most of the technical information in this post has been retrieved from the official service manual:</p>



<div class="wp-block-file"><a id="wp-block-file--media-5d6ce814-9b05-4b14-91f0-463de15a1317" href="https://kaspars.net/wp-content/uploads/2022/02/air-pump-gree-amber-GWH09YD-GWH12YD-service-manual.pdf">Gree Amber GWH09YD-GWH12YD Service Manual (PDF)</a><a href="https://kaspars.net/wp-content/uploads/2022/02/air-pump-gree-amber-GWH09YD-GWH12YD-service-manual.pdf" class="wp-block-file__button wp-element-button" download aria-describedby="wp-block-file--media-5d6ce814-9b05-4b14-91f0-463de15a1317">Download</a></div>



<h2 class="wp-block-heading">Firmware</h2>



<p>Initially the unit was reporting firmware version <code>v1.00</code> and only in April 2023 it offered an update to <code>v3.76</code> via the official <a href="https://apps.apple.com/us/app/gree/id1167857672">Gree+ app</a> which completed successfully.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://kaspars.net/wp-content/uploads/2023/08/gree-firmware-1.0.0.png" alt="Gree firmware update from v1.00 to v3.76" class="wp-image-8542" width="414" height="364" srcset="https://kaspars.net/wp-content/uploads/2023/08/gree-firmware-1.0.0.png 828w, https://kaspars.net/wp-content/uploads/2023/08/gree-firmware-1.0.0-800x703.png 800w" sizes="(max-width: 414px) 100vw, 414px" /><figcaption class="wp-element-caption">Firmware update to v3.76.</figcaption></figure></div>


<p>In July 2023 it started showing an available update to <code>v3.77</code> but I haven&#8217;t been able to apply it due to a network timeout after requesting the update.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://kaspars.net/wp-content/uploads/2023/08/gree-firmware-update-2023.jpeg" alt="Gree firmware update to v3.77" class="wp-image-8543" width="414" height="381" srcset="https://kaspars.net/wp-content/uploads/2023/08/gree-firmware-update-2023.jpeg 828w, https://kaspars.net/wp-content/uploads/2023/08/gree-firmware-update-2023-800x736.jpeg 800w" sizes="(max-width: 414px) 100vw, 414px" /><figcaption class="wp-element-caption">Firmware update to v3.77.</figcaption></figure></div>


<h2 class="wp-block-heading" id="ir-remote-protocol">IR Remote Protocol</h2>



<p>I used an infrared photodiode attached directly to pins <code>GND</code> and <code>D3</code> (which is pulled high) of Wemos D1 mini and the <code>IRrecvDumpV3.ino</code> <a href="https://github.com/crankyoldgit/IRremoteESP8266/blob/8b1bfc37ec4afb79a09c757cc28044a867d2f77e/examples/IRrecvDumpV3/IRrecvDumpV3.ino">sketch bundled</a> with v2.8.1 of the <a href="https://github.com/crankyoldgit/IRremoteESP8266">IRremoteESP8266 library</a> to decoded the messages.</p>



<p>Here are the infrared bit sequences captured by the Saleae logic analyser:</p>



<figure class="wp-block-image alignfull size-full"><img loading="lazy" decoding="async" width="2057" height="267" src="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-YAG1FB3.png" alt="Gree YAG1FB3 remote signal capture" class="wp-image-7966" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-YAG1FB3.png 2057w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-YAG1FB3-800x104.png 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-YAG1FB3-1024x133.png 1024w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-YAG1FB3-1536x199.png 1536w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-YAG1FB3-2048x266.png 2048w" sizes="(max-width: 2057px) 100vw, 2057px" /><figcaption class="wp-element-caption">Capture of the IR signal from the YAG1FB3 remote when turning on the device. </figcaption></figure>



<div class="wp-block-file"><a id="wp-block-file--media-e7f8507d-9676-4c5a-a8c7-f8124d9ee806" href="https://kaspars.net/wp-content/uploads/2022/02/gree-yag1fb3-turn-on-remote.sal">YAG1FB3 remote IR capture (Saleae)</a><a href="https://kaspars.net/wp-content/uploads/2022/02/gree-yag1fb3-turn-on-remote.sal" class="wp-block-file__button wp-element-button" download aria-describedby="wp-block-file--media-e7f8507d-9676-4c5a-a8c7-f8124d9ee806">Download</a></div>



<p>We can clearly see two sets of messages that are repeated twice. Each message has two parts and the first one starts with a longer sync header.</p>



<p>Initially it complained about the packets being too large to fit in the allocated buffer:</p>



<pre class="wp-block-preformatted">WARNING: IR code is too big for buffer (&gt;= 1024). This result shouldn't be trusted until this is resolved. Edit &amp; increase `kCaptureBufferSize`.</pre>



<p>That is because of the <code>kTimeout</code> constant which is set to <code>50</code> by default and is 10ms above the actual period of 40ms between the groups of messages that we see in the logic analyser output above. By setting the value to 30:</p>



<pre class="wp-block-code"><code>const uint8_t kTimeout = 30;</code></pre>



<p>it started decoding the packets as expected:</p>



<pre class="wp-block-code"><code>Protocol  : GREE
Code      : 0x0C084070000000E0 (64 Bits)
Mesg Desc.: Model: 1 (YAW1F), Power: On, Mode: 4 (Heat), Temp: 24C, Fan: 0 (Auto), Turbo: Off, Econo: Off, IFeel: Off, WiFi: Off, XFan: Off, Light: Off, Sleep: Off, Swing(V) Mode: Manual, Swing(V): 0 (Last), Swing(H): 0 (Off), Timer: Off, Display Temp: 0 (Off)
uint16_t rawData&#91;139] = {9004, 4474,  664, 540,  664, 540,  666, 1642,  664, 1644,  664, 542,  664, 540,  664, 542,  664, 542,  664, 542,  664, 542,  664, 542,  664, 1642,  664, 542,  664, 540,  666, 540,  664, 540,  664, 542,  664, 542,  664, 542,  664, 540,  664, 540,  664, 542,  664, 1642,  664, 542,  664, 540,  666, 540,  666, 540,  664, 540,  666, 1642,  664, 1642,  664, 1642,  664, 540,  664, 542,  664, 1642,  664, 540,  664, 19974,  664, 542,  664, 542,  664, 542,  664, 542,  664, 542,  664, 542,  662, 542,  662, 542,  664, 542,  664, 542,  664, 542,  664, 542,  662, 544,  662, 544,  662, 544,  662, 542,  662, 544,  662, 542,  662, 542,  662, 544,  662, 544,  662, 542,  664, 544,  662, 542,  662, 544,  662, 542,  662, 542,  664, 542,  662, 544,  662, 1644,  662, 1644,  662, 1644,  662};  // GREE
uint8_t state&#91;8] = {0x0C, 0x08, 0x40, 0x70, 0x00, 0x00, 0x00, 0xE0};</code></pre>



<p>In the decoded bit timing sequence above we see a 9004us header mark followed by a 4474us space and then the actual message bits where the bit mark is 664us, logical <code>0</code> space is 542us, logical <code>1</code> space is 1642us and with 19974us between the two packets of the message.</p>



<p>Enabling the I-feel mode (where the remote sends the indoor temperature to the indoor unit) does append another packet to the end which isn&#8217;t parsed correctly, though:</p>



<pre class="wp-block-code"><code>Protocol  : UNKNOWN
Code      : 0x5EF985F1 (18 Bits)
uint16_t rawData&#91;35] = {6008, 2986,  658, 546,  658, 548,  658, 548,  658, 1648,  658, 1648,  658, 546,  658, 548,  658, 548,  658, 1650,  658, 546,  658, 1648,  658, 546,  658, 548,  658, 1648,  658, 548,  658, 1648,  658};</code></pre>



<p>It appears that this packet is supported <a href="https://github.com/ToniA/arduino-heatpumpir/blob/279ae403af3fee9d1478a4a2f6632fa1b653c4bb/GreeHeatpumpIR.h#L17-L20">by the <code>arduino-heatpumpir</code> library</a>. According to the <a href="https://github.com/ToniA/arduino-heatpumpir/blob/279ae403af3fee9d1478a4a2f6632fa1b653c4bb/GreeHeatpumpIR.cpp#L314-L336"><code>GreeYACHeatpumpIR::send()</code> method</a> we&#8217;re expecting a header followed by two data bytes (<a href="https://github.com/ToniA/arduino-heatpumpir/blob/279ae403af3fee9d1478a4a2f6632fa1b653c4bb/IRSender.cpp#L12-L30">using the following logic</a>) and one closing <code>GREE_YAC_BIT_MARK</code>:</p>



<ul class="wp-block-list">
<li><code>6008, 2986</code> are the two header marks,</li>



<li><code>658,546 | 658,548 | 658,548 | 658,1648 | 658,1648 | 658,546 | 658,548 | 658,548</code> maps to <code>0x00011000</code> in binary which is <code>24</code> in decimal (the temperature measured by the remote).</li>



<li><code>658,1650 | 658,546 | 658,1648 | 658,546 | 658,548 | 658,1648 | 658,548 | 658,1648</code> maps to <code>0b10100101</code> or <code>0xA5</code> in hex <a href="https://github.com/ToniA/arduino-heatpumpir/blob/279ae403af3fee9d1478a4a2f6632fa1b653c4bb/GreeHeatpumpIR.cpp#L320">as expected</a>.</li>



<li><code>658</code> is the closing <code>GREE_YAC_BIT_MARK</code>.</li>
</ul>



<h2 class="wp-block-heading" id="ir-receiver-module">IR Receiver Module</h2>



<p>Attached to the back of the inner block cover is a display module combined with an IR receiver. I was wondering if the IR receiver logic could be handled there and forwarded to the main PCB via something like UART. Turns out the LCD elements and the IR receiver diode run down to the main PCB so there is nothing to hijack.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2500" height="1624" src="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-lcd-display-ir-receiver.jpeg" alt="Gree GWH09YD-S6DBA1 front cover LCD module with IR receiver" class="wp-image-8024" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-lcd-display-ir-receiver.jpeg 2500w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-lcd-display-ir-receiver-800x520.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-lcd-display-ir-receiver-1024x665.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-lcd-display-ir-receiver-1536x998.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-lcd-display-ir-receiver-2048x1330.jpeg 2048w" sizes="(max-width: 2500px) 100vw, 2500px" /><figcaption class="wp-element-caption">Back of the PCB for Gree GWH09YD-S6DBA2A front cover LCD module with IR receiver.</figcaption></figure>



<h2 class="wp-block-heading" id="wi-fi-module">Wi-Fi Module</h2>



<p>There is a built-in Wi-Fi module which uses <a href="https://github.com/cmroche/greeclimate">a protocol that has been reverse-engineered</a> and enables full control over the local network once the unit has been added to the Wi-Fi network using the GREE+ app for iOS and Android. There is even <a href="https://www.home-assistant.io/integrations/gree/">a fully functional HomeAssistant integration</a>.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2500" height="1875" src="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-top.jpeg" alt="Gree GWH09YD-S6DBA1 built-in WiFi module top" class="wp-image-8044" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-top.jpeg 2500w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-top-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-top-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-top-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-top-2048x1536.jpeg 2048w" sizes="(max-width: 2500px) 100vw, 2500px" /><figcaption class="wp-element-caption">Gree GWH09YD-S6DBA2A built-in WiFi module top.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2400" height="1800" src="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-back.jpeg" alt="Gree GWH09YD-S6DBA1 built-in WiFi module back" class="wp-image-8045" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-back.jpeg 2400w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-back-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-back-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-back-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-wifi-module-back-2048x1536.jpeg 2048w" sizes="(max-width: 2400px) 100vw, 2400px" /><figcaption class="wp-element-caption">Gree GWH09YD-S6DBA2A built-in WiFi module back.</figcaption></figure>



<p>The <code>COM-MANUAL</code> label and the four wires going to the module from the PCB indicate that this is possibly an UART-to-WIFI bridge. However, attaching the digital logic analyser probes to the dark-brown, light-brown and GND pins produced a lot of noise without clear indication of the data being transfered.</p>



<h2 class="wp-block-heading" id="bms-and-com-manual-connections">BMS and COM Manual Connections </h2>



<p>There are two additional wire connections that are coming out of the PCB that are left not connected:</p>



<ul class="wp-block-list">
<li><code>BMS</code> which is potentially a Modbus or CAN connections for Building Management Systems.</li>



<li><code>COM-MANUAL</code> which is designated as &#8220;Wired Controller (optional)&#8221; in the service manual.</li>
</ul>



<p>There is a lot of potential for gaining full read-write access to the device through these ports but I haven&#8217;t gotten to that yet.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1410" height="1123" src="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-O-indoor-diagram.png" alt="Gree GWH09YD-S6DBA1AO indoor PCB diagram" class="wp-image-8054" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-O-indoor-diagram.png 1410w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-O-indoor-diagram-800x637.png 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-O-indoor-diagram-1024x816.png 1024w" sizes="(max-width: 1410px) 100vw, 1410px" /><figcaption class="wp-element-caption">Gree GWH09YD-S6DBA1A indoor PCB diagram.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1581" height="1073" src="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-pcb-top.png" alt="Gree GWH09YD-S6DBA1A indoor PCB" class="wp-image-8049" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-pcb-top.png 1581w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-pcb-top-800x543.png 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-pcb-top-1024x695.png 1024w, https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA2A-pcb-top-1536x1042.png 1536w" sizes="(max-width: 1581px) 100vw, 1581px" /><figcaption class="wp-element-caption">Gree GWH09YD-S6DBA1A indoor PCB.</figcaption></figure>



<h2 class="wp-block-heading">Wired Controller XK76</h2>



<p>Some of the Gree models support wired controllers or thermostats in addition to the RF remotes. This indoor unit has two unpopulated connectors labeled <code>BMS</code> and (forgot the other one) in addition to the <code>WIFI</code> cable that is connected to the WIFI module.</p>



<p>The <code>BMS</code> connector is attached to the wired controller and it appears to be using some kind of serial protocol (potentially Modbus over RS485 similar to their commercial units) to communicate with the remote controller.</p>



<p>Unfortunately, it isn&#8217;t very clear which wired controllers support which indoor units especially because the model numbers don&#8217;t appear to be shared between units sold in EU and US, for example. Your best option is to review the service manual for the heat pump and determine the controller model by the picture. I decided to get what appeared to be the most recent version of the wired controllers XK76 and just hoped it would work with my device. And luckily it does!</p>



<p><strong>Important:</strong> Make sure to turn off the heat pump completely before connecting the controller or it will return an error code <code>E6</code> and fail to communicate with the device. I almost thought it just doesn&#8217;t work and put it on sale&#8230; </p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/04/gree-xk76-wired-controller-thermostat-box-scaled.jpeg" alt="" class="wp-image-8072" srcset="https://kaspars.net/wp-content/uploads/2022/04/gree-xk76-wired-controller-thermostat-box-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2022/04/gree-xk76-wired-controller-thermostat-box-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/04/gree-xk76-wired-controller-thermostat-box-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/04/gree-xk76-wired-controller-thermostat-box-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/04/gree-xk76-wired-controller-thermostat-box-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">XK76 comes in a box with two back panels, a four wire cable and a patch cable.</figcaption></figure>



<p>And here is the photo of the PCB which appears to have just a single microcontroller and three physical connection ports with matching drivers and a bunch of passives to drive the screen:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-top-scaled.jpeg" alt="The PCB of the Gree Gree XK76 wired controller thermostat" class="wp-image-8073" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-top-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-top-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-top-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-top-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-top-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">The <code>CN4</code> connector on the top-right is used to attach the communications cable. With markings GRJ4K-B on the PCB.</figcaption></figure>



<p>And here is a photo of the main controller which appears to be <a href="https://www.nxp.com/products/processors-and-microcontrollers/arm-microcontrollers/general-purpose-mcus/lpc3000-arm9:MC_71572">NXP LPC3100 series ARM9</a>:</p>



<figure class="wp-block-image alignwide size-large"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-teardown-1024x768.jpeg?_t=1649965272" alt="Gree XK76 wired controller with NXP LPC3100 ARM9 microcontroller" class="wp-image-8074" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-teardown-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-teardown-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-teardown-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/02/gree-xk76-wired-controller-thermostat-pcb-teardown-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Gree XK76 with NXP LPC3100 ARM9 microcontroller.</figcaption></figure>



<h2 class="wp-block-heading" id="indoor-outdoor-communication">Outdoor and Indoor Unit Communication</h2>



<p>There is no official documentation for the communication protocol used between the indoor and outdoor units. Below are my findings based on reverse-engineering and the insight shared by other enthusiasts after publishing this post.</p>



<h3 class="wp-block-heading">System Design</h3>



<p>All of the heat pump control logic is handled by the outdoor unit while the indoor unit only requests heating or cooling and sends the temperature readings of the indoor heat exchanger as input for the outdoor control board.</p>



<p>The communication between the outdoor and indoor units happens via a DC signal referenced to the AC power ground.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="768" height="531" src="https://kaspars.net/wp-content/uploads/2022/05/gree-outdoor-unit-wiring.png" alt="Gree Heat Pump Outdoor Unit Wiring" class="wp-image-8218"/><figcaption class="wp-element-caption">Wire labeled &#8220;BK&#8221; (2) used for communication signal between the indoor and outdoor units.</figcaption></figure></div>


<h3 class="wp-block-heading" id="indoor-outdoor-protocol">Communication Protocol</h3>



<p>I was able to attach an oscilloscope and record the following communication between the outdoor and indoor units. See <a href="https://www.reddit.com/r/AskElectronics/comments/ukxui7/how_to_decode_minisplit_heatpump_indoor_and/">this thread on Reddit</a> for what others think.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="800" height="480" src="https://kaspars.net/wp-content/uploads/2022/02/gree-outdoor-indoor-inverter-communication.png" alt="Gree heatpump indoor and outdoor unit communication" class="wp-image-8282"/><figcaption class="wp-element-caption">Indoor and outdoor unit communication.</figcaption></figure></div>


<p>It is using a 0-60V serial signal centered around 30V &#8212; the outdoor control board keeps the signal at 30V and the indoor unit pulls it low to 0V to send the data. For replies the outdoor unit pulls the signal high to 60V.</p>



<p>The logic analyser was able to decode the serial signal when set to <strong>LSB byte order, 1200 baud rate, 8 data bits, 1 stop bit and even parity</strong>.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1238" height="1041" src="https://kaspars.net/wp-content/uploads/2022/02/gree-inverter-heat-pump-communication-serial.png" alt="Gree heat pump heat exchanger and compressor communication" class="wp-image-8292" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-inverter-heat-pump-communication-serial.png 1238w, https://kaspars.net/wp-content/uploads/2022/02/gree-inverter-heat-pump-communication-serial-800x673.png 800w, https://kaspars.net/wp-content/uploads/2022/02/gree-inverter-heat-pump-communication-serial-1024x861.png 1024w" sizes="(max-width: 1238px) 100vw, 1238px" /><figcaption class="wp-element-caption">Serial communication with 20 bytes of data sent between the indoor and outdoor units.</figcaption></figure>



<p>Based on the functionality of the multifunctional inverter testers mentioned below, it should contain the following data:</p>



<ul class="wp-block-list">
<li>Operation mode (heating, cooling)</li>



<li>Internal fan speed</li>



<li>Set temperature</li>



<li>Bus voltage (AC supply)</li>



<li>Bus current</li>



<li>Compressor frequency</li>



<li>Expansion valve opening</li>



<li>Module temperature (?)</li>



<li>Inner ring temperature (?)</li>



<li>Inner tube temperature (?)</li>



<li>Outer ring temperature (?)</li>



<li>Outer tube temperature (?)</li>



<li>Exhaust temperature</li>



<li>Cold inlet temperature (?)</li>
</ul>



<p>The first byte indicates the type of the message (<code>0x31</code> and <code>0x32</code> in the examples above) followed by the actual data bytes closed out by an 8-bit modulo 256 checksum byte. Here are the messages I&#8217;ve been able to decode:</p>



<h4 class="wp-block-heading">Message <code>0x31</code> Source</h4>



<figure class="wp-block-table"><table><thead><tr><th>Byte</th><th>Hex</th><th>Decimal</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td>0</td><td>0x31</td><td>49</td><td></td><td>Destination or source address?</td></tr><tr><td>1</td><td>0x20</td><td>32</td><td></td><td>Destination or source address?</td></tr><tr><td>2</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>3</td><td>0x14</td><td><strong>20</strong></td><td><strong>Heating</strong></td><td>Mode, 20=heat, 17=cool, 19=ventilation, ?=auto, ?=dry, fan-only=?, off=?</td></tr><tr><td>4</td><td>0x8</td><td><strong>8</strong></td><td><strong>Auto</strong></td><td>Fan speed, 1=low, 2=medium, 3=high, 4=turbo, 128=off, 8=auto? (low, medium low, medium, medium high, high)</td></tr><tr><td>5</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>6</td><td>0x38</td><td><strong>56</strong></td><td><strong>16</strong></td><td>Set temperature (value &#8211; 40)</td></tr><tr><td>7</td><td>0x3C</td><td><strong>60</strong></td><td><strong>20</strong></td><td>Room temperature (value &#8211; 40)</td></tr><tr><td>8</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>9</td><td>0x3A</td><td><strong>58</strong></td><td><strong>18</strong></td><td>Refrigerant temperature inside (value &#8211; 40)</td></tr><tr><td>10</td><td>0x7</td><td>7</td><td></td><td></td></tr><tr><td>11</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>12</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>13</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>14</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>15</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>16</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>17</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>18</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>19</td><td>0x22</td><td><strong>34</strong></td><td><strong>34</strong></td><td>CheckSum8 Modulo 256</td></tr></tbody></table></figure>



<h4 class="wp-block-heading">Message <code>0x31</code> Reply</h4>



<figure class="wp-block-table"><table><thead><tr><th>Byte</th><th>Hex</th><th>Decimal</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td>0</td><td><strong>0x31</strong></td><td><strong>49</strong></td><td></td><td>Destination or source address?</td></tr><tr><td>1</td><td><strong>0x10</strong></td><td><strong>16</strong></td><td></td><td>Destination or source address?</td></tr><tr><td>2</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>3</td><td><strong>0x14</strong></td><td><strong>20</strong></td><td><strong>Heating</strong></td><td>Mode, 20=heat, 17=cool, 19=ventilation, ?=auto, ?=dry, fan-only=?, off=?</td></tr><tr><td>4</td><td><strong>0x20</strong></td><td><strong>32</strong></td><td><strong>32</strong></td><td><strong>Compressor frequency?</strong></td></tr><tr><td>5</td><td><strong>0x5A</strong></td><td><strong>90</strong></td><td><strong>90</strong></td><td><strong>Outdoor fan frequency?</strong></td></tr><tr><td>6</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>7</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>8</td><td>0x1</td><td>1</td><td></td><td>Unknown</td></tr><tr><td>9</td><td>0x23</td><td>35</td><td></td><td>Unknown</td></tr><tr><td>10</td><td>0x61</td><td>97</td><td></td><td>Unknown</td></tr><tr><td>11</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>12</td><td><strong>0x33</strong></td><td><strong>51</strong></td><td><strong>11</strong></td><td><strong>Outside temperature (value &#8211; 40)</strong></td></tr><tr><td>13</td><td><strong>0x30</strong></td><td><strong>48</strong></td><td><strong>8</strong></td><td><strong>Suction line temperature (value &#8211; 40)</strong></td></tr><tr><td>14</td><td><strong>0x5C</strong></td><td><strong>92</strong></td><td><strong>52</strong></td><td><strong>Discharge line temperature (value &#8211; 40)</strong></td></tr><tr><td>15</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>16</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>17</td><td>0x4</td><td>4</td><td></td><td>Unknown</td></tr><tr><td>18</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>19</td><td><strong>0x17</strong></td><td><strong>23</strong></td><td></td><td><strong>CheckSum8 Modulo 256</strong></td></tr></tbody></table></figure>



<h4 class="wp-block-heading">Message <code>0x32</code> Source</h4>



<figure class="wp-block-table"><table><thead><tr><th>Byte</th><th>Hex</th><th>Decimal</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td>0</td><td><strong>0x32</strong></td><td><strong>50</strong></td><td></td><td>Destination or source address?</td></tr><tr><td>1</td><td><strong>0x20</strong></td><td><strong>32</strong></td><td></td><td>Destination or source address?</td></tr><tr><td>2</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>3</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>4</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>5</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>6</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>7</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>8</td><td><strong>0x11</strong></td><td><strong>17</strong></td><td></td><td>Unknown</td></tr><tr><td>9</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>10</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>11</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>12</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>13</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>14</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>15</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>16</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>17</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>18</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>19</td><td><strong>0x63</strong></td><td><strong>99</strong></td><td></td><td>CheckSum8 Modulo 256</td></tr></tbody></table></figure>



<h4 class="wp-block-heading">Message <code>0x32</code> Reply</h4>



<figure class="wp-block-table"><table><thead><tr><th>Byte</th><th>Hex</th><th>Decimal</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td>0</td><td><strong>0x32</strong></td><td><strong>50</strong></td><td></td><td>Destination or source address?</td></tr><tr><td>1</td><td><strong>0x10</strong></td><td><strong>16</strong></td><td></td><td>Destination or source address?</td></tr><tr><td>2</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>3</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>4</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>5</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>6</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>7</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>8</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>9</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>10</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>11</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>12</td><td><strong>0x39</strong></td><td><strong>57</strong></td><td></td><td>Unknown</td></tr><tr><td>13</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>14</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>15</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>16</td><td>0</td><td>0</td><td></td><td></td></tr><tr><td>17</td><td>0xA</td><td><strong>10</strong></td><td></td><td>Unknown</td></tr><tr><td>18</td><td><strong>0x36</strong></td><td><strong>54</strong></td><td></td><td>Unknown</td></tr><tr><td>19</td><td><strong>0xBB</strong></td><td><strong>187</strong></td><td></td><td>CheckSum8 Modulo 256</td></tr></tbody></table></figure>



<p>There are several other message types that I haven&#8217;t yet captured.</p>



<h3 class="wp-block-heading">Portable and Multifunctional Tester for Inverter A/C</h3>



<p>There appear to be several inverter tester tools which support the single wire communication used by multiple brands. The GT2D3AAa model is often referenced as the &#8220;new&#8221; version of the older model GZJ10D009 but I haven&#8217;t been able to confirm that. Importantly, GZJ10D009 is specifically branded by Gree:</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="750" height="750" src="https://kaspars.net/wp-content/uploads/2022/02/gree-GZJ10D009-tester.jpeg" alt="Gree GZJ10D009 tester" class="wp-image-8281" srcset="https://kaspars.net/wp-content/uploads/2022/02/gree-GZJ10D009-tester.jpeg 750w, https://kaspars.net/wp-content/uploads/2022/02/gree-GZJ10D009-tester-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2022/02/gree-GZJ10D009-tester-120x120.jpeg 120w" sizes="(max-width: 750px) 100vw, 750px" /><figcaption class="wp-element-caption">Gree GZJ10D009 tester.</figcaption></figure></div>


<p>And here is the &#8220;new&#8221; version:</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="1024" height="768" src="https://kaspars.net/wp-content/uploads/2022/02/GT2D3AAa-inverter-tester.jpg" alt="GT2D3AAa inverter multifunction tester" class="wp-image-8280" srcset="https://kaspars.net/wp-content/uploads/2022/02/GT2D3AAa-inverter-tester.jpg 1024w, https://kaspars.net/wp-content/uploads/2022/02/GT2D3AAa-inverter-tester-800x600.jpg 800w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption class="wp-element-caption">GT2D3AAa inverter multifunction tester (source: <a href="https://www.aliexpress.com/item/1005004529164927.html">AliExpress</a>).</figcaption></figure></div>


<h2 class="wp-block-heading">Drain Pan Heater in Cold Climates</h2>



<p>The outside unit contains a resistive heater for the drain pan which is turned on and draws constant 100W when the outside temperature falls below 0C (32F) <strong>even when the unit is not running or defrosting anything</strong> (there might be a setting that controls this but I haven&#8217;t been able to find it). </p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="1500" height="2000" src="https://kaspars.net/wp-content/uploads/2022/02/pan-heater-power-draw.jpeg" alt="Gree drain pan heater drawing 0.4A during freezing temperatures" class="wp-image-8300" srcset="https://kaspars.net/wp-content/uploads/2022/02/pan-heater-power-draw.jpeg 1500w, https://kaspars.net/wp-content/uploads/2022/02/pan-heater-power-draw-800x1067.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/pan-heater-power-draw-1024x1365.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/pan-heater-power-draw-1152x1536.jpeg 1152w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption class="wp-element-caption">Drain pan heater drawing 0.4A at 240V during freezing temperatures.</figcaption></figure></div>


<p>This leads to 2.4kWh of additional energy consumption per day which is unfortunate. Note that the heater is only for the drain pan and not the compressor so there is no reason it should be on for more than the defrost cycle and some time after it.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2488" height="1484" src="https://kaspars.net/wp-content/uploads/2022/02/pan-heater.png" alt="Gree drain pan heater power consumption during cold climate" class="wp-image-8299" srcset="https://kaspars.net/wp-content/uploads/2022/02/pan-heater.png 2488w, https://kaspars.net/wp-content/uploads/2022/02/pan-heater-800x477.png 800w, https://kaspars.net/wp-content/uploads/2022/02/pan-heater-1024x611.png 1024w, https://kaspars.net/wp-content/uploads/2022/02/pan-heater-1536x916.png 1536w, https://kaspars.net/wp-content/uploads/2022/02/pan-heater-2048x1222.png 2048w" sizes="(max-width: 2488px) 100vw, 2488px" /><figcaption class="wp-element-caption">Gree drain pan heater drawing 100W during cold weather.</figcaption></figure>



<p>The compressor compartment and piping are really well insulated:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-unit-scaled.jpeg" alt="Gree GWH09YD-S6DBA2A outdoor unit" class="wp-image-8309" srcset="https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-unit-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-unit-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-unit-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-unit-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-unit-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Gree GWH09YD-S6DBA2A outdoor unit.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-wiring-scaled.jpeg" alt="Gree GWH09YD-S6DBA2A outdoor unit element connections" class="wp-image-8310" srcset="https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-wiring-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-wiring-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-wiring-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-wiring-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2022/02/GWH09YD-S6DBA2A-outdoor-wiring-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption class="wp-element-caption">Gree GWH09YD-S6DBA2A outdoor controller connections.</figcaption></figure>



<p>Notice how the <code>4WAY</code> valve 220V switch is almost right next to the <code>HEAT</code> connection for the resistive heater so it should be possible to connect a timer relay which keeps the heater running only for 10 or 30 minutes after the defrost cycle.</p>



<h2 class="wp-block-heading">Forums and Links</h2>



<ul class="wp-block-list">
<li><a href="https://www.facebook.com/groups/2208343752742110/">Heat pump builder community on Facebook</a> (in Polish) where people convert air-source mini-split heat pump to heat water for heating.</li>
</ul>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/gree-amber-nordic-gwh09yd-s6dba1/feed</wfw:commentRss>
			<slash:comments>35</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2022/02/gree-GWH09YD-S6DBA1-150x150.jpeg" length="7522" type="image/jpeg" />	</item>
		<item>
		<title>Notes on MySensors</title>
		<link>https://kaspars.net/blog/mysensors-notes</link>
					<comments>https://kaspars.net/blog/mysensors-notes#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 23 Jan 2022 12:34:58 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Home Assistant]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7948</guid>

					<description><![CDATA[MySensors is a great project for building IoT devices but it tries to do many things &#8212; define a general serial communications protocol (similar to ModBus, CAN), provide a software library for many hardware devices on top of the Arduino abstraction layer, firmware updates and many other things. I first tried it in 2018 when [&#8230;] <a href="https://kaspars.net/blog/mysensors-notes" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p><a href="https://github.com/mysensors/MySensors">MySensors</a> is a great project for building IoT devices but it tries to do many things &#8212; define <a href="https://www.mysensors.org/download/serial_api_20">a general serial communications protocol</a> (similar to <a href="https://modbus.org/">ModBus</a>, <a href="https://en.wikipedia.org/wiki/CAN_bus">CAN</a>), provide a software library for many hardware devices on top of the Arduino abstraction layer, firmware updates and many other things. I first tried it in 2018 <a href="https://kaspars.net/blog/attiny841-rfm69-mysensors" data-type="post" data-id="6753">when building wireless sensor nodes</a> using the RFM69 radios.</p>



<span id="more-7948"></span>



<p>The last stable release of the library was <a href="https://github.com/mysensors/MySensors/releases/tag/2.3.2">in late 2019</a> and the project <a href="https://forum.mysensors.org/topic/11684/where-did-everyone-go/">appears to have been abandoned</a> by the original maintainers as the <a href="https://github.com/mysensors/MySensors/pulls">pull requests are left unmerged</a> and issues unresolved. Having worked on large open source projects I know that this can happen as the priorities change for the original contributors. It would be great if new contributors could be added to the project to keep it going.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2000" height="1252" src="https://kaspars.net/wp-content/uploads/2022/01/era-node-rs485-raspberry-pi.jpeg" alt="Era node using ESP8266 (Wemos D1 mini) connected to Raspberry Pi over RS485" class="wp-image-7950" srcset="https://kaspars.net/wp-content/uploads/2022/01/era-node-rs485-raspberry-pi.jpeg 2000w, https://kaspars.net/wp-content/uploads/2022/01/era-node-rs485-raspberry-pi-800x501.jpeg 800w, https://kaspars.net/wp-content/uploads/2022/01/era-node-rs485-raspberry-pi-1024x641.jpeg 1024w, https://kaspars.net/wp-content/uploads/2022/01/era-node-rs485-raspberry-pi-1536x962.jpeg 1536w" sizes="(max-width: 2000px) 100vw, 2000px" /><figcaption>Era node using ESP8266 (Wemos D1 mini) connected to Raspberry Pi over RS485.</figcaption></figure>



<p>Here are my notes on the state of things as I attempt to use the MySensors protocol for <a href="https://github.com/kasparsd/era">wired (!) nodes over the RS485 physical layer</a> to create switches and sensor nodes for my home automation system:</p>



<h2 class="wp-block-heading">General Notes</h2>



<ul class="wp-block-list"><li>Some controllers don&#8217;t have support for many of the <a href="https://www.mysensors.org/download/serial_api_20#internal">internal message types</a> which are used for node registration <code>I_REGISTRATION_REQUEST</code>, finding node parent IDs <code>I_FIND_PARENT</code>, assigning node IDs <code>I_ID_REQUEST</code>, etc. This prevents nodes that expect those features from working with gateways that don&#8217;t support these features. For example, here are the <a href="https://github.com/tbowmo/node-red-contrib-mysensors/blob/e1d4d53320e49122ab5183d04b64376e1880527f/src/lib/mysensors-controller.ts#L39-L57">message types supported by the Node-RED integration</a> or the supported <a href="https://github.com/theolind/pymysensors/blob/84ec6c6a0f4984ef0064908d27b92d13f30fc7ef/mysensors/handler.py">messages types by the pymysensors library</a> that is also used by the <a href="https://www.home-assistant.io/integrations/mysensors">Home Assistant integration</a>.</li></ul>



<h2 class="wp-block-heading">General Issues</h2>



<ul class="wp-block-list"><li>The version 3 of Arduino core for ESP8266 isn&#8217;t compatible with how MySensors tries to inject itself into the <code>setup()</code> and <code>loop()</code> calls, <a href="https://github.com/mysensors/MySensors/issues/1496">as reported here</a>. There is <a href="https://github.com/mysensors/MySensors/pull/1513">a pull request</a> to fix this.</li></ul>



<h2 class="wp-block-heading">RS485 Transport Layer Issues</h2>



<ul class="wp-block-list"><li>The RS485 transport layer doesn&#8217;t support using <a href="https://www.arduino.cc/en/Reference/softwareSerial">Arduino SoftwareSerial</a> for communicating to the RS485 transceivers. Issue <a href="https://github.com/mysensors/MySensors/issues/1300">reported here</a> and potentially <a href="https://github.com/mysensors/MySensors/pull/1510">fixed by my pull request here</a>. This is probably because originally SoftwareSerial wasn&#8217;t part of the Arduino core and the project had to pull in optimised versions of similar libraries for Atmel microcontrollers.</li><li>The <a href="https://github.com/mysensors/MySensors/issues/1450">node ID discovery/assignment is broken over the RS485 transport layer</a>. There is <a href="https://github.com/mysensors/MySensors/pull/1451">a pull request to fix this</a>.</li></ul>



<h2 class="wp-block-heading">Alternatives to MySensors</h2>



<p>MySensors serial implementation is great because it allows nodes to talk to the network while most of the other protocols require that the communication is initiated by the controller which isn&#8217;t very suitable for scenarios such as switching lights and other real-time events.</p>



<p>Here are some alternative protocols for building &#8220;multi-master&#8221; bus networks using RS485:</p>



<ul class="wp-block-list"><li><a href="https://www.pjon.org/ThroughSerial.php">PJON ThroughSerial</a> defines the communication but doesn&#8217;t define the message types for standard automation events so you need to define your own layer for this.</li><li><a href="https://www.uartbus.eu/">UARTBus</a> which is influenced by KNX but appears to be relatively new.</li></ul>



<p>Do you know of any other protocols that would support this?</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/mysensors-notes/feed</wfw:commentRss>
			<slash:comments>2</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2022/01/era-node-rs485-raspberry-pi-150x150.jpeg" length="7051" type="image/jpeg" />	</item>
		<item>
		<title>WireGuard on MikroTik RouterOS</title>
		<link>https://kaspars.net/blog/wireguard-mikrotik-routeros</link>
					<comments>https://kaspars.net/blog/wireguard-mikrotik-routeros#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Fri, 24 Dec 2021 11:04:47 +0000</pubDate>
				<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[MikroTik]]></category>
		<category><![CDATA[WireGuard]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7871</guid>

					<description><![CDATA[WireGuard can be used for a lot of things: Managing router configuration remotely behind NATed networks such as mobile connections. Connecting to your home network while on the road for home automation and safe internet access. Connecting several networks over the public internet. This post focuses on enabling remote access to Mikrotik routers and the [&#8230;] <a href="https://kaspars.net/blog/wireguard-mikrotik-routeros" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>WireGuard can be used for a lot of things:</p>



<ul class="wp-block-list"><li>Managing router configuration remotely behind NATed networks such as mobile connections.</li><li>Connecting to your home network while on the road for home automation and safe internet access.</li><li>Connecting several networks over the public internet. </li></ul>



<p>This post focuses on enabling remote access to Mikrotik routers and the attached networks. All other setups are outside the scope of this document and can be designed by following this awesome <a href="https://github.com/pirate/wireguard-docs#readme">WireGuard documentation</a>.</p>



<span id="more-7871"></span>



<p>Mikrotik <a href="https://help.mikrotik.com/docs/display/ROS/WireGuard">added official support for WireGuard</a> in version 7 of RouterOS.</p>



<h2 class="wp-block-heading">Peers, Servers and Clients </h2>



<p>With WireGuard everything is a &#8220;peer&#8221; which often causes confusion about how to configure each device on the network.</p>



<p>In practice, most consumer devices today are on some kind of private ISP network and can&#8217;t be addressed from the public internet which is good for security reasons. Only when your device initiates a connection to a remote service such as google.com (a TCP connection), do all of the routers on the way establish a connection path back to your device. This is called <a href="https://en.wikipedia.org/wiki/Network_address_translation">Network address translation</a> or NAT.</p>



<p>That is why most WireGuard networks require at least one &#8220;peer&#8221; with <strong>a real public IP address</strong> that is accessible on the public internet to serve as a gateway. Accessing peers behind NATed connections such as mobile phones and most home internet connections isn&#8217;t possible without connecting through a peer on the public internet unless you want to attempt some kind of <a href="https://www.jordanwhited.com/posts/wireguard-endpoint-discovery-nat-traversal/">UDP hole punching</a>.</p>



<p>This article assumes the following network elements:</p>



<ul class="wp-block-list"><li>One WireGuard peer on the public network serving as a gateway for the rest of the peers.</li><li>One MikroTik router configured as a WireGuard peer.</li></ul>



<h2 class="wp-block-heading">WireGuard Gateway or Server Peer</h2>



<p>This can be any computer with a public IP address running Wireguard. There are <a href="https://kaspars.net/blog/wireguard-raspberry-pi" data-type="post" data-id="7597">many guides</a> for how to build one on DigitalOcean, Linode, AWS or any other cloud hosting provider. Alternatively, use <a href="https://www.google.com/search?q=wireguard+provider">one of the commercial offering</a> but keep in mind that anyone with access to the private keys of your peers can access your WireGuard network.</p>



<p>For our example we&#8217;ll use the following server configuration:</p>



<ul class="wp-block-list"><li>Public IP <code>123.123.123.1</code></li><li>WireGuard <code>ListenPort</code> set to 51820</li><li>WireGuard <code>Address</code> range set to <code>10.100.100.1/24</code> </li><li>WireGuard public key <code>YrXqKGpYLVx829MCcVcb78QFDWIeeWfOyFHmdmZAlF0=</code></li></ul>



<p>Assuming that the server is up and running, let&#8217;s configure the WireGuard peer on RouterOS.</p>



<h2 class="wp-block-heading">MikroTik as a WireGuard Peer</h2>



<p>Under the &#8220;WireGuard&#8221; menu we first create a new WireGuard network interface that defines this MikroTik peer to the rest of the network:</p>



<h3 class="wp-block-heading">Create New WireGuard Interface</h3>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-interfaces.png" alt="List of WireGuard interfaces in RouterOS" class="wp-image-7925" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-interfaces.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-interfaces-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-interfaces-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>List of WireGuard interfaces in RouterOS.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-add-new-interface.png" alt="Mikrotik add new WireGuard interface" class="wp-image-7924" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-add-new-interface.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-add-new-interface-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-add-new-interface-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>Add new WireGuard interface. The private and public keys are generated automatically.</figcaption></figure>



<p>After clicking &#8220;OK&#8221; or &#8220;Apply&#8221; it generates the private and public keys that are required for adding this peer to the network. Note down the public key <code>eLgevqdmOawh1t7srQ+Zs3K5l9o2cf33H/S1UwXeX04=</code> as it is needed later for adding the router to the gateway server.</p>



<h3 class="wp-block-heading">Define Gateway Peer Connection</h3>



<p>Under the &#8220;Peers&#8221; tab add the details for the connection to the gateway server:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-peer-configuration.png" alt="Add WireGuard peers to RouterOS" class="wp-image-7926" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-peer-configuration.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-peer-configuration-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-peer-configuration-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>Add WireGuard peers to RouterOS.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-add-peer-server-gateway.png" alt="Add the WireGuard server peer to RouterOS" class="wp-image-7928" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-add-peer-server-gateway.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-add-peer-server-gateway-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-add-peer-server-gateway-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>Add the WireGuard gateway peer connection to RouterOS.</figcaption></figure>



<p>Public Key, Endpoint and Endpoint Port are all values of our gateway server described above. The only unique value is the &#8220;Allowed Address&#8221; which we assign to <code>10.100.100.2/32</code>. </p>



<p>Optionally configure the &#8220;Persistent Keepalive&#8221; to ensure it keeps the connection information updated with the gateway when the ISP assigned IP changes.</p>



<h3 class="wp-block-heading">Add MikroTik Peer to the Gateway Configuration</h3>



<p>We need to make the Gateway server aware of the newly created peer, so we update its configuration to include the new peer:</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="890" height="600" src="https://kaspars.net/wp-content/uploads/2021/12/wireguard-server-configuration-for-mikrotik-peer.png" alt="WireGuard server configuration for MikroTik peer" class="wp-image-7935" srcset="https://kaspars.net/wp-content/uploads/2021/12/wireguard-server-configuration-for-mikrotik-peer.png 890w, https://kaspars.net/wp-content/uploads/2021/12/wireguard-server-configuration-for-mikrotik-peer-800x539.png 800w" sizes="(max-width: 890px) 100vw, 890px" /><figcaption>WireGuard gateway server configuration for our MikroTik peer.</figcaption></figure></div>


<p>After restarting the WireGuard interface on the gateway server, the MikroTik traffic monitor for the WireGuard interface should start showing keep-alive and handshake data flowing:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-interface-traffic.png" alt="WireGuard network interface traffic reported in RouterOS" class="wp-image-7936" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-interface-traffic.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-interface-traffic-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-interface-traffic-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>WireGuard network interface traffic reported in RouterOS.</figcaption></figure>



<p>At this point the MikroTik router should be able to ping the WireGuard network:</p>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ping.png" alt="WireGuard ping in RouterOS" class="wp-image-7937" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ping.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ping-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ping-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>RouterOS pinging the WireGuard gateway peer.</figcaption></figure>



<p>However, nothing has been configured about how the newly created interface can be reached from the outside or inside the MikroTik network.</p>



<p>To make the WireGuard network accessible from the local <code>192.168.88.0/24</code> network, we must first define its address range and routing information.</p>



<h3 class="wp-block-heading">Define WireGuard Peer IP and Routes</h3>



<p>To make the router aware of its new IP address on the WireGuard network, go to &#8220;IP &gt; Addresses&#8221; and add the address <code>10.100.100.2/24</code>:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-ip-addresses.png" alt="Add WireGuard address route in RouterOS." class="wp-image-7929" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-ip-addresses.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-ip-addresses-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-ip-addresses-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>Add WireGuard address range to RouterOS.</figcaption></figure>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ip-address-configuration.png" alt="WireGuard IP address route in RouterOS" class="wp-image-7930" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ip-address-configuration.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ip-address-configuration-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ip-address-configuration-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>Add WireGuard IP address <code>10.100.100.2/24</code> to RouterOS.</figcaption></figure>



<p>Under &#8220;Interface&#8221; select the newly created WireGuard interface.</p>



<p>Notice how this automatically provisioned a new network route for <code>10.100.100.0/24</code> under &#8220;IP &gt; Routes&#8221;:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1500" height="921" src="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ip-route.png" alt="WireGuard route in RouterOS" class="wp-image-7931" srcset="https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ip-route.png 1500w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ip-route-800x491.png 800w, https://kaspars.net/wp-content/uploads/2021/12/mikrotik-wireguard-ip-route-1024x629.png 1024w" sizes="(max-width: 1500px) 100vw, 1500px" /><figcaption>WireGuard route in RouterOS.</figcaption></figure>



<h2 class="wp-block-heading">Define WireGuard Network Firewall Rules</h2>



<p>Finally, you need to add the firewall rules to match your desired configuration and access restrictions. See <a href="https://help.mikrotik.com/docs/display/ROS/WireGuard#WireGuard-Applicationexamples">the RouterOS documentation page</a> for a few examples.</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/wireguard-mikrotik-routeros/feed</wfw:commentRss>
			<slash:comments>2</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2020/08/wireguard-routing-mikrotik-150x150.png" length="1864" type="image/png" />	</item>
		<item>
		<title>Using Mini Split Heat Pumps for Space and Hot Water Heating</title>
		<link>https://kaspars.net/blog/mini-split-space-hot-water-heating</link>
					<comments>https://kaspars.net/blog/mini-split-space-hot-water-heating#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 24 Oct 2021 08:59:14 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Passive House]]></category>
		<category><![CDATA[Building Science]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7897</guid>

					<description><![CDATA[Mini split air conditioners are great little air-source heat pumps that can work in the reverse and provide heating to the building, too. For highly insulated houses built according to the Passive House standard they technically provide enough power to support both space and hot water heating. Passive houses require a heating load of only [&#8230;] <a href="https://kaspars.net/blog/mini-split-space-hot-water-heating" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>Mini split air conditioners are great little air-source heat pumps that can work in the reverse and provide heating to the building, too. For highly insulated houses built according to the <a href="https://passipedia.org/basics/building_physics_-_basics/heating_load">Passive House standard</a> they technically provide enough power to support both space and hot water heating.</p>



<span id="more-7897"></span>



<p>Passive houses require a heating load of only 10W per square meter or 15kWh of total energy per square meter per year to condition the inside air. That means that technically a 100m2 house requires only a 1kW heater which can be easily served with the smallest mini split units on the market that have a total heating/cooling power of 3kW.</p>



<p>Wouldn&#8217;t it be great if the remaining 2kW could be used for heating the hot water? However, such units are pretty much non-existent or they are way over-sized and expensive for the needs of a highly efficient house.</p>



<p>So I&#8217;m starting a project to add an additional 3kW plate heat exchanger to the indoor gas/fluid line of the cheapest mini-split air conditioner with the heating functionality, to transfer the heat to another fluid loop passing through a 1m2 heat exchanger of a 100 liter hot water tank:</p>



<figure class="wp-block-image alignwide size-full"><img decoding="async" src="https://kaspars.net/wp-content/uploads/2021/10/mini-split-space-hot-water-heating.svg" alt="Mini Split air conditioner for space and hot water heating" class="wp-image-7899"/><figcaption>Mini-split air conditioner heating another fluid loop through a plate heat exchanger (with bold outline) that is connected to a hot water tank.</figcaption></figure>



<h2 class="wp-block-heading" id="design-questions">Design Questions</h2>



<ul class="wp-block-list"><li>Does it need a bypass for the plate heat exchanger to decouple the water tank from the air-con while the unit is in the cooling mode? Or is it sufficient to just turn off the circulation pump for the hot water tank heat exchanger?</li><li>What are the flow rates for the hot water tank heat exchanger loop with a 1m2 tank heat exchanger surface?</li></ul>



<h2 class="wp-block-heading" id="existing-solutions">Existing Solutions</h2>



<p>There are several air-source heat pumps that support hot water heating:</p>



<ul class="wp-block-list"><li>Gree Versati III</li><li>Daikin Altherma</li></ul>



<p>Note that none of them enable space heating via a refrigerant-to-air heat exchanger found in traditional mini splits.</p>



<h2 class="wp-block-heading" id="components">Proposed Components</h2>



<h3 class="wp-block-heading" id="1-mini-split-with-heating-support">1. Mini Split with Heating Support</h3>



<p><a href="https://mideauk.co.uk/products/blanc-series/">Midea Blanc</a>, <a href="https://alpicair.com/en-gb/products/residential-air-conditioners/wall-mounted-split-systems/premium-pro-series">AlpicAir Premium Pro</a>, Gree Lomo Nordic or similar costing around EUR 500. Requires knowledge of the communications protocol with the outside unit to control the device without relying on the inside unit.</p>



<p>I ended up getting the <a href="https://kaspars.net/blog/gree-amber-nordic-gwh09yd-s6dba1" data-type="post" data-id="7959">Gree Amber Nordic GWH09YD-S6DBA1</a> which works well down to -30℃ (-22℉).   </p>



<h3 class="wp-block-heading" id="2-hot-water-tank-with-heat-exchanger">2. Hot Water Tank with Heat Exchanger</h3>



<p><a href="https://kospel.pl/en/products/76-cylinders/1348-swk-termo-top-2.html">Kospel SWK100</a> hot water tank (around EUR 400) with an internal heat exchanger loop area of 1m2 or more.</p>



<h3 class="wp-block-heading" id="3-plate-heat-exchanger">3. Plate Heat Exchanger</h3>



<p><a href="http://www.ekoair.lv/en/Heat-exchangers/NB-EN/_NB-238/">Eko Air NB-238</a> brazed plate heat exchanger (around EUR 175) with support for 3MPa (30bar) pressure and 3/8″ SAE flare connectors for the gas line and G3/4<meta charset="utf-8"/>″ connector for the water loop. The particular unit has a maxium float rate of 5 m3/h.</p>



<h3 class="wp-block-heading" id="4-circulation-pump-for-the-hot-water-heating">4. Circulation Pump for the Hot Water Heating</h3>



<p><a href="https://wilo.com/gb/en/Products-and-expertise/en/products-expertise/wilo-yonos-pico">Wilo-Yonos PICO circulation pump</a> (around EUR 130) with support for variable flow rate. Ideally with electronically adjustable flow rate.</p>



<h3 class="wp-block-heading" id="5-pipes-expansion-tanks-valves-and-connectors">5. Pipes, Expansion Tanks, Valves and Connectors</h3>



<p>TODO: List them all.</p>



<h2 class="wp-block-heading" id="next-steps">Next Steps</h2>



<ul class="wp-block-list"><li>✅ Purchase Eko Air NB-238 heat exchanger with 30 plates.</li><li>✅ Purchase and <a href="https://kaspars.net/blog/gree-amber-nordic-gwh09yd-s6dba1" data-type="post" data-id="7959">reverse-engineer Gree Amber Nordic GWH09YD-S6DBA1</a> air-source heat pump.</li><li>TODO: Calculate the heat exchanger area for the hot water tank to match the power of the heat-pump.</li></ul>



<p>Last updated: February 13, 2022.</p>



<h2 class="wp-block-heading" id="suggested-reading">Suggested Reading</h2>



<ul class="wp-block-list"><li><a href="https://www.hpacmag.com/tech-pulse/why-air-to-water-heat-pumps-are-a-market-opportunity-for-hydronic-professionals/">Why air to water heat pumps are a market opportunity for hydronic professionals</a> videos <a href="https://www.youtube.com/watch?v=o_TjkyUuHeY">part 1</a> and <a href="https://www.youtube.com/watch?v=PU3uy3PisbM">part 2</a> by John Siegenthaler.</li></ul>



<h2 class="wp-block-heading">Existing Solutions</h2>



<h3 class="wp-block-heading">AHUcom</h3>



<p>A few month after I started researching this idea, I found <a href="http://gree.at/uploads/navody/gree_ahu_com_r410_1.03_defrost_users_manual_2019.pdf">AHUcom which does the following</a>:</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow"><p>AHUcom electronic communication module allows you to connect GREE brand outdoor unit from U-Match Series 5 to any air handling units equipped with direct expansion air exchanger and drive it via any control system.</p></blockquote>



<p>The connection with the outdoor unit is happening via two wires labeled <code>A</code> and <code>B</code> and it is not clear if those used for pure RS485 or something custom.</p>



<h3 class="wp-block-heading">Daikin Multi+ (Multiplus)</h3>



<p><a href="#comment-330274">Ed in the comments</a> found <a href="https://www.daikin.eu/en_us/product-group/air-to-air-heat-pumps/multiplus.html">Daikin Multi+</a> which has an indoor hot water tank (EKHWET-BV3, <a href="https://kaspars.net/wp-content/uploads/2022/10/EKHWET-BV3-Installation-manual_4PEN680074-1B-english.pdf">installation manual PDF</a>) connected directly to the refrigerant loop of the outdoor unit along with number of mini-split indoor units.</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/mini-split-space-hot-water-heating/feed</wfw:commentRss>
			<slash:comments>15</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2021/10/mini-split-space-hot-water-heating-150x150.png" length="5042" type="image/png" />	</item>
		<item>
		<title>Notes on Lollette LE3U PLC</title>
		<link>https://kaspars.net/blog/le3u-plc</link>
					<comments>https://kaspars.net/blog/le3u-plc#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 11 Sep 2021 14:47:34 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7875</guid>

					<description><![CDATA[Lollette LE3U is a &#8220;copy&#8221; of the Mitsubishi FX3U PLC for $60 on AliExpress while the original costs around $1000. All configuration is done using Mitsubishi&#8217;s proprietary software GX Developer or GX Works2 which cost another $500 but have a 60-day free trial available online. It features 14 digital inputs, 6 analog inputs, 2 analog [&#8230;] <a href="https://kaspars.net/blog/le3u-plc" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2560" height="1707" src="https://kaspars.net/wp-content/uploads/2021/09/lollette-le3u-plc-raspberry-pi-rs485-scaled.jpeg" alt="Raspberry Pi connected to Lollette LE3U" class="wp-image-7888" srcset="https://kaspars.net/wp-content/uploads/2021/09/lollette-le3u-plc-raspberry-pi-rs485-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2021/09/lollette-le3u-plc-raspberry-pi-rs485-800x533.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/09/lollette-le3u-plc-raspberry-pi-rs485-1024x683.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/09/lollette-le3u-plc-raspberry-pi-rs485-1536x1024.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/09/lollette-le3u-plc-raspberry-pi-rs485-2048x1365.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption>Raspberry Pi connected to Lollette LE3U over Modbus RTU (RS485).</figcaption></figure>



<ul class="wp-block-list"><li><a href="https://www.lollette.com/le3u-plc-controller" data-type="surl">Lollette LE3U</a> is a &#8220;copy&#8221; of the <a href="https://www.mitsubishielectric.com.au/2187.htm">Mitsubishi FX3U PLC</a> for <a href="https://kaspars.net/go/lollette-le3u-plc" data-type="surl" data-id="7877">$60 on AliExpress</a> while the original costs around $1000.</li><li>All configuration is done using Mitsubishi&#8217;s proprietary software <a href="https://us.mitsubishielectric.com/fa/en/products/controllers/programmable-controllers-melsec/engineering-software/other-engineering-softwares/gx-developer/gx-developer">GX Developer</a> or <a href="https://us.mitsubishielectric.com/fa/en/products/controllers/programmable-controllers-melsec/engineering-software/gx-works/gx-works2">GX Works2</a> which cost another $500 but have a <a href="https://www.mitsubishifa.co.th/en/Software-Detail.php?id=MjM=&amp;vs=trial">60-day free trial available online</a>.</li><li>It features 14 digital inputs, 6 analog inputs, 2 analog output and 10 relay outputs. </li><li>The RS485 port is not configured by default so you can&#8217;t control any of the relays or read input values without first uploading new configuration program.</li><li>Programming is done using <a href="https://en.wikipedia.org/wiki/Ladder_logic">visual Ladder language</a> which is somewhat confusing to get started until you realise that it&#8217;s pretty much a mapping of input triggers, registers and their values. <ul><li>Each physical input maps to a register which can then change another output register depending on certain rules.</li><li>Configuring parameters is &#8220;moving&#8221; 1-byte or 2-byte strings into registers.</li></ul></li></ul>



<h2 class="wp-block-heading">Configure RS485 Modbus</h2>



<p>To configure the device as a Modbus &#8220;slave&#8221;, hook into the <code>M8002</code> event and configure the following registers:</p>



<ul class="wp-block-list"><li><code>D8120</code> with the details for the serial protocol. Set it to <code>H4081</code> to enable Modbus RTU slave protocol with 8 data bits, 0 parity bits, 1 stop bit and a 9600bps transfer rate.</li><li><code>D8121</code> for the device ID or station number. Set to <code>K1</code> where <code>1</code> is the device ID.</li><li><code>D8129</code> for the communication timeout (optional). Set to <code>K100</code> where <code>100</code> is the timeout in milliseconds.</li></ul>



<p>The 4-byte values are entered as a string of matching hex values starting from the lowest bit (please ignore the actual register values since this is from a different device):</p>



<div class="wp-block-image"><figure class="aligncenter size-full"><img loading="lazy" decoding="async" width="644" height="264" src="https://kaspars.net/wp-content/uploads/2021/09/hex-value-notation.png" alt="" class="wp-image-7879"/><figcaption>Example of register value bit mapping to <code>H</code> notation.</figcaption></figure></div>



<p>See these two videos for detailed instructions:</p>



<ul class="wp-block-list"><li><a href="https://www.youtube.com/watch?v=cPuX4ga1Ods">How to Configure PLC as a Modbus Slave and how to read write the data from PLC through Modbus</a></li><li><a href="https://www.youtube.com/watch?v=3VcyOw6Gb1M">Control FX3U PLC with ESP32 Microcontroller Part 1 (PLC I/O Control)</a> and <a href="https://www.youtube.com/watch?v=Jtce-PU6fpk">Part 2</a></li></ul>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/le3u-plc/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2021/09/lollette-le3u-plc-raspberry-pi-rs485-150x150.jpeg" length="7128" type="image/jpeg" />	</item>
		<item>
		<title>Remote Access Protocol for Reolink Battery Powered Cameras</title>
		<link>https://kaspars.net/blog/reolink-battery-camera-remote-protocol</link>
					<comments>https://kaspars.net/blog/reolink-battery-camera-remote-protocol#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 24 Jul 2021 07:17:33 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7847</guid>

					<description><![CDATA[Update: The protocol is now well understood and supported by the Neolink RTSP bridge software and this fork of the Camera Proxy project. Battery powered cameras from Reolink offer remote viewing and management even when cameras are behind mobile network data connections. Based on this research by Nozomi Networks Labs and the camera_proxy project, I&#8217;ve [&#8230;] <a href="https://kaspars.net/blog/reolink-battery-camera-remote-protocol" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p><strong>Update:</strong> The protocol is now <a href="https://github.com/thirtythreeforty/neolink/pull/199">well understood</a> and supported by the <a href="https://github.com/thirtythreeforty/neolink">Neolink RTSP bridge software</a> and <a href="https://github.com/vherrlein/camera_proxy/tree/develop">this fork</a> of the <a href="https://github.com/jdillenkofer/camera_proxy">Camera Proxy project</a>.</p>



<p>Battery powered cameras from Reolink offer remote viewing and management even when cameras are behind mobile network data connections. Based on <a href="https://www.nozominetworks.com/blog/new-reolink-p2p-vulnerabilities-show-iot-security-camera-risks/">this research by Nozomi Networks Labs</a> and the <a href="https://github.com/jdillenkofer/camera_proxy">camera_proxy project</a>, I&#8217;ve been able to capture and inspect the communication protocol used specifically by the Argus 3 camera.</p>



<span id="more-7847"></span>



<p>I used the version 8.2.6 of the <a href="https://reolink.com/software-and-manual/">Reolink client for MacOS</a> (which is an Electron app) and Wireshark to capture and decode the traffic between the software and the internet. The decoding of their proprietary packets was possible thanks to the <a href="https://github.com/jdillenkofer/camera_proxy/blob/af9a170d3a8db831318a1aafcb2bf097ab62fd40/wireshark-dissector.lua">Baichuan/Reolink proprietary IP camera protocol dissector for Wireshark</a> bundled with the camera_proxy project.</p>



<p>In the description bellow we&#8217;ll use the following addresses and names to describe the network participants:</p>



<ul class="wp-block-list"><li><code></code><code>10.0.0.1</code> is the local IP of the app connecting to the camera remotely.</li><li><code>7.0.0.1</code> is the public IP of the app on the internet.</li><li><code>196.0.0.1</code> is the local IP of the camera.</li><li><code>6.0.0.1</code> is the public IP of the camera on the internet.</li><li><code>p2p.reolink.com</code> is the hostname of the Reolink P2P server.</li><li><code>15.237.112.14</code> is the IP address of the Reolink P2P server.</li><li><code>123456789</code> is the Reolink UID (unique identifier) of the camera.</li></ul>



<p>The Reolink client app uses the publicly accesible Reolink relay to establish a direct connection to the camera for remote management and video/audio communication. <a href="https://bford.info/pub/net/p2pnat/">This article by Bryan Ford</a> is the best explanation of network hole punching for peer-to-peer (P2P) access.</p>



<p>The communication uses UDP packets with special payload that contain the information to establish direct connection between the client and the camera. The payload is encoded to avoid network address translation (NAT) layers changing the IP addresses included in the payload. The encoding uses <a href="https://github.com/jdillenkofer/camera_proxy/blob/af9a170d3a8db831318a1aafcb2bf097ab62fd40/src/baichuan_udp_layer.py#L78-L106">a shared secret key and some additional transformations</a>.</p>



<p>The actual magic happens through the dynamic port numbers allocated by the routers between both communicating parties and the ability to route packets back to the originating device by re-using those port numbers. It is likely that the camera sends regular UDP pings to the public P2P server to keep an active connection with the server to enable incoming connections.</p>



<h2 class="wp-block-heading">1. App Connects to the P2P Server</h2>



<p>The client app sends a UDP packet from local port <code>16577</code> to port <code>9999</code> of <code>p2p.reolink.com</code> with the following XML body (encoded using the algorithm mentioned above). It also sends the same packet to the local broadcast address <code>255.255.255.255</code> of the local network which allows local cameras to respond, too:</p>



<pre class="wp-block-code"><code>&lt;P2P&gt;
    &lt;C2M_Q&gt;
        &lt;uid&gt;123456789&lt;/uid&gt;
        &lt;p&gt;MAC&lt;/p&gt;
    &lt;/C2M_Q&gt;
&lt;/P2P&gt;</code></pre>



<p>where <code>123456789</code> is the camera UID <code>&lt;uid&gt;</code> and <code>MAC</code> is the platform <code>&lt;p&gt;</code> identifier of the connecting client. In cases where the client is connecting to a Reolink DVR (digital video recorder) or NVR (network video recorder) instead of a camera, the wrapping XML element is <code>&lt;D2M_Q&gt;</code> instead of <code>&lt;<meta charset="utf-8"/>C2M_Q&gt;</code>.</p>



<p>It appears to send these packet to all IP addresses of the <code>p2p.reolink.com</code> name server A records.</p>



<p>One of the P2P servers responds with the following payload:</p>



<pre class="wp-block-code"><code>&lt;P2P&gt;
    &lt;M2C_Q_R&gt;
        &lt;reg&gt;
            &lt;ip&gt;15.237.112.14&lt;/ip&gt;
            &lt;port&gt;58200&lt;/port&gt;
        &lt;/reg&gt;
        &lt;relay&gt;
            &lt;ip&gt;15.237.112.14&lt;/ip&gt;
            &lt;port&gt;58100&lt;/port&gt;
        &lt;/relay&gt;
        &lt;log&gt;
            &lt;ip&gt;15.237.112.14&lt;/ip&gt;
            &lt;port&gt;57850&lt;/port&gt;
        &lt;/log&gt;
        &lt;t&gt;
            &lt;ip&gt;15.237.112.14&lt;/ip&gt;
            &lt;port&gt;9996&lt;/port&gt;
        &lt;/t&gt;
        &lt;timer/&gt;
        &lt;retry/&gt;
        &lt;mtu&gt;1350&lt;/mtu&gt;
        &lt;debug&gt;251658240&lt;/debug&gt;
        &lt;ac&gt;-1700607721&lt;/ac&gt;
        &lt;rsp&gt;0&lt;/rsp&gt;
    &lt;/M2C_Q_R&gt;
&lt;/P2P&gt;</code></pre>



<p>while other IP addresses of the P2P server respond with:</p>



<pre class="wp-block-code"><code>&lt;P2P&gt;
    &lt;M2C_Q_R&gt;
        &lt;devinfo&gt;
            &lt;type/&gt;
            &lt;mac/&gt;
            &lt;bat&gt;0&lt;/bat&gt;
            &lt;qr&gt;0&lt;/qr&gt;
        &lt;/devinfo&gt;
        &lt;rsp&gt;-3&lt;/rsp&gt;
    &lt;/M2C_Q_R&gt;
&lt;/P2P&gt;</code></pre>



<p>Notice how the XML element name in the response <code>&lt;M2C_Q_R&gt;</code> is the inverse of the request element name <code>&lt;C2M_Q&gt;</code> plus <code>_R</code> which I imagine stands for response or reply.</p>



<p>The response contains the IP addresses and port numbers of the following services:</p>



<ul class="wp-block-list"><li><code>&lt;reg&gt;</code> for registration</li><li><code>&lt;relay&gt;</code> for relay</li><li><code>&lt;log&gt;</code> for logging</li><li><code>&lt;t&gt;</code> for telemetry (?)</li></ul>



<p>and some other information which I&#8217;m not sure how is used.</p>



<h2 class="wp-block-heading">2. Client App Registers with the P2P Server</h2>



<p>The client app appears to first make a TCP connection to IP <code>15.237.112.14</code> and port <code>9996</code> of the <code>&lt;t&gt;</code> element in the XML response to possibly obtain a shared secret key to use for further connection. I haven&#8217;t been able to decode this TLS communication because the client appears to ignore system proxy setting to allow capturing and intercepting the TLS traffic.</p>



<p>Then it sends an encoded UDP packet the <code>&lt;reg&gt;</code> endpoint <code>15.237.112.14:58200</code> with the following payload:</p>



<pre class="wp-block-code"><code>&lt;P2P&gt;
    &lt;C2R_C&gt;
        &lt;uid&gt;12345678&lt;/uid&gt;
        &lt;cli&gt;
            &lt;ip&gt;10.0.0.1&lt;/ip&gt;
            &lt;port&gt;10693&lt;/port&gt;
        &lt;/cli&gt;
        &lt;relay&gt;
            &lt;ip&gt;15.237.112.14&lt;/ip&gt;
            &lt;port&gt;58100&lt;/port&gt;
        &lt;/relay&gt;
        &lt;cid&gt;693000&lt;/cid&gt;
        &lt;debug&gt;251658240&lt;/debug&gt;
        &lt;family&gt;4&lt;/family&gt;
        &lt;p&gt;MAC&lt;/p&gt;
        &lt;r&gt;3&lt;/r&gt;
    &lt;/C2R_C&gt;
&lt;/P2P&gt;</code></pre>



<p>where <code><meta charset="utf-8"/>12345678</code> is the UID of the camera we&#8217;re connecting to with its local IP <code>10.0.0.1</code> and local port number <code>10693</code>. <strong>TODO</strong> Confirm if the value of <code>&lt;CID&gt;</code> was retrieved during the TCP exchnage or generated randomly by the client.</p>



<p>The P2P registration endpoint <code>15.237.112.14:58200</code> responds with the following UDP payload:</p>



<pre class="wp-block-code"><code>&lt;P2P&gt;
    &lt;R2C_T&gt;
        &lt;dev&gt;
            &lt;ip&gt;196.0.0.1&lt;/ip&gt;
            &lt;port&gt;18371&lt;/port&gt;
        &lt;/dev&gt;
        &lt;dmap&gt;
            &lt;ip&gt;6.0.0.1&lt;/ip&gt;
            &lt;port&gt;18371&lt;/port&gt;
        &lt;/dmap&gt;
        &lt;sid&gt;99933377&lt;/sid&gt;
        &lt;cid&gt;555777&lt;/cid&gt;
        &lt;rsp&gt;0&lt;/rsp&gt;
    &lt;/R2C_T&gt;
&lt;/P2P&gt;</code></pre>



<p>where <code>196.0.0.1:<meta charset="utf-8"/>18371</code> is the IP and port number of the UDP keep-alive connection of the camera on its local network and <code>6.0.0.1:18371</code> is the public IP and port, while <code>&lt;sid&gt;</code> and <code>&lt;cid&gt;</code> are the two keys used to establish the connection.</p>



<h2 class="wp-block-heading">App Connects to the Camera</h2>



<p>Now the app sends a UDP packet directly to <code>6.0.0.1:18371</code> which is the the public IP and port number of the camera from the <code>&lt;dmap&gt;</code> element:</p>



<pre class="wp-block-code"><code>&lt;P2P&gt;
    &lt;C2D_T&gt;
        &lt;sid&gt;<meta charset="utf-8"/>99933377&lt;/sid&gt;
        &lt;conn&gt;map&lt;/conn&gt;
        &lt;cid&gt;<meta charset="utf-8"/>555777&lt;/cid&gt;
        &lt;mtu&gt;1350&lt;/mtu&gt;
    &lt;/C2D_T&gt;
&lt;/P2P&gt;</code></pre>



<p>and the camera responds with:</p>



<pre class="wp-block-code"><code>&lt;P2P&gt;
    &lt;D2C_T&gt;
        &lt;sid&gt;<meta charset="utf-8"/>99933377&lt;/sid&gt;
        &lt;conn&gt;map&lt;/conn&gt;
        &lt;cid&gt;<meta charset="utf-8"/>555777&lt;/cid&gt;
        &lt;did&gt;576&lt;/did&gt;
    &lt;/D2C_T&gt;
&lt;/P2P&gt;</code></pre>



<p>where <code>&lt;did&gt;</code> is the only unique value received from the camera.</p>



<hr class="wp-block-separator"/>



<p>To be continued&#8230;</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/reolink-battery-camera-remote-protocol/feed</wfw:commentRss>
			<slash:comments>3</slash:comments>
		
		
			</item>
		<item>
		<title>When Tuya SM-AW713Z (Zigbee) is Actually SM-AW713 (WiFi)</title>
		<link>https://kaspars.net/blog/tuya-sm-aw713-zigbee-wifi</link>
					<comments>https://kaspars.net/blog/tuya-sm-aw713-zigbee-wifi#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 01 May 2021 18:47:46 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[ESP8266]]></category>
		<category><![CDATA[Tasmota]]></category>
		<category><![CDATA[Tuya]]></category>
		<category><![CDATA[Zigbee]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7815</guid>

					<description><![CDATA[I bought this UseeLink water/gas valve which according to the casing was supposed to be SM-AW713Z with the Zigbee radio but is actually SM-AW713 with a Tuya TYWE3S WiFi radio. No wonder it wasn&#8217;t being discovered by my Zigbee2mqtt radio! Flashing Tasmota Firmware After soldering the wires for the UART connection to the module according [&#8230;] <a href="https://kaspars.net/blog/tuya-sm-aw713-zigbee-wifi" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>I bought <a href="https://kaspars.net/go/zigbee-smart-valve">this UseeLink water/gas valve</a> which according to the casing was supposed to be SM-AW713Z with the Zigbee radio but is actually SM-AW713 with a <a href="https://tasmota.github.io/docs/devices/TYWE3S/">Tuya TYWE3S WiFi radio</a>. No wonder it wasn&#8217;t being discovered by my Zigbee2mqtt radio!</p>



<span id="more-7815"></span>



<figure class="wp-block-gallery alignwide columns-1 is-cropped wp-block-gallery-4 is-layout-flex wp-block-gallery-is-layout-flex"><ul class="blocks-gallery-grid"><li class="blocks-gallery-item"><figure><a href="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case.jpeg"><img loading="lazy" decoding="async" width="2000" height="2000" src="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case.jpeg" alt="" data-id="7819" data-full-url="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case.jpeg" data-link="https://kaspars.net/?attachment_id=7819" class="wp-image-7819" srcset="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case.jpeg 2000w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713Z-case-120x120.jpeg 120w" sizes="(max-width: 2000px) 100vw, 2000px" /></a><figcaption class="blocks-gallery-item__caption">Incorrect case stating SM-AW713Z.</figcaption></figure></li><li class="blocks-gallery-item"><figure><a href="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect.jpeg"><img loading="lazy" decoding="async" width="2000" height="2000" src="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect.jpeg" alt="" data-id="7817" data-full-url="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect.jpeg" data-link="https://kaspars.net/?attachment_id=7817" class="wp-image-7817" srcset="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect.jpeg 2000w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-packaging-incorrect-120x120.jpeg 120w" sizes="(max-width: 2000px) 100vw, 2000px" /></a><figcaption class="blocks-gallery-item__caption">Incorrect package stating SM-AZ713.</figcaption></figure></li><li class="blocks-gallery-item"><figure><a href="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb.jpeg"><img loading="lazy" decoding="async" width="2000" height="2000" src="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb.jpeg" alt="" data-id="7822" data-full-url="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb.jpeg" data-link="https://kaspars.net/?attachment_id=7822" class="wp-image-7822" srcset="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb.jpeg 2000w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb-120x120.jpeg 120w" sizes="(max-width: 2000px) 100vw, 2000px" /></a><figcaption class="blocks-gallery-item__caption">SM-AW713 V4.0 with TYWE3S wifi radio.</figcaption></figure></li><li class="blocks-gallery-item"><figure><a href="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio.jpeg"><img loading="lazy" decoding="async" width="2000" height="2000" src="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio.jpeg" alt="" data-id="7820" data-full-url="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio.jpeg" data-link="https://kaspars.net/?attachment_id=7820" class="wp-image-7820" srcset="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio.jpeg 2000w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-wifi-radio-120x120.jpeg 120w" sizes="(max-width: 2000px) 100vw, 2000px" /></a><figcaption class="blocks-gallery-item__caption">Valve motor with two micro switches at both states (open/close) and TYWE3S radio.</figcaption></figure></li><li class="blocks-gallery-item"><figure><a href="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor.jpeg"><img loading="lazy" decoding="async" width="2000" height="2000" src="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor.jpeg" alt="" data-id="7821" data-full-url="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor.jpeg" data-link="https://kaspars.net/?attachment_id=7821" class="wp-image-7821" srcset="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor.jpeg 2000w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-motor-120x120.jpeg 120w" sizes="(max-width: 2000px) 100vw, 2000px" /></a><figcaption class="blocks-gallery-item__caption">SM-AW713 valve motor and electronics.</figcaption></figure></li><li class="blocks-gallery-item"><figure><a href="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-radio-pcb.jpeg"><img loading="lazy" decoding="async" width="2000" height="1333" src="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-radio-pcb.jpeg" alt="" data-id="7818" data-full-url="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-radio-pcb.jpeg" data-link="https://kaspars.net/?attachment_id=7818" class="wp-image-7818" srcset="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-radio-pcb.jpeg 2000w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-radio-pcb-800x533.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-radio-pcb-1024x682.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-radio-pcb-1536x1024.jpeg 1536w" sizes="(max-width: 2000px) 100vw, 2000px" /></a><figcaption class="blocks-gallery-item__caption">Tuya SM-AW713 with TYWE3S radio and controller board.</figcaption></figure></li></ul></figure>



<h2 class="wp-block-heading">Flashing Tasmota Firmware</h2>



<p>After soldering the wires for the UART connection to the module according to the <a href="https://tasmota.github.io/docs/devices/TYWE3S/">pinout of the TYWE3S module</a>, I was able to flash the Tasmota firmware onto it <a href="https://tasmota.github.io/docs/Getting-Started/">according to these instructions</a>.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="2000" height="2000" src="https://kaspars.net/wp-content/uploads/2021/05/tasmota-tuya-sm-aw713.jpeg" alt="USB to serial UART module connected to the Tuya SM-AW713 valve" class="wp-image-7832" srcset="https://kaspars.net/wp-content/uploads/2021/05/tasmota-tuya-sm-aw713.jpeg 2000w, https://kaspars.net/wp-content/uploads/2021/05/tasmota-tuya-sm-aw713-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/05/tasmota-tuya-sm-aw713-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/05/tasmota-tuya-sm-aw713-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2021/05/tasmota-tuya-sm-aw713-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/05/tasmota-tuya-sm-aw713-120x120.jpeg 120w" sizes="(max-width: 2000px) 100vw, 2000px" /><figcaption>USB to serial UART module connected to the TYWE3S module in the Tuya SM-AW713 valve. </figcaption></figure>



<p>I used the <a href="https://templates.blakadder.com/jinvoo_SM-AW713.html">Jinvoo SM-AW713 Valve device template</a> to configure the device with Tasmota version 9.4:</p>



<pre class="wp-block-code"><code>{"NAME":"Jinvoo Valve v2","GPIO":&#91;0,0,0,0,52,53,0,0,21,17,0,0,0],"FLAG":0,"BASE":1}</code></pre>



<p>It now operates exactly like the original but doesn&#8217;t require the Tuya cloud connection or app.</p>



<figure class="wp-block-image alignwide size-large"><img loading="lazy" decoding="async" width="2000" height="1333" src="https://kaspars.net/wp-content/uploads/2021/05/sm-aw713-tasmota-firmware-1024x682.jpeg" alt="" class="wp-image-7836" srcset="https://kaspars.net/wp-content/uploads/2021/05/sm-aw713-tasmota-firmware-1024x682.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/05/sm-aw713-tasmota-firmware-800x533.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/05/sm-aw713-tasmota-firmware-1536x1024.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/05/sm-aw713-tasmota-firmware.jpeg 2000w" sizes="(max-width: 2000px) 100vw, 2000px" /><figcaption>Tuya SM-AW713 valve running the Tasmota firmware.</figcaption></figure>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/tuya-sm-aw713-zigbee-wifi/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2021/05/SM-AW713-pcb-150x150.jpeg" length="6282" type="image/jpeg" />	</item>
		<item>
		<title>Zehnder ComfoSpot 50 Communication Protocol</title>
		<link>https://kaspars.net/blog/zehnder-comfospot-protocol</link>
					<comments>https://kaspars.net/blog/zehnder-comfospot-protocol#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 28 Mar 2021 14:13:31 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Passive House]]></category>
		<category><![CDATA[Building Science]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7792</guid>

					<description><![CDATA[This is an attempt at reverse engineering the communication protocol used by the Zehnder ComfoSpot 50 ventilation unit with heat recovery. It has the following control board: The &#8220;BUS X7&#8221; has four pins labeled +, A, B and - which are used for connecting to an external ComfoLED control panel which replicates the functionality of [&#8230;] <a href="https://kaspars.net/blog/zehnder-comfospot-protocol" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>This is an attempt at reverse engineering the communication protocol used by the <a href="https://www.international.zehnder-systems.com/products-and-systems/comfosystems/zehnder-comfospot-50">Zehnder ComfoSpot 50</a> ventilation unit with heat recovery.</p>



<span id="more-7792"></span>



<p>It has the following control board:</p>



<figure class="wp-block-image alignfull size-full"><img loading="lazy" decoding="async" width="2560" height="1920" src="https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-pcb-controller-scaled.jpeg" alt="" class="wp-image-7797" srcset="https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-pcb-controller-scaled.jpeg 2560w, https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-pcb-controller-800x600.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-pcb-controller-1024x768.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-pcb-controller-1536x1152.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-pcb-controller-2048x1536.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption>The control board of Zehnder Comfospot 50. Connector &#8220;SENSOR X8&#8221; is used for the temperature and humidity sensor while &#8220;BUS X7&#8221; is for the external control panel.</figcaption></figure>



<p>The &#8220;BUS X7&#8221; has four pins labeled <code>+</code>, <code>A</code>, <code>B</code> and <code>-</code> which are used for connecting to an external ComfoLED control panel which replicates the functionality of the built-in control panel. The 8-pin chip below the &#8220;BUS X7&#8221; is a <a href="https://www.maximintegrated.com/en/products/interface/transceivers/MAX487.html">MAX487 RS-485/RS-422 transceiver</a>.</p>



<p>It appears to be using the UART protocol at 9600 baud rate, <strong>9 data bits</strong>, 1 stop bit and 0 parity bits. The one extra bit is used to indicate an <strong>address byte</strong> and a <strong>data byte</strong> in a <a href="https://www.electronicdesign.com/technologies/embedded-revolution/article/21763399/use-the-pcs-uart-with-9bit-protocols">&#8220;single master, multiple slaves&#8221; or &#8220;single controller, multiple responders&#8221; setup</a>. With the most significant bit (MSB) indicating the the byte type (<a href="https://en.wikipedia.org/wiki/Multi-Drop_Bus_/_Internal_Communication_Protocol">multi-drop bus</a> or MDB) we get two address bytes and the rest as data bytes.</p>



<p>The device appears to be sending two sequences of bytes on pin <code>A</code> at 76ms intervals:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1412" height="590" src="https://kaspars.net/wp-content/uploads/2021/03/comfospot-50-master-slave-data-packets.png" alt="Data packets sent by the master/controller device at 76ms intervals." class="wp-image-7809" srcset="https://kaspars.net/wp-content/uploads/2021/03/comfospot-50-master-slave-data-packets.png 1412w, https://kaspars.net/wp-content/uploads/2021/03/comfospot-50-master-slave-data-packets-800x334.png 800w, https://kaspars.net/wp-content/uploads/2021/03/comfospot-50-master-slave-data-packets-1024x428.png 1024w" sizes="(max-width: 1412px) 100vw, 1412px" /><figcaption>Data packets sent by the master/controller device at 76ms intervals.</figcaption></figure>



<p>First packet:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1412" height="590" src="https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-0103.png" alt="Data sent to address 0x01 0x04 in hex notation." class="wp-image-7807" srcset="https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-0103.png 1412w, https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-0103-800x334.png 800w, https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-0103-1024x428.png 1024w" sizes="(max-width: 1412px) 100vw, 1412px" /><figcaption>Data packet sent to device address 0x01 0x03 in hex notation.</figcaption></figure>



<p>and the second packet:</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1412" height="590" src="https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-0104.png" alt="Data sent to address 0x01 0x04 in hex notation." class="wp-image-7808" srcset="https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-0104.png 1412w, https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-0104-800x334.png 800w, https://kaspars.net/wp-content/uploads/2021/03/zehnder-comfospot-50-0104-1024x428.png 1024w" sizes="(max-width: 1412px) 100vw, 1412px" /><figcaption>Data sent to address 0x01 0x04 in hex notation.</figcaption></figure>



<p>I&#8217;ve haven&#8217;t been able to figure out which devices these could be and what data is being sent to them.</p>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/zehnder-comfospot-protocol/feed</wfw:commentRss>
			<slash:comments>5</slash:comments>
		
		
			</item>
		<item>
		<title>Sonoff Si7021 Teardown</title>
		<link>https://kaspars.net/blog/sonoff-si7021</link>
					<comments>https://kaspars.net/blog/sonoff-si7021#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sat, 06 Mar 2021 08:20:58 +0000</pubDate>
				<category><![CDATA[Electronics]]></category>
		<category><![CDATA[Home Automation]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7754</guid>

					<description><![CDATA[Here are the photos of the Sonoff Si7021 temperature and humidity sensor which uses the Silicon Labs Si7021 sensor attached to the Silicon Labs EFM8BB10F2G-QFN20 microcontroller. The other side of the PCB is completely blank. The sensor is actually pretty large due to the size of the PCB (note the size of the 2.5mm jack). [&#8230;] <a href="https://kaspars.net/blog/sonoff-si7021" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>Here are the photos of the <a href="https://www.itead.cc/wiki/Sonoff_Sensor_Si7021">Sonoff Si7021 temperature and humidity sensor</a> which uses the <a href="https://www.silabs.com/sensors/humidity/si7006-13-20-21-34/device.si7021-a20-gm">Silicon Labs Si7021 sensor</a> attached to the <a href="https://www.silabs.com/mcu/8-bit/efm8-busy-bee/device.efm8bb10f2g-qfn20">Silicon Labs EFM8BB10F2G-QFN20 microcontroller</a>. The other side of the PCB is completely blank.</p>



<span id="more-7754"></span>



<figure class="wp-block-image alignwide size-large"><img loading="lazy" decoding="async" width="2560" height="2560" src="https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-teardown-pcb-1024x1024.jpeg?_t=1615018069" alt="Teardown of the Sonoff Si7021 temperature and humidity sensor" class="wp-image-7756" srcset="https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-teardown-pcb-1024x1024.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-teardown-pcb-800x800.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-teardown-pcb-150x150.jpeg 150w, https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-teardown-pcb-1536x1536.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-teardown-pcb-2048x2048.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption>PCB of the Sonoff Si7021 using the Silicon Labs si7021 temperature and humidity sensor and the EFM8BB10F2G microcontroller.</figcaption></figure>



<p>The sensor is actually pretty large due to the size of the PCB (note the size of the 2.5mm jack). Here it is compared to a simple thermometer with an LCD display:</p>



<figure class="wp-block-image alignwide size-large"><img loading="lazy" decoding="async" width="2560" height="1707" src="https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-compared-to-welleman-pmhygro-1024x683.jpeg?_t=1615018281" alt="Sonoff Si7021 temperature and humidity sensor next to Welleman PMHYGRO sensor" class="wp-image-7757" srcset="https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-compared-to-welleman-pmhygro-1024x683.jpeg 1024w, https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-compared-to-welleman-pmhygro-800x533.jpeg 800w, https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-compared-to-welleman-pmhygro-1536x1024.jpeg 1536w, https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-compared-to-welleman-pmhygro-2048x1366.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption>Sonoff Si7021 temperature and humidity sensor next to a Welleman PMHYGRO sensor for size comparison.</figcaption></figure>



<p>The I<sup>2</sup>C signal from the sensor is passed through the EFM8BB10F2G microcontroller and converted into a <a href="https://github.com/arendst/Tasmota/issues/735#issuecomment-348718383">1-Wire signal described here</a> which is similar to the <a href="https://www.hotmcu.com/capacitive-digital-temperature-humidity-sensoram2301-p-154.html">AM2301 (DHT21)</a> sensor output.</p>



<p>Here is the most comprehensive <a href="https://www.kandrsmith.org/RJS/Misc/Hygrometers/calib_dht22_dht11_sht71.html">comparison of various temperature and humidity sensors by Robert J. Smith</a>.</p>



<div class="wp-block-file"><a href="https://kaspars.net/wp-content/uploads/2021/03/Sonoff_Si7021_Sensor_Schematic.pdf">Sonoff Si7021 Sensor Schematic</a><a href="https://kaspars.net/wp-content/uploads/2021/03/Sonoff_Si7021_Sensor_Schematic.pdf" class="wp-block-file__button" download>Download</a></div>



<div class="wp-block-file"><a href="https://kaspars.net/wp-content/uploads/2021/03/AM2301_Manual.pdf">AM2301 sensor datasheet</a><a href="https://kaspars.net/wp-content/uploads/2021/03/AM2301_Manual.pdf" class="wp-block-file__button" download>Download</a></div>
<div class='yarpp yarpp-related yarpp-related-rss yarpp-template-list'>
<!-- YARPP List -->
<h3>Related posts:</h3><ol>
<li><a href="https://kaspars.net/blog/aranet4-teardown" rel="bookmark" title="Aranet4 Teardown">Aranet4 Teardown</a></li>
<li><a href="https://kaspars.net/blog/sensor-pilot-web-bluetooth" rel="bookmark" title="Sensor Pilot: A Progressive Web App (PWA) for Bluetooth Sensors">Sensor Pilot: A Progressive Web App (PWA) for Bluetooth Sensors</a></li>
<li><a href="https://kaspars.net/blog/passive-house-sensors" rel="bookmark" title="Sensors for Smart Passive House">Sensors for Smart Passive House</a></li>
</ol>
</div>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/sonoff-si7021/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2021/03/sonoff-si7021-sensor-teardown-pcb-150x150.jpeg" length="5759" type="image/jpeg" />	</item>
		<item>
		<title>Mikrotik CAPsMAN is Awesome</title>
		<link>https://kaspars.net/blog/mikrotik-capsman</link>
					<comments>https://kaspars.net/blog/mikrotik-capsman#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 27 Dec 2020 22:28:22 +0000</pubDate>
				<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[MikroTik]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7724</guid>

					<description><![CDATA[Mikrotik routers use CAPsMAN (Controlled Access Point Manager) to configure and synchronize a mesh of wireless access points or CAPs (Controlled Access Points). This is extremely useful for setting up multiple access points with the exact same WiFI name or SSID and security settings, and a dedicated guest network, for example. Sidenote: I wish there [&#8230;] <a href="https://kaspars.net/blog/mikrotik-capsman" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p><a href="https://mikrotik.com/products">Mikrotik routers</a> use <a href="https://wiki.mikrotik.com/wiki/Manual:CAPsMAN">CAPsMAN</a> (Controlled Access Point Manager) to configure and synchronize a mesh of wireless access points or CAPs (Controlled Access Points). This is extremely useful for setting up multiple access points with the exact same WiFI name or SSID and security settings, and a dedicated guest network, for example.</p>



<span id="more-7724"></span>



<p>Sidenote: I wish there was brief description under each RouterOS configuration panel that would describe the purpose of the particular section or just link to the relevant <a href="https://wiki.mikrotik.com/wiki/Manual:TOC">wiki page</a>. The amount of abbreviations used throughout the RouterOS management interface makes it really difficult for anyone new to the platform.</p>



<h2 class="wp-block-heading">How does CAPsMAN work?</h2>



<p>Behind the scenes CAPsMAN uses either <a href="https://en.wikipedia.org/wiki/Medium_access_control">MAC (Layer 2)</a> or <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol">UDP packets over IP (Layer 3)</a> to discover and configure the access points.</p>



<p>All of this communication can be secured and encrypted via Datagram Transport Layer Security (DTLS) which is very similar to Transport Layer Security (TLS) used on the web but for UDP packets. RouterOS takes care of generating the certificate authority (CA) certificate and the associated keys.</p>



<p>I wonder how similar it is to <a href="https://en.wikipedia.org/wiki/CAPWAP">CAPWAP</a>?</p>



<h2 class="wp-block-heading">Using CAPsMAN with a Local Access Point (CAP)</h2>



<p>CAPsMAN can also configure an access point or CAP running on the same device as CAPsMAN itself. However, it might require additional firewall rules to allow the communication between the CAP and the CAPs manager. </p>



<p>By default, RouterOS adds the following firewall rule to allow local CAPsMAN to communicate with the local CAP:</p>



<pre class="wp-block-code"><code>action=accept chain=input dst-address=127.0.0.1 comment="defconf: accept to local loopback (for CAPsMAN)"</code></pre>



<p>but all of the local CAPsMAN communication will be blocked by the following rule (also added by default) that prohibits all traffic coming to the router from outside the <code>LAN</code> interface list:</p>



<pre class="wp-block-code"><code>action=drop chain=input in-interface-list=!LAN comment="defconf: drop all not coming from LAN"</code></pre>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="903" height="534" src="https://kaspars.net/wp-content/uploads/2020/12/mikrotik-capsman-default-home-mesh-firewall-rules.png" alt="Default firewall rules for the Mikrotik Home Mesh quick-set or profile" class="wp-image-7732" srcset="https://kaspars.net/wp-content/uploads/2020/12/mikrotik-capsman-default-home-mesh-firewall-rules.png 903w, https://kaspars.net/wp-content/uploads/2020/12/mikrotik-capsman-default-home-mesh-firewall-rules-800x473.png 800w" sizes="(max-width: 903px) 100vw, 903px" /><figcaption>Default firewall rules for the Mikrotik Home Mesh quick-set or profile.</figcaption></figure>



<p>That&#8217;s because all of the CAPsMAN traffic looks like this to the router:</p>



<pre class="wp-block-code"><code>input: in:(unknown 1) out:(unknown 0), proto UDP, 192.168.88.1:42921-&gt;192.168.88.1:5247, len 52</code></pre>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="957" height="354" src="https://kaspars.net/wp-content/uploads/2020/12/routeros-capsman-firewall-blocking-local-cap.png" alt="" class="wp-image-7738" srcset="https://kaspars.net/wp-content/uploads/2020/12/routeros-capsman-firewall-blocking-local-cap.png 957w, https://kaspars.net/wp-content/uploads/2020/12/routeros-capsman-firewall-blocking-local-cap-800x296.png 800w" sizes="(max-width: 957px) 100vw, 957px" /><figcaption>RouterOS firewall blocking local CAP setup via CAPsMAN on the same device.</figcaption></figure>



<p>Notice how the <code>in</code> and <code>out</code> interfaces are shown as <code>unknown</code> in the logs because CAPsMAN uses the MAC layer instead of the IP layer for the communication which makes the traffic appear to be invalid. See <a href="https://forum.mikrotik.com/viewtopic.php?t=109377">this forum thread</a> for additional insight.</p>



<p><strong>There are two solutions to this:</strong></p>



<p>First, configure the local CAP to use <code>127.0.0.1</code> as the CAPsMAN address:</p>



<pre class="wp-block-code"><code>/interface wireless cap
set bridge=bridge caps-man-addresses=127.0.0.1</code></pre>



<p>which will make it use the IP layer for CAPsMAN communication and will therefore honour the local loopback firewall rule.</p>



<figure class="wp-block-image size-large"><img loading="lazy" decoding="async" width="702" height="501" src="https://kaspars.net/wp-content/uploads/2020/12/local-cap-capsman-interface-ip-address.png" alt="" class="wp-image-7735"/><figcaption>Specify the CAPsMAN address as 127.0.0.1 for the local CAP.</figcaption></figure>



<p>Alternatively, add a new firewall <code>input</code> rule (for everything going <em>to the router</em> not just passing through) to allow traffic from the <code>local</code> address type into the <code>local</code> address type of the router:</p>



<pre class="wp-block-code"><code>/ip firewall filter
add action=accept chain=input dst-address-type=local src-address-type=local comment="Accept local CAPsMAN config"</code></pre>



<p>and place it before anything that is blocking non-local traffic.</p>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="799" height="814" src="https://kaspars.net/wp-content/uploads/2020/12/mikrotik-capsman-firewall-address-type-input-rule.png" alt="New RouterOS firewall rule to allow all &quot;local&quot; address-type traffic on the &quot;input&quot; chain." class="wp-image-7736"/><figcaption>New RouterOS firewall rule to allow all &#8220;local&#8221; address-type traffic on the &#8220;input&#8221; chain.</figcaption></figure>



<h2 class="wp-block-heading">Useful Links</h2>



<p>Here are posts and forum threads I&#8217;ve found useful when learning about RouterOS CAPsMAN:</p>



<ul class="wp-block-list"><li><a href="https://jms1.net/mikrotik/Guest%20Wifi%20with%20Limited%20Bandwidth.md">Guest WiFi setup with bandwidth limits</a>.</li><li><a href="https://netflow.by/blog/wifi-setup/1987-nastrojka-gostevoj-seti-wi-fi-na-mikrotik">Guest WiFi firewall configuration and best practices</a> (in Russian). They have a lot of great <a href="https://netflow.by/blog/tweak-isp/mikrotik">Mikrotik related articles</a>.</li><li><a href="https://serveradmin.ru/nastroyka-capsman-v-mikrotik/">Generic CAPsMAN setup with focus on access-point roaming</a> (in Russian).</li></ul>
<div class='yarpp yarpp-related yarpp-related-rss yarpp-template-list'>
<!-- YARPP List -->
<h3>Related posts:</h3><ol>
<li><a href="https://kaspars.net/blog/wireguard-mikrotik-routeros" rel="bookmark" title="WireGuard on MikroTik RouterOS">WireGuard on MikroTik RouterOS</a></li>
<li><a href="https://kaspars.net/blog/wireguard-routing" rel="bookmark" title="WireGuard Routing and Port Forwarding">WireGuard Routing and Port Forwarding</a></li>
<li><a href="https://kaspars.net/blog/reolink-battery-camera-remote-protocol" rel="bookmark" title="Remote Access Protocol for Reolink Battery Powered Cameras">Remote Access Protocol for Reolink Battery Powered Cameras</a></li>
</ol>
</div>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/mikrotik-capsman/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2020/12/mikrotik-capsman-150x150.png" length="5247" type="image/png" />	</item>
		<item>
		<title>WireGuard Routing and Port Forwarding</title>
		<link>https://kaspars.net/blog/wireguard-routing</link>
					<comments>https://kaspars.net/blog/wireguard-routing#comments</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Sun, 16 Aug 2020 09:00:52 +0000</pubDate>
				<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Linux]]></category>
		<category><![CDATA[How to]]></category>
		<category><![CDATA[raspberrypi]]></category>
		<category><![CDATA[WireGuard]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7686</guid>

					<description><![CDATA[WireGuard provides unlimited possibilities for creating private and secure networks without having to expose devices to the public internet. In this example I wanted to access the Mikrotik router configuration panel from anywhere in the world similar to how Cloud Key and Cloud Access enables it for Ubiquity devices. Note that RouterOS already supports VPN [&#8230;] <a href="https://kaspars.net/blog/wireguard-routing" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p>WireGuard provides unlimited possibilities for creating private and secure networks without having to expose devices to the public internet. In this example I wanted to access the <a href="https://mikrotik.com/">Mikrotik</a> router configuration panel from anywhere in the world similar to how <a href="https://www.ui.com/unifi/unifi-cloud-key/">Cloud Key</a> and Cloud Access enables it for <a href="https://www.ui.com/">Ubiquity</a> devices. Note that RouterOS already supports VPN access but not through WireGuard.</p>



<span id="more-7686"></span>



<figure class="wp-block-image alignwide size-large"><img loading="lazy" decoding="async" width="2560" height="1707" src="https://kaspars.net/wp-content/uploads/2020/08/mikrotik-solar-powered-lte-router-1024x683.jpeg" alt="" class="wp-image-7697" srcset="https://kaspars.net/wp-content/uploads/2020/08/mikrotik-solar-powered-lte-router-1024x683.jpeg 1024w, https://kaspars.net/wp-content/uploads/2020/08/mikrotik-solar-powered-lte-router-800x533.jpeg 800w, https://kaspars.net/wp-content/uploads/2020/08/mikrotik-solar-powered-lte-router-1536x1024.jpeg 1536w, https://kaspars.net/wp-content/uploads/2020/08/mikrotik-solar-powered-lte-router-2048x1365.jpeg 2048w" sizes="(max-width: 2560px) 100vw, 2560px" /><figcaption>Solar powered Mikrotik wAP LTE router.</figcaption></figure>



<p>I built <a href="https://kaspars.net/blog/solar-raspberry-pi-camera" data-type="post" data-id="7205">a solar powered Raspberry Pi used as a security camera</a> which is connected wirelessly to a solar powered Mikrotik LTE router to access the internet through a mobile data connection. </p>



<p>The Raspberry Pi is <a href="https://kaspars.net/blog/wireguard-raspberry-pi" data-type="post" data-id="7597">also running WireGuard</a> so all we have to do is forward the incoming WireGuard traffic to a few ports on the Mikrotik router.</p>



<p>Here is how to configure the Raspberry Pi acting as a WireGuard peer to do the custom routing:</p>



<h2 class="wp-block-heading">1. Enable IP Forwarding</h2>



<p><strong>IP forwarding is disabled by default</strong> on Raspbian so it&#8217;s extremely important to enable it for any of the <code>iptables</code> rules to work.</p>



<p>Enable IP forwarding in the Linux kernel by uncommenting or adding (uncommenting) <code>net.ipv4.ip_forward = 1</code> to <code>/etc/sysctl.conf</code> to persist the setting between system restarts. Use <code>sysctl -w net.ipv4.ip_forward=1</code> to enable IP forwarding immediately without having to reboot.</p>



<h2 class="wp-block-heading">2. Configure Routing</h2>



<p>We&#8217;re routing a WireGuard peer on a network interface <code>wg0</code> and an IP range of <code>10.200.200.0/24</code> to the IP address <code>192.168.88.1</code> in the local network available through the <code>wlan0</code> interface.</p>



<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="3206" height="1924" src="https://kaspars.net/wp-content/uploads/2020/08/wireguard-peer-mikrotik-raspberrypi.png" alt="Mikrotik router on a WireGuard network" class="wp-image-7692" srcset="https://kaspars.net/wp-content/uploads/2020/08/wireguard-peer-mikrotik-raspberrypi.png 3206w, https://kaspars.net/wp-content/uploads/2020/08/wireguard-peer-mikrotik-raspberrypi-800x480.png 800w, https://kaspars.net/wp-content/uploads/2020/08/wireguard-peer-mikrotik-raspberrypi-1024x615.png 1024w, https://kaspars.net/wp-content/uploads/2020/08/wireguard-peer-mikrotik-raspberrypi-1536x922.png 1536w, https://kaspars.net/wp-content/uploads/2020/08/wireguard-peer-mikrotik-raspberrypi-2048x1229.png 2048w" sizes="(max-width: 3206px) 100vw, 3206px" /><figcaption>Mikrotik router connected to a WireGuard network through a Raspberry Pi. </figcaption></figure>



<p>First, make requests incoming on the WireGuard network interface <code>wg0</code> appear as originating from the Raspberry Pi itself to the devices on the local network:</p>



<pre class="wp-block-code"><code>sudo iptables -t nat -A POSTROUTING -o wlan0 -s 10.200.200.0/24 -j MASQUERADE</code></pre>



<p>Then forward ports:</p>



<ul class="wp-block-list"><li><code>80</code> for Mikrotik Webfig</li><li><code>5678</code> for Mikrotik Neighbor Discovery Protocol</li><li><code>8728</code> for RouterOS API</li><li><code>8291</code> for Mikrotik Winbox</li></ul>



<p>to the Mikrotik router at IP address <code>192.168.88.1</code>:</p>



<pre class="wp-block-code"><code>sudo iptables -t nat -A PREROUTING -i wg0 -p tcp --match multiport --destination-ports 80,5678,8728,8291 -j DNAT --to-destination 192.168.88.1</code></pre>



<p>or just a single port <code>80</code>:</p>



<pre class="wp-block-code"><code>sudo iptables -t nat -A PREROUTING -i wg0 -p tcp --destination-port 80 -j DNAT --to-destination 192.168.88.1</code></pre>



<p>This could be adjusted to forward all traffic to the Mikrotik router but then you would need a separate WireGuard peer configuration for accessing the actual Raspberry Pi through the WireGuard network.</p>



<p>Now you should be able to access the Mikrotik router from any device on the same WireGuard network, including the phone app.</p>



<h2 class="wp-block-heading">Persist the Routing Configuration</h2>



<p>Finally, you can persist these custom routes by configuring the WireGuard <code>PostUp</code> and <code>PostDown</code> directives in the <code>[Interface]</code> section of <code>wg0.conf</code>:</p>



<pre class="wp-block-code"><code>PostUp = iptables -t nat -A ...
PostDown = iptables -t nat -D ...</code></pre>



<p>Notice the <code>-D</code> flag which is used for removing the exact same entries.</p>



<h2 class="wp-block-heading">Debug Routing and Forwarding</h2>



<p>Add temporary rules to the <code>PREROUTING</code> and <code>POSTROUTING</code> tables to enable logging to <code>/var/log/kern.log</code>:</p>



<pre class="wp-block-code"><code>sudo iptables -t nat -A PREROUTING -j LOG
sudo iptables -t nat -A POSTROUTING -j LOG</code></pre>



<p>And now you can view the logs:</p>



<pre class="wp-block-code"><code>sudo tail -f /var/log/kern.log</code></pre>
<div class='yarpp yarpp-related yarpp-related-rss yarpp-template-list'>
<!-- YARPP List -->
<h3>Related posts:</h3><ol>
<li><a href="https://kaspars.net/blog/wireguard-mikrotik-routeros" rel="bookmark" title="WireGuard on MikroTik RouterOS">WireGuard on MikroTik RouterOS</a></li>
<li><a href="https://kaspars.net/blog/wireguard-managers" rel="bookmark" title="WireGuard Network Managers">WireGuard Network Managers</a></li>
<li><a href="https://kaspars.net/blog/wireguard-raspberry-pi" rel="bookmark" title="WireGuard on Raspberry Pi">WireGuard on Raspberry Pi</a></li>
</ol>
</div>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/wireguard-routing/feed</wfw:commentRss>
			<slash:comments>2</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2020/08/wireguard-routing-mikrotik-150x150.png" length="1864" type="image/png" />	</item>
		<item>
		<title>WireGuard Network Managers</title>
		<link>https://kaspars.net/blog/wireguard-managers</link>
					<comments>https://kaspars.net/blog/wireguard-managers#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Mon, 10 Aug 2020 07:55:06 +0000</pubDate>
				<category><![CDATA[Home Automation]]></category>
		<category><![CDATA[Linux]]></category>
		<category><![CDATA[raspberrypi]]></category>
		<category><![CDATA[WireGuard]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7669</guid>

					<description><![CDATA[WireGuard is amazing for securely accessing your devices even behind private networks and NATs. I wrote a guide for installing WireGuard on Raspberry Pi. Adding a new devices to your WireGuard network requires adding the public key of the new client to the list of known peers at the public endpoint used by all other [&#8230;] <a href="https://kaspars.net/blog/wireguard-managers" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<p><a href="https://www.wireguard.com/">WireGuard</a> is amazing for securely accessing your devices even behind private networks and NATs. I wrote <a href="https://kaspars.net/blog/wireguard-raspberry-pi">a guide for installing WireGuard on Raspberry Pi</a>.</p>



<p>Adding a new devices to your WireGuard network requires adding the  public key of the new client to the list of known peers at the public endpoint used by all other peers. The standard way is to SSH into the public peer and update its network configuration file to include the public key of the new peer. This can become pretty tedious as your network grows.</p>



<span id="more-7669"></span>



<p>Here is a list of various tools and applications that simplify this workflow of managing the WireGuard network:</p>



<h2 class="wp-block-heading">wg-gen-web</h2>



<p><a href="https://github.com/vx3r/wg-gen-web">wg-gen-web</a> is a web UI for generating and updating the WireGuard network config file for the public peer. It must be hosted on the same device as the public peer. It is a Go application that runs inside a Docker container.</p>



<h2 class="wp-block-heading">Subspace</h2>



<p><a href="https://github.com/subspacecloud/subspace">Subspace</a> is a web application written in Go for managing the network peers with support for single-sign-on. There is also <a href="https://github.com/subspacecommunity/subspace">a community fork</a> since the original application hasn&#8217;t been updated recently.</p>



<h2 class="wp-block-heading">wg-access-server</h2>



<p><a href="https://github.com/place1/wg-access-server/">wg-access-server</a> is a Go application for managing WireGuard peer configuration files. Supports several single-sign-on providers for the Web UI authentication.</p>



<h2 class="wp-block-heading">wg-ui</h2>



<p><a href="https://github.com/EmbarkStudios/wg-ui">wg-ui</a> is a Go application for generating WireGuard peer configuration files.</p>



<h2 class="wp-block-heading">Other Tools</h2>



<ul class="wp-block-list"><li><a href="https://github.com/naggie/dsnet">github.com/naggie/dsnet</a> with an <a href="https://callanbryant.co.uk/blog/how-to-set-up-a-wireguard-vpn-in-minutes-with-dsnet/">introductory blog post</a>.</li><li><a href="https://github.com/edomora97/wireguard-manager">github.com/edomora97/wireguard-manager</a></li></ul>
<div class='yarpp yarpp-related yarpp-related-rss yarpp-template-list'>
<!-- YARPP List -->
<h3>Related posts:</h3><ol>
<li><a href="https://kaspars.net/blog/wireguard-raspberry-pi" rel="bookmark" title="WireGuard on Raspberry Pi">WireGuard on Raspberry Pi</a></li>
<li><a href="https://kaspars.net/blog/wireguard-mikrotik-routeros" rel="bookmark" title="WireGuard on MikroTik RouterOS">WireGuard on MikroTik RouterOS</a></li>
<li><a href="https://kaspars.net/blog/wireguard-routing" rel="bookmark" title="WireGuard Routing and Port Forwarding">WireGuard Routing and Port Forwarding</a></li>
</ol>
</div>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/wireguard-managers/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>RSS Feeds for WordPress Plugin and Theme Support Forum Topics and Replies</title>
		<link>https://kaspars.net/blog/wp-org-support-forum-rss-replies</link>
					<comments>https://kaspars.net/blog/wp-org-support-forum-rss-replies#respond</comments>
		
		<dc:creator><![CDATA[Kaspars]]></dc:creator>
		<pubDate>Thu, 23 Jul 2020 18:48:53 +0000</pubDate>
				<category><![CDATA[WordPress]]></category>
		<category><![CDATA[Open Source]]></category>
		<category><![CDATA[PHP]]></category>
		<category><![CDATA[Plugin]]></category>
		<category><![CDATA[Theme]]></category>
		<category><![CDATA[Tool]]></category>
		<guid isPermaLink="false">https://kaspars.net/?p=7637</guid>

					<description><![CDATA[It is currently impossible to get notified of new WordPress.org support forum replies without subscribing to each individual topic via email. See this Meta Track ticket for details. So I created the Support Pilot plugin for WordPress that generates RSS feeds for support topics and replies for any plugin or theme on WordPress.org. It works [&#8230;] <a href="https://kaspars.net/blog/wp-org-support-forum-rss-replies" class="read-more excerpt-read-more">Read&#160;more&#160;&#8594;</a>]]></description>
										<content:encoded><![CDATA[
<figure class="wp-block-image alignwide size-full"><img loading="lazy" decoding="async" width="1059" height="779" src="https://kaspars.net/wp-content/uploads/2020/07/wordpress-support-forum-topic-replies-rss-feeds.png" alt="An RSS feed of WordPress.org plugin and theme support forum topic and replies." class="wp-image-7640" srcset="https://kaspars.net/wp-content/uploads/2020/07/wordpress-support-forum-topic-replies-rss-feeds.png 1059w, https://kaspars.net/wp-content/uploads/2020/07/wordpress-support-forum-topic-replies-rss-feeds-800x588.png 800w, https://kaspars.net/wp-content/uploads/2020/07/wordpress-support-forum-topic-replies-rss-feeds-1024x753.png 1024w" sizes="(max-width: 1059px) 100vw, 1059px" /><figcaption>A list of support topics and replies for WordPress.org plugins and themes in an RSS reader.</figcaption></figure>



<p>It is currently impossible to get notified of new WordPress.org support forum replies without subscribing to each individual topic via email. See <a href="https://meta.trac.wordpress.org/ticket/4867">this Meta Track ticket</a> for details.</p>



<p>So I created the <a href="https://github.com/kasparsd/support-pilot-plugin">Support Pilot plugin</a> for WordPress that generates RSS feeds for support topics <em>and</em> replies for any plugin or theme on WordPress.org.</p>



<p>It works by parsing and combining the RSS feed of the 30 latest support support topics and the RSS feeds for replies to each of those topics.</p>



<h2 class="wp-block-heading">How to Install </h2>



<p>The plugin must be added as <a href="https://packagist.org/packages/kasparsd/support-pilot-plugin">a Composer dependency</a> to your site:</p>



<pre class="wp-block-code"><code>composer require kasparsd/support-pilot-plugin</code></pre>



<p>or run <code>composer install</code> inside the plugin directory to install the necessary PHP dependencies.</p>



<h2 class="wp-block-heading">How to Use</h2>



<p>The plugin registers a new public feed endpoint <code>wporgreplies</code> which supports <code>plugin</code> and <code>theme</code> request parameters which must match the plugin or theme slug on WP.org:</p>



<pre class="wp-block-code"><code>https:&#47;&#47;example.com/feed/wporgreplies?plugin=PLUGINSLUG</code></pre>



<p>where <code>PLUGINSLUG</code> is the plugin slug on WP.org.</p>



<p>These feeds can be used to generate <a href="https://slack.com/intl/en-lv/help/articles/218688467-Add-RSS-feeds-to-Slack">Slack notifications</a> or any other automation that supports RSS feeds.</p>
<div class='yarpp yarpp-related yarpp-related-rss yarpp-template-list'>
<!-- YARPP List -->
<h3>Related posts:</h3><ol>
<li><a href="https://kaspars.net/blog/featured-images-as-enclosure-wordpress-rss-feed" rel="bookmark" title="Add Featured Images as Enclosures to Posts in WordPress RSS Feeds">Add Featured Images as Enclosures to Posts in WordPress RSS Feeds</a></li>
<li><a href="https://kaspars.net/blog/laravel-homestead-wordpress" rel="bookmark" title="Laravel Homestead for WordPress Theme and Plugin Development">Laravel Homestead for WordPress Theme and Plugin Development</a></li>
<li><a href="https://kaspars.net/blog/wordpress-environment-composer" rel="bookmark" title="WordPress Development Environment as a Composer Dependancy">WordPress Development Environment as a Composer Dependancy</a></li>
</ol>
</div>


<hr/>]]></content:encoded>
					
					<wfw:commentRss>https://kaspars.net/blog/wp-org-support-forum-rss-replies/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<enclosure url="https://kaspars.net/wp-content/uploads/2020/07/wordpress-support-forum-topic-replies-rss-feeds-150x150.png" length="6510" type="image/png" />	</item>
	</channel>
</rss>
